"use strict";
/**
 * @module kryo/readers/bson-value
 */
Object.defineProperty(exports, "__esModule", { value: true });
const incident_1 = require("incident");
const invalid_type_1 = require("../errors/invalid-type");
const json_1 = require("./json");
function isBinary(val) {
    return val._bsontype === "Binary";
}
class BsonValueReader {
    constructor(trust) {
        this.trustInput = trust;
    }
    readAny(input, visitor) {
        switch (typeof input) {
            case "boolean":
                return visitor.fromBoolean(input);
            case "string":
                return visitor.fromString(input);
            case "object":
                return input === null
                    ? visitor.fromNull()
                    : visitor.fromMap(new Map(Object.keys(input).map(k => [k, input[k]])), this, this);
            default:
                throw invalid_type_1.createInvalidTypeError("boolean | null | object | string", input);
        }
    }
    readBoolean(input, visitor) {
        if (typeof input !== "boolean") {
            throw invalid_type_1.createInvalidTypeError("boolean", input);
        }
        return visitor.fromBoolean(input);
    }
    readBytes(raw, visitor) {
        let input;
        if (isBinary(raw)) {
            // TODO: Fix BSON type definitions
            input = raw.value(true);
        }
        else {
            // TODO: typecheck
            input = raw;
        }
        return visitor.fromBytes(input);
    }
    readDate(raw, visitor) {
        if (!(raw instanceof Date)) {
            throw invalid_type_1.createInvalidTypeError("Date", raw);
        }
        return visitor.fromDate(new Date(raw.getTime()));
    }
    readDocument(raw, visitor) {
        if (typeof raw !== "object" || raw === null) {
            throw invalid_type_1.createInvalidTypeError("object", raw);
        }
        const input = new Map();
        for (const key in raw) {
            input.set(key, raw[key]);
        }
        return visitor.fromMap(input, this, this);
    }
    readFloat64(input, visitor) {
        const specialValues = new Map([["NaN", NaN], ["Infinity", Infinity], ["-Infinity", Infinity]]);
        const special = specialValues.get(input);
        if (special === undefined && typeof input !== "number") {
            throw new incident_1.Incident("InvalidInput", { input, expected: "float64" });
        }
        return visitor.fromFloat64(special !== undefined ? special : input);
    }
    readList(input, visitor) {
        if (!Array.isArray(input)) {
            throw invalid_type_1.createInvalidTypeError("array", input);
        }
        return visitor.fromList(input, this);
    }
    readMap(raw, visitor) {
        if (typeof raw !== "object" || raw === null) {
            throw invalid_type_1.createInvalidTypeError("object", raw);
        }
        const jsonReader = new json_1.JsonReader();
        const input = new Map();
        for (const rawKey in raw) {
            let key;
            try {
                key = JSON.parse(rawKey);
                // key = (/* keyType */ undefined as any).read(jsonReader, key);
            }
            catch (err) {
                throw new incident_1.Incident(err, "InvalidMapKey", { rawKey });
            }
            input.set(key, raw[rawKey]);
        }
        return visitor.fromMap(input, jsonReader, this);
    }
    readNull(input, visitor) {
        if (this.trustInput) {
            return visitor.fromNull();
        }
        if (input !== null) {
            throw invalid_type_1.createInvalidTypeError("null", input);
        }
        return visitor.fromNull();
    }
    readString(input, visitor) {
        if (typeof input !== "string") {
            throw invalid_type_1.createInvalidTypeError("string", input);
        }
        return visitor.fromString(input);
    }
}
exports.BsonValueReader = BsonValueReader;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9saWIvcmVhZGVycy9ic29uLXZhbHVlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQTs7R0FFRzs7QUFHSCx1Q0FBb0M7QUFFcEMseURBQWdFO0FBQ2hFLGlDQUFvQztBQUVwQyxTQUFTLFFBQVEsQ0FBQyxHQUFRO0lBQ3hCLE9BQU8sR0FBRyxDQUFDLFNBQVMsS0FBSyxRQUFRLENBQUM7QUFDcEMsQ0FBQztBQUVELE1BQWEsZUFBZTtJQUcxQixZQUFZLEtBQWU7UUFDekIsSUFBSSxDQUFDLFVBQVUsR0FBRyxLQUFLLENBQUM7SUFDMUIsQ0FBQztJQUVELE9BQU8sQ0FBSSxLQUFVLEVBQUUsT0FBdUI7UUFDNUMsUUFBUSxPQUFPLEtBQUssRUFBRTtZQUNwQixLQUFLLFNBQVM7Z0JBQ1osT0FBTyxPQUFPLENBQUMsV0FBVyxDQUFDLEtBQUssQ0FBQyxDQUFDO1lBQ3BDLEtBQUssUUFBUTtnQkFDWCxPQUFPLE9BQU8sQ0FBQyxVQUFVLENBQUMsS0FBSyxDQUFDLENBQUM7WUFDbkMsS0FBSyxRQUFRO2dCQUNYLE9BQU8sS0FBSyxLQUFLLElBQUk7b0JBQ25CLENBQUMsQ0FBQyxPQUFPLENBQUMsUUFBUSxFQUFFO29CQUNwQixDQUFDLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxJQUFJLEdBQUcsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxFQUFFLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBa0IsQ0FBQyxDQUFDLEVBQUUsSUFBSSxFQUFFLElBQUksQ0FBQyxDQUFDO1lBQ3hHO2dCQUNFLE1BQU0scUNBQXNCLENBQUMsa0NBQWtDLEVBQUUsS0FBSyxDQUFDLENBQUM7U0FDM0U7SUFDSCxDQUFDO0lBRUQsV0FBVyxDQUFJLEtBQVUsRUFBRSxPQUF1QjtRQUNoRCxJQUFJLE9BQU8sS0FBSyxLQUFLLFNBQVMsRUFBRTtZQUM5QixNQUFN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ZS5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQG1vZHVsZSBrcnlvL3JlYWRlcnMvYnNvbi12YWx1ZVxuICovXG5cbmltcG9ydCBic29uIGZyb20gXCJic29uXCI7XG5pbXBvcnQgeyBJbmNpZGVudCB9IGZyb20gXCJpbmNpZGVudFwiO1xuaW1wb3J0IHsgUmVhZGVyLCBSZWFkVmlzaXRvciB9IGZyb20gXCIuLi9jb3JlXCI7XG5pbXBvcnQgeyBjcmVhdGVJbnZhbGlkVHlwZUVycm9yIH0gZnJvbSBcIi4uL2Vycm9ycy9pbnZhbGlkLXR5cGVcIjtcbmltcG9ydCB7IEpzb25SZWFkZXIgfSBmcm9tIFwiLi9qc29uXCI7XG5cbmZ1bmN0aW9uIGlzQmluYXJ5KHZhbDogYW55KTogdmFsIGlzIGJzb24uQmluYXJ5IHtcbiAgcmV0dXJuIHZhbC5fYnNvbnR5cGUgPT09IFwiQmluYXJ5XCI7XG59XG5cbmV4cG9ydCBjbGFzcyBCc29uVmFsdWVSZWFkZXIgaW1wbGVtZW50cyBSZWFkZXI8YW55PiB7XG4gIHRydXN0SW5wdXQ/OiBib29sZWFuIHwgdW5kZWZpbmVkO1xuXG4gIGNvbnN0cnVjdG9yKHRydXN0PzogYm9vbGVhbikge1xuICAgIHRoaXMudHJ1c3RJbnB1dCA9IHRydXN0O1xuICB9XG5cbiAgcmVhZEFueTxSPihpbnB1dDogYW55LCB2aXNpdG9yOiBSZWFkVmlzaXRvcjxSPik6IFIge1xuICAgIHN3aXRjaCAodHlwZW9mIGlucHV0KSB7XG4gICAgICBjYXNlIFwiYm9vbGVhblwiOlxuICAgICAgICByZXR1cm4gdmlzaXRvci5mcm9tQm9vbGVhbihpbnB1dCk7XG4gICAgICBjYXNlIFwic3RyaW5nXCI6XG4gICAgICAgIHJldHVybiB2aXNpdG9yLmZyb21TdHJpbmcoaW5wdXQpO1xuICAgICAgY2FzZSBcIm9iamVjdFwiOlxuICAgICAgICByZXR1cm4gaW5wdXQgPT09IG51bGxcbiAgICAgICAgICA/IHZpc2l0b3IuZnJvbU51bGwoKVxuICAgICAgICAgIDogdmlzaXRvci5mcm9tTWFwKG5ldyBNYXAoT2JqZWN0LmtleXMoaW5wdXQpLm1hcChrID0+IFtrLCBpbnB1dFtrXV0gYXMgW3N0cmluZywgYW55XSkpLCB0aGlzLCB0aGlzKTtcbiAgICAgIGRlZmF1bHQ6XG4gICAgICAgIHRocm93IGNyZWF0ZUludmFsaWRUeXBlRXJyb3IoXCJib29sZWFuIHwgbnVsbCB8IG9iamVjdCB8IHN0cmluZ1wiLCBpbnB1dCk7XG4gICAgfVxuICB9XG5cbiAgcmVhZEJvb2xlYW48Uj4oaW5wdXQ6IGFueSwgdmlzaXRvcjogUmVhZFZpc2l0b3I8Uj4pOiBSIHtcbiAgICBpZiAodHlwZW9mIGlucHV0ICE9PSBcImJvb2xlYW5cIikge1xuICAgICAgdGhyb3cgY3JlYXRlSW52YWxpZFR5cGVFcnJvcihcImJvb2xlYW5cIiwgaW5wdXQpO1xuICAgIH1cbiAgICByZXR1cm4gdmlzaXRvci5mcm9tQm9vbGVhbihpbnB1dCk7XG4gIH1cblxuICByZWFkQnl0ZXM8Uj4ocmF3OiBhbnksIHZpc2l0b3I6IFJlYWRWaXNpdG9yPFI+KTogUiB7XG4gICAgbGV0IGlucHV0OiBVaW50OEFycmF5O1xuICAgIGlmIChpc0JpbmFyeShyYXcpKSB7XG4gICAgICAvLyBUT0RPOiBGaXggQlNPTiB0eXBlIGRlZmluaXRpb25zXG4gICAgICBpbnB1dCA9ICg8YW55PiByYXcgYXMge3ZhbHVlKGFzUmF3OiB0cnVlKTogQnVmZmVyfSkudmFsdWUodHJ1ZSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIC8vIFRPRE86IHR5cGVjaGVja1xuICAgICAgaW5wdXQgPSByYXc7XG4gICAgfVxuICAgIHJldHVybiB2aXNpdG9yLmZyb21CeXRlcyhpbnB1dCk7XG4gIH1cblxuICByZWFkRGF0ZTxSPihyYXc6IGFueSwgdmlzaXRvcjogUmVhZFZpc2l0b3I8Uj4pOiBSIHtcbiAgICBpZiAoIShyYXcgaW5zdGFuY2VvZiBEYXRlKSkge1xuICAgICAgdGhyb3cgY3JlYXRlSW52YWxpZFR5cGVFcnJvcihcIkRhdGVcIiwgcmF3KTtcbiAgICB9XG4gICAgcmV0dXJuIHZpc2l0b3IuZnJvbURhdGUobmV3IERhdGUocmF3LmdldFRpbWUoKSkpO1xuICB9XG5cbiAgcmVhZERvY3VtZW50PFI+KHJhdzogYW55LCB2aXNpdG9yOiBSZWFkVmlzaXRvcjxSPik6IFIge1xuICAgIGlmICh0eXBlb2YgcmF3ICE9PSBcIm9iamVjdFwiIHx8IHJhdyA9PT0gbnVsbCkge1xuICAgICAgdGhyb3cgY3JlYXRlSW52YWxpZFR5cGVFcnJvcihcIm9iamVjdFwiLCByYXcpO1xuICAgIH1cbiAgICBjb25zdCBpbnB1dDogTWFwPHN0cmluZywgYW55PiA9IG5ldyBNYXAoKTtcbiAgICBmb3IgKGNvbnN0IGtleSBpbiByYXcpIHtcbiAgICAgIGlucHV0LnNldChrZXksIHJhd1trZXldKTtcbiAgICB9XG4gICAgcmV0dXJuIHZpc2l0b3IuZnJvbU1hcChpbnB1dCwgdGhpcywgdGhpcyk7XG4gIH1cblxuICByZWFkRmxvYXQ2NDxSPihpbnB1dDogYW55LCB2aXNpdG9yOiBSZWFkVmlzaXRvcjxSPik6IFIge1xuICAgIGNvbnN0IHNwZWNpYWxWYWx1ZXM6IE1hcDxzdHJpbmcsIG51bWJlcj4gPSBuZXcgTWFwKFtbXCJOYU5cIiwgTmFOXSwgW1wiSW5maW5pdHlcIiwgSW5maW5pdHldLCBbXCItSW5maW5pdHlcIiwgSW5maW5pdHldXSk7XG4gICAgY29uc3Qgc3BlY2lhbDogbnVtYmVyIHwgdW5kZWZpbmVkID0gc3BlY2lhbFZhbHVlcy5nZXQoaW5wdXQpO1xuICAgIGlmIChzcGVjaWFsID09PSB1bmRlZmluZWQgJiYgdHlwZW9mIGlucHV0ICE9PSBcIm51bWJlclwiKSB7XG4gICAgICB0aHJvdyBuZXcgSW5jaWRlbnQoXCJJbnZhbGlkSW5wdXRcIiwge2lucHV0LCBleHBlY3RlZDogXCJmbG9hdDY0XCJ9KTtcbiAgICB9XG4gICAgcmV0dXJuIHZpc2l0b3IuZnJvbUZsb2F0NjQoc3BlY2lhbCAhPT0gdW5kZWZpbmVkID8gc3BlY2lhbCA6IGlucHV0KTtcbiAgfVxuXG4gIHJlYWRMaXN0PFI+KGlucHV0OiBhbnksIHZpc2l0b3I6IFJlYWRWaXNpdG9yPFI+KTogUiB7XG4gICAgaWYgKCFBcnJheS5pc0FycmF5KGlucHV0KSkge1xuICAgICAgdGhyb3cgY3JlYXRlSW52YWxpZFR5cGVFcnJvcihcImFycmF5XCIsIGlucHV0KTtcbiAgICB9XG4gICAgcmV0dXJuIHZpc2l0b3IuZnJvbUxpc3QoaW5wdXQsIHRoaXMpO1xuICB9XG5cbiAgcmVhZE1hcDxSPihyYXc6IGFueSwgdmlzaXRvcjogUmVhZFZpc2l0b3I8Uj4pOiBSIHtcbiAgICBpZiAodHlwZW9mIHJhdyAhPT0gXCJvYmplY3RcIiB8fCByYXcgPT09IG51bGwpIHtcbiAgICAgIHRocm93IGNyZWF0ZUludmFsaWRUeXBlRXJyb3IoXCJvYmplY3RcIiwgcmF3KTtcbiAgICB9XG4gICAgY29uc3QganNvblJlYWRlcjogSnNvblJlYWRlciA9IG5ldyBKc29uUmVhZGVyKCk7XG5cbiAgICBjb25zdCBpbnB1dDogTWFwPGFueSwgYW55PiA9IG5ldyBNYXAoKTtcbiAgICBmb3IgKGNvbnN0IHJhd0tleSBpbiByYXcpIHtcbiAgICAgIGxldCBrZXk6IGFueTtcbiAgICAgIHRyeSB7XG4gICAgICAgIGtleSA9IEpTT04ucGFyc2UocmF3S2V5KTtcbiAgICAgICAgLy8ga2V5ID0gKC8qIGtleVR5cGUgKi8gdW5kZWZpbmVkIGFzIGFueSkucmVhZChqc29uUmVhZGVyLCBrZXkpO1xuICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgIHRocm93IG5ldyBJbmNpZGVudChlcnIsIFwiSW52YWxpZE1hcEtleVwiLCB7cmF3S2V5fSk7XG4gICAgICB9XG4gICAgICBpbnB1dC5zZXQoa2V5LCByYXdbcmF3S2V5XSk7XG4gICAgfVxuICAgIHJldHVybiB2aXNpdG9yLmZyb21NYXAoaW5wdXQsIGpzb25SZWFkZXIsIHRoaXMpO1xuICB9XG5cbiAgcmVhZE51bGw8Uj4oaW5wdXQ6IGFueSwgdmlzaXRvcjogUmVhZFZpc2l0b3I8Uj4pOiBSIHtcbiAgICBpZiAodGhpcy50cnVzdElucHV0KSB7XG4gICAgICByZXR1cm4gdmlzaXRvci5mcm9tTnVsbCgpO1xuICAgIH1cbiAgICBpZiAoaW5wdXQgIT09IG51bGwpIHtcbiAgICAgIHRocm93IGNyZWF0ZUludmFsaWRUeXBlRXJyb3IoXCJudWxsXCIsIGlucHV0KTtcbiAgICB9XG4gICAgcmV0dXJuIHZpc2l0b3IuZnJvbU51bGwoKTtcbiAgfVxuXG4gIHJlYWRTdHJpbmc8Uj4oaW5wdXQ6IGFueSwgdmlzaXRvcjogUmVhZFZpc2l0b3I8Uj4pOiBSIHtcbiAgICBpZiAodHlwZW9mIGlucHV0ICE9PSBcInN0cmluZ1wiKSB7XG4gICAgICB0aHJvdyBjcmVhdGVJbnZhbGlkVHlwZUVycm9yKFwic3RyaW5nXCIsIGlucHV0KTtcbiAgICB9XG4gICAgcmV0dXJuIHZpc2l0b3IuZnJvbVN0cmluZyhpbnB1dCk7XG4gIH1cbn1cbiJdLCJzb3VyY2VSb290IjoiLi4vLi4ifQ==
