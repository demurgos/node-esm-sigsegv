/**
 * @module kryo/readers/qs-value
 */
import { Incident } from "incident";
import { createInvalidTypeError } from "../errors/invalid-type";
import { JsonReader } from "./json";
export class QsValueReader {
    constructor(trust) {
        this.trustInput = trust;
    }
    readAny(input, visitor) {
        switch (typeof input) {
            case "boolean":
                return visitor.fromBoolean(input);
            case "string":
                return visitor.fromString(input);
            case "object":
                return input === null
                    ? visitor.fromNull()
                    : visitor.fromMap(new Map(Object.keys(input).map(k => [k, input[k]])), this, this);
            default:
                throw createInvalidTypeError("boolean | null | object | string", input);
        }
    }
    readBoolean(input, visitor) {
        if (input !== "true" && input !== "false") {
            throw createInvalidTypeError("\"true\" | \"false\"", input);
        }
        return visitor.fromBoolean(input === "true");
    }
    readBytes(input, visitor) {
        if (typeof input !== "string") {
            throw createInvalidTypeError("string", input);
        }
        else if (!/^(?:[0-9a-f]{2})*$/.test(input)) {
            throw createInvalidTypeError("lowerCaseHexEvenLengthString", input);
        }
        let result;
        const len = input.length / 2;
        result = new Uint8Array(len);
        for (let i = 0; i < len; i++) {
            result[i] = parseInt(input.substr(2 * i, 2), 16);
        }
        return visitor.fromBytes(result);
    }
    readDate(input, visitor) {
        if (this.trustInput) {
            return visitor.fromDate(new Date(input));
        }
        if (typeof input === "string") {
            return visitor.fromDate(new Date(input));
        }
        throw createInvalidTypeError("string | number", input);
    }
    readDocument(raw, visitor) {
        if (typeof raw !== "object" || raw === null) {
            throw createInvalidTypeError("object", raw);
        }
        const input = new Map();
        for (const key in raw) {
            input.set(key, raw[key]);
        }
        return visitor.fromMap(input, this, this);
    }
    readFloat64(input, visitor) {
        const specialValues = new Map([
            ["NaN", NaN],
            ["Infinity", Infinity],
            ["+Infinity", Infinity],
            ["-Infinity", -Infinity],
        ]);
        const special = specialValues.get(input);
        if (special === undefined && typeof input !== "string") {
            throw new Incident("InvalidInput", { input, expected: "float64" });
        }
        return visitor.fromFloat64(special !== undefined ? special : parseFloat(input));
    }
    readList(input, visitor) {
        if (input === undefined) {
            return visitor.fromList([], this);
        }
        if (!Array.isArray(input)) {
            throw createInvalidTypeError("array | undefined", input);
        }
        return visitor.fromList(input, this);
    }
    readMap(raw, visitor) {
        if (typeof raw !== "object" || raw === null) {
            throw createInvalidTypeError("object", raw);
        }
        const jsonReader = new JsonReader();
        const input = new Map();
        for (const rawKey in raw) {
            let key;
            try {
                key = JSON.parse(rawKey);
                // key = (/* keyType */ undefined as any).read(jsonReader, key);
            }
            catch (err) {
                throw new Incident(err, "InvalidMapKey", rawKey);
            }
            input.set(key, raw[rawKey]);
        }
        return visitor.fromMap(input, jsonReader, this);
    }
    readNull(input, visitor) {
        if (this.trustInput) {
            return visitor.fromNull();
        }
        if (input !== "") {
            throw createInvalidTypeError("\"\"", input);
        }
        return visitor.fromNull();
    }
    readString(input, visitor) {
        if (typeof input !== "string") {
            throw createInvalidTypeError("string", input);
        }
        return visitor.fromString(input);
    }
}

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9saWIvcmVhZGVycy9xcy12YWx1ZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTs7R0FFRztBQUVILE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxVQUFVLENBQUM7QUFFcEMsT0FBTyxFQUFFLHNCQUFzQixFQUFFLE1BQU0sd0JBQXdCLENBQUM7QUFDaEUsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLFFBQVEsQ0FBQztBQUVwQyxNQUFNLE9BQU8sYUFBYTtJQUd4QixZQUFZLEtBQWU7UUFDekIsSUFBSSxDQUFDLFVBQVUsR0FBRyxLQUFLLENBQUM7SUFDMUIsQ0FBQztJQUVELE9BQU8sQ0FBSSxLQUFVLEVBQUUsT0FBdUI7UUFDNUMsUUFBUSxPQUFPLEtBQUssRUFBRTtZQUNwQixLQUFLLFNBQVM7Z0JBQ1osT0FBTyxPQUFPLENBQUMsV0FBVyxDQUFDLEtBQUssQ0FBQyxDQUFDO1lBQ3BDLEtBQUssUUFBUTtnQkFDWCxPQUFPLE9BQU8sQ0FBQyxVQUFVLENBQUMsS0FBSyxDQUFDLENBQUM7WUFDbkMsS0FBSyxRQUFRO2dCQUNYLE9BQU8sS0FBSyxLQUFLLElBQUk7b0JBQ25CLENBQUMsQ0FBQyxPQUFPLENBQUMsUUFBUSxFQUFFO29CQUNwQixDQUFDLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxJQUFJLEdBQUcsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxFQUFFLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBa0IsQ0FBQyxDQUFDLEVBQUUsSUFBSSxFQUFFLElBQUksQ0FBQyxDQUFDO1lBQ3hHO2dCQUNFLE1BQU0sc0JBQXNCLENBQUMsa0NBQWtDLEVBQUUsS0FBSyxDQUFDLENBQUM7U0FDM0U7SUFDSCxDQUFDO0lBRUQsV0FBVyxDQUFJLEtBQVUsRUFBRSxPQUF1QjtRQUNoRCxJQUFJLEtBQUssS0FBSyxNQUFNLElBQUksS0FBSyxLQUFLLE9BQU8sRUFBRTtZQUN6QyxNQUFNLHNCQUFzQixDQUFDLHNCQUFzQixFQUFFLEtBQUssQ0FBQyxDQUFDO1NBQzdEO1FBQ0QsT0FBTyxPQUFPLENBQUMsV0FBVyxDQUFDLEtBQUssS0FBSyxNQUFNLENBQUMsQ0FBQztJQUMvQyxDQUFDO0lBRUQsU0FBUyxDQUFJLEtBQVUsRUFBRSxPQUF1QjtRQUM5QyxJQUFJLE9BQU8sS0FBSyxLQUFLLFFBQVEsRUFBRTtZQUM3QixNQUFNLHNCQUFzQixDQUFDLFFBQVEsRUFBRSxLQUFLLENBQUMsQ0FBQztTQUMvQzthQUFNLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLEVBQUU7WUFDNUMsTUFBTSxzQkFBc0IsQ0FBQyw4QkFBOEIsRUFBRSxLQUFLLENBQUMsQ0FBQztTQUNyRTtRQUNELElBQUksTUFBa0IsQ0FBQztRQUN2QixNQUFNLEdBQUcsR0FBVyxLQUFLLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQztRQUNyQyxNQUFNLEdBQUcsSUFBSSxVQUFVLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDN0IsS0FBSyxJQUFJLENBQUMsR0FBVyxDQUFDLEVBQUUsQ0FBQyxHQUFHLEdBQUcsRUFBRSxDQUFDLEVBQUUsRUFBRTtZQUNwQyxNQUFNLENBQUMsQ0FBQyxDQUFDLEdBQUcsUUFBUSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQztTQUNsRDtRQUNELE9BQU8sT0FBTyxDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUMsQ0FBQztJQUNuQyxDQUFDO0lBRUQsUUFBUSxDQUFJLEtBQVUsRUFBRSxPQUF1QjtRQUM3QyxJQUFJLElBQUksQ0FBQyxVQUFVLEVBQUU7WUFDbkIsT0FBTyxPQUFPLENBQUMsUUFBUSxDQUFDLElBQUksSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUM7U0FDMUM7UUFFRCxJQUFJLE9BQU8sS0FBSyxLQUFLLFFBQVEsRUFBRTtZQUM3QixPQUFPLE9BQU8sQ0FBQyxRQUFRLENBQUMsSUFBSSxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQztTQUMxQztRQUVELE1BQU0sc0JBQXNCLENBQUMsaUJBQWlCLEVBQUUsS0FBSyxDQUFDLENBQUM7SUFDekQsQ0FBQztJQUVELFlBQVksQ0FBSSxHQUFRLEVBQUUsT0FBdUI7UUFDL0MsSUFBSSxPQUFPLEdBQUcsS0FBSyxRQUFRLElBQUksR0FBRyxLQUFLLElBQUksRUFBRTtZQUMzQyxNQUFNLHNCQUFzQixDQUFDLFFBQVEsRUFBRSxHQUFHLENBQUMsQ0FBQztTQUM3QztRQUNELE1BQU0sS0FBSyxHQUFxQixJQUFJLEdBQUcsRUFBRSxDQUFDO1FBQzFDLEtBQUssTUFBTSxHQUFHLElBQUksR0FBRyxFQUFFO1lBQ3JCLEtBQUssQ0FBQyxHQUFHLENBQUMsR0FBRyxFQUFFLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO1NBQzFCO1FBQ0QsT0FBTyxPQUFPLENBQUMsT0FBTyxDQUFDLEtBQUssRUFBRSxJQUFJLEVBQUUsSUFBSSxDQUFDLENBQUM7SUFDNUMsQ0FBQztJQUVELFdBQVcsQ0FBSSxLQUFVLEVBQUUsT0FBdUI7UUFDaEQsTUFBTSxhQUFhLEdBQXdCLElBQUksR0FBRyxDQUFDO1lBQ2pELENBQUMsS0FBSyxFQUFFLEdBQUcsQ0FBQztZQUNaLENBQUMsVUFBVSxFQUFFLFFBQVEsQ0FBQztZQUN0QixDQUFDLFdBQVcsRUFBRSxRQUFRLENBQUM7WUFDdkIsQ0FBQyxXQUFXLEVBQUUsQ0FBQyxRQUFRLENBQUM7U0FDekIsQ0FBQyxDQUFDO1FBQ0gsTUFBTSxPQUFPLEdBQXVCLGFBQWEsQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDN0QsSUFBSSxPQUFPLEtBQUssU0FBUyxJQUFJLE9BQU8sS0FBSyxLQUFLLFFBQVEsRUFBRTtZQUN0RCxNQUFNLElBQUksUUFBUSxDQUFDLGNBQWMsRUFBRSxFQUFDLEtBQUssRUFBRSxRQUFRLEVBQUUsU0FBUyxFQUFDLENBQUMsQ0FBQztTQUNsRTtRQUNELE9BQU8sT0FBTyxDQUFDLFdBQVcsQ0FBQyxPQUFPLEtBQUssU0FBUyxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLFVBQVUsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDO0lBQ2xGLENBQUM7SUFFRCxRQUFRLENBQUksS0FBVSxFQUFFLE9BQXVCO1FBQzdDLElBQUksS0FBSyxLQUFLLFNBQVMsRUFBRTtZQUN2QixPQUFPLE9BQU8sQ0FBQyxRQUFRLENBQUMsRUFBRSxFQUFFLElBQUksQ0FBQyxDQUFDO1NBQ25DO1FBQ0QsSUFBSSxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLEVBQUU7WUFDekIsTUFBTSxzQkFBc0IsQ0FBQyxtQkFBbUIsRUFBRSxLQUFLLENBQUMsQ0FBQztTQUMxRDtRQUNELE9BQU8sT0FBTyxDQUFDLFFBQVEsQ0FBQyxLQUFLLEVBQUUsSUFBSSxDQUFDLENBQUM7SUFDdkMsQ0FBQztJQUVELE9BQU8sQ0FBSSxHQUFRLEVBQUUsT0FBdUI7UUFDMUMsSUFBSSxPQUFPLEdBQUcsS0FBSyxRQUFRLElBQUksR0FBRyxLQUFLLElBQUksRUFBRTtZQUMzQyxNQUFNLHNCQUFzQixDQUFDLFFBQVEsRUFBRSxHQUFHLENBQUMsQ0FBQztTQUM3QztRQUNELE1BQU0sVUFBVSxHQUFlLElBQUksVUFBVSxFQUFFLENBQUM7UUFFaEQsTUFBTSxLQUFLLEdBQWtCLElBQUksR0FBRyxFQUFFLENBQUM7UUFDdkMsS0FBSyxNQUFNLE1BQU0sSUFBSSxHQUFHLEVBQUU7WUFDeEIsSUFBSSxHQUFRLENBQUM7WUFDYixJQUFJO2dCQUNGLEdBQUcsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxDQUFDO2dCQUN6QixnRUFBZ0U7YUFDakU7WUFBQyxPQUFPLEdBQUcsRUFBRTtnQkFDWixNQUFNLElBQUksUUFBUSxDQUFDLEdBQUcsRUFBRSxlQUFlLEVBQUUsTUFBTSxDQUFDLENBQUM7YUFDbEQ7WUFDRCxLQUFLLENBQUMsR0FBRyxDQUFDLEdBQUcsRUFBRSxHQUFHLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQztTQUM3QjtRQUNELE9BQU8sT0FBTyxDQUFDLE9BQU8sQ0FBQyxLQUFLLEVBQUUsVUFBVSxFQUFFLElBQUksQ0FBQyxDQUFDO0lBQ2xELENBQUM7SUFFRCxRQUFRLENBQUksS0FBVSxFQUFFLE9BQXVCO1FBQzdDLElBQUksSUFBSSxDQUFDLFVBQVUsRUFBRTtZQUNuQixPQUFPLE9BQU8sQ0FBQyxRQUFRLEVBQUUsQ0FBQztTQUMzQjtRQUNELElBQUksS0FBSyxLQUFLLEVBQUUsRUFBRTtZQUNoQixNQUFNLHNCQUFzQixDQUFDLE1BQU0sRUFBRSxLQUFLLENBQUMsQ0FBQztTQUM3QztRQUNELE9BQU8sT0FBTyxDQUFDLFFBQVEsRUFBRSxDQUFDO0lBQzVCLENBQUM7SUFFRCxVQUFVLENBQUksS0FBVSxFQUFFLE9BQXVCO1FBQy9DLElBQUksT0FBTyxLQUFLLEtBQUssUUFBUSxFQUFFO1lBQzdCLE1BQU0sc0JBQXNCLENBQUMsUUFBUSxFQUFFLEtBQUssQ0FBQyxDQUFDO1NBQy9DO1FBQ0QsT0FBTyxPQUFPLENBQUMsVUFBVSxDQUFDLEtBQUssQ0FBQyxDQUFDO0lBQ25DLENBQUM7Q0FDRiIsImZpbGUiOiJsaWIvcmVhZGVycy9xcy12YWx1ZS5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQG1vZHVsZSBrcnlvL3JlYWRlcnMvcXMtdmFsdWVcbiAqL1xuXG5pbXBvcnQgeyBJbmNpZGVudCB9IGZyb20gXCJpbmNpZGVudFwiO1xuaW1wb3J0IHsgUmVhZGVyLCBSZWFkVmlzaXRvciB9IGZyb20gXCIuLi9jb3JlXCI7XG5pbXBvcnQgeyBjcmVhdGVJbnZhbGlkVHlwZUVycm9yIH0gZnJvbSBcIi4uL2Vycm9ycy9pbnZhbGlkLXR5cGVcIjtcbmltcG9ydCB7IEpzb25SZWFkZXIgfSBmcm9tIFwiLi9qc29uXCI7XG5cbmV4cG9ydCBjbGFzcyBRc1ZhbHVlUmVhZGVyIGltcGxlbWVudHMgUmVhZGVyPGFueT4ge1xuICB0cnVzdElucHV0PzogYm9vbGVhbiB8IHVuZGVmaW5lZDtcblxuICBjb25zdHJ1Y3Rvcih0cnVzdD86IGJvb2xlYW4pIHtcbiAgICB0aGlzLnRydXN0SW5wdXQgPSB0cnVzdDtcbiAgfVxuXG4gIHJlYWRBbnk8Uj4oaW5wdXQ6IGFueSwgdmlzaXRvcjogUmVhZFZpc2l0b3I8Uj4pOiBSIHtcbiAgICBzd2l0Y2ggKHR5cGVvZiBpbnB1dCkge1xuICAgICAgY2FzZSBcImJvb2xlYW5cIjpcbiAgICAgICAgcmV0dXJuIHZpc2l0b3IuZnJvbUJvb2xlYW4oaW5wdXQpO1xuICAgICAgY2FzZSBcInN0cmluZ1wiOlxuICAgICAgICByZXR1cm4gdmlzaXRvci5mcm9tU3RyaW5nKGlucHV0KTtcbiAgICAgIGNhc2UgXCJvYmplY3RcIjpcbiAgICAgICAgcmV0dXJuIGlucHV0ID09PSBudWxsXG4gICAgICAgICAgPyB2aXNpdG9yLmZyb21OdWxsKClcbiAgICAgICAgICA6IHZpc2l0b3IuZnJvbU1hcChuZXcgTWFwKE9iamVjdC5rZXlzKGlucHV0KS5tYXAoayA9PiBbaywgaW5wdXRba11dIGFzIFtzdHJpbmcsIGFueV0pKSwgdGhpcywgdGhpcyk7XG4gICAgICBkZWZhdWx0OlxuICAgICAgICB0aHJvdyBjcmVhdGVJbnZhbGlkVHlwZUVycm9yKFwiYm9vbGVhbiB8IG51bGwgfCBvYmplY3QgfCBzdHJpbmdcIiwgaW5wdXQpO1xuICAgIH1cbiAgfVxuXG4gIHJlYWRCb29sZWFuPFI+KGlucHV0OiBhbnksIHZpc2l0b3I6IFJlYWRWaXNpdG9yPFI+KTogUiB7XG4gICAgaWYgKGlucHV0ICE9PSBcInRydWVcIiAmJiBpbnB1dCAhPT0gXCJmYWxzZVwiKSB7XG4gICAgICB0aHJvdyBjcmVhdGVJbnZhbGlkVHlwZUVycm9yKFwiXFxcInRydWVcXFwiIHwgXFxcImZhbHNlXFxcIlwiLCBpbnB1dCk7XG4gICAgfVxuICAgIHJldHVybiB2aXNpdG9yLmZyb21Cb29sZWFuKGlucHV0ID09PSBcInRydWVcIik7XG4gIH1cblxuICByZWFkQnl0ZXM8Uj4oaW5wdXQ6IGFueSwgdmlzaXRvcjogUmVhZFZpc2l0b3I8Uj4pOiBSIHtcbiAgICBpZiAodHlwZW9mIGlucHV0ICE9PSBcInN0cmluZ1wiKSB7XG4gICAgICB0aHJvdyBjcmVhdGVJbnZhbGlkVHlwZUVycm9yKFwic3RyaW5nXCIsIGlucHV0KTtcbiAgICB9IGVsc2UgaWYgKCEvXig/OlswLTlhLWZdezJ9KSokLy50ZXN0KGlucHV0KSkge1xuICAgICAgdGhyb3cgY3JlYXRlSW52YWxpZFR5cGVFcnJvcihcImxvd2VyQ2FzZUhleEV2ZW5MZW5ndGhTdHJpbmdcIiwgaW5wdXQpO1xuICAgIH1cbiAgICBsZXQgcmVzdWx0OiBVaW50OEFycmF5O1xuICAgIGNvbnN0IGxlbjogbnVtYmVyID0gaW5wdXQubGVuZ3RoIC8gMjtcbiAgICByZXN1bHQgPSBuZXcgVWludDhBcnJheShsZW4pO1xuICAgIGZvciAobGV0IGk6IG51bWJlciA9IDA7IGkgPCBsZW47IGkrKykge1xuICAgICAgcmVzdWx0W2ldID0gcGFyc2VJbnQoaW5wdXQuc3Vic3RyKDIgKiBpLCAyKSwgMTYpO1xuICAgIH1cbiAgICByZXR1cm4gdmlzaXRvci5mcm9tQnl0ZXMocmVzdWx0KTtcbiAgfVxuXG4gIHJlYWREYXRlPFI+KGlucHV0OiBhbnksIHZpc2l0b3I6IFJlYWRWaXNpdG9yPFI+KTogUiB7XG4gICAgaWYgKHRoaXMudHJ1c3RJbnB1dCkge1xuICAgICAgcmV0dXJuIHZpc2l0b3IuZnJvbURhdGUobmV3IERhdGUoaW5wdXQpKTtcbiAgICB9XG5cbiAgICBpZiAodHlwZW9mIGlucHV0ID09PSBcInN0cmluZ1wiKSB7XG4gICAgICByZXR1cm4gdmlzaXRvci5mcm9tRGF0ZShuZXcgRGF0ZShpbnB1dCkpO1xuICAgIH1cblxuICAgIHRocm93IGNyZWF0ZUludmFsaWRUeXBlRXJyb3IoXCJzdHJpbmcgfCBudW1iZXJcIiwgaW5wdXQpO1xuICB9XG5cbiAgcmVhZERvY3VtZW50PFI+KHJhdzogYW55LCB2aXNpdG9yOiBSZWFkVmlzaXRvcjxSPik6IFIge1xuICAgIGlmICh0eXBlb2YgcmF3ICE9PSBcIm9iamVjdFwiIHx8IHJhdyA9PT0gbnVsbCkge1xuICAgICAgdGhyb3cgY3JlYXRlSW52YWxpZFR5cGVFcnJvcihcIm9iamVjdFwiLCByYXcpO1xuICAgIH1cbiAgICBjb25zdCBpbnB1dDogTWFwPHN0cmluZywgYW55PiA9IG5ldyBNYXAoKTtcbiAgICBmb3IgKGNvbnN0IGtleSBpbiByYXcpIHtcbiAgICAgIGlucHV0LnNldChrZXksIHJhd1trZXldKTtcbiAgICB9XG4gICAgcmV0dXJuIHZpc2l0b3IuZnJvbU1hcChpbnB1dCwgdGhpcywgdGhpcyk7XG4gIH1cblxuICByZWFkRmxvYXQ2NDxSPihpbnB1dDogYW55LCB2aXNpdG9yOiBSZWFkVmlzaXRvcjxSPik6IFIge1xuICAgIGNvbnN0IHNwZWNpYWxWYWx1ZXM6IE1hcDxzdHJpbmcsIG51bWJlcj4gPSBuZXcgTWFwKFtcbiAgICAgIFtcIk5hTlwiLCBOYU5dLFxuICAgICAgW1wiSW5maW5pdHlcIiwgSW5maW5pdHldLFxuICAgICAgW1wiK0luZmluaXR5XCIsIEluZmluaXR5XSxcbiAgICAgIFtcIi1JbmZpbml0eVwiLCAtSW5maW5pdHldLFxuICAgIF0pO1xuICAgIGNvbnN0IHNwZWNpYWw6IG51bWJlciB8IHVuZGVmaW5lZCA9IHNwZWNpYWxWYWx1ZXMuZ2V0KGlucHV0KTtcbiAgICBpZiAoc3BlY2lhbCA9PT0gdW5kZWZpbmVkICYmIHR5cGVvZiBpbnB1dCAhPT0gXCJzdHJpbmdcIikge1xuICAgICAgdGhyb3cgbmV3IEluY2lkZW50KFwiSW52YWxpZElucHV0XCIsIHtpbnB1dCwgZXhwZWN0ZWQ6IFwiZmxvYXQ2NFwifSk7XG4gICAgfVxuICAgIHJldHVybiB2aXNpdG9yLmZyb21GbG9hdDY0KHNwZWNpYWwgIT09IHVuZGVmaW5lZCA/IHNwZWNpYWwgOiBwYXJzZUZsb2F0KGlucHV0KSk7XG4gIH1cblxuICByZWFkTGlzdDxSPihpbnB1dDogYW55LCB2aXNpdG9yOiBSZWFkVmlzaXRvcjxSPik6IFIge1xuICAgIGlmIChpbnB1dCA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICByZXR1cm4gdmlzaXRvci5mcm9tTGlzdChbXSwgdGhpcyk7XG4gICAgfVxuICAgIGlmICghQXJyYXkuaXNBcnJheShpbnB1dCkpIHtcbiAgICAgIHRocm93IGNyZWF0ZUludmFsaWRUeXBlRXJyb3IoXCJhcnJheSB8IHVuZGVmaW5lZFwiLCBpbnB1dCk7XG4gICAgfVxuICAgIHJldHVybiB2aXNpdG9yLmZyb21MaXN0KGlucHV0LCB0aGlzKTtcbiAgfVxuXG4gIHJlYWRNYXA8Uj4ocmF3OiBhbnksIHZpc2l0b3I6IFJlYWRWaXNpdG9yPFI+KTogUiB7XG4gICAgaWYgKHR5cGVvZiByYXcgIT09IFwib2JqZWN0XCIgfHwgcmF3ID09PSBudWxsKSB7XG4gICAgICB0aHJvdyBjcmVhdGVJbnZhbGlkVHlwZUVycm9yKFwib2JqZWN0XCIsIHJhdyk7XG4gICAgfVxuICAgIGNvbnN0IGpzb25SZWFkZXI6IEpzb25SZWFkZXIgPSBuZXcgSnNvblJlYWRlcigpO1xuXG4gICAgY29uc3QgaW5wdXQ6IE1hcDxhbnksIGFueT4gPSBuZXcgTWFwKCk7XG4gICAgZm9yIChjb25zdCByYXdLZXkgaW4gcmF3KSB7XG4gICAgICBsZXQga2V5OiBhbnk7XG4gICAgICB0cnkge1xuICAgICAgICBrZXkgPSBKU09OLnBhcnNlKHJhd0tleSk7XG4gICAgICAgIC8vIGtleSA9ICgvKiBrZXlUeXBlICovIHVuZGVmaW5lZCBhcyBhbnkpLnJlYWQoanNvblJlYWRlciwga2V5KTtcbiAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICB0aHJvdyBuZXcgSW5jaWRlbnQoZXJyLCBcIkludmFsaWRNYXBLZXlcIiwgcmF3S2V5KTtcbiAgICAgIH1cbiAgICAgIGlucHV0LnNldChrZXksIHJhd1tyYXdLZXldKTtcbiAgICB9XG4gICAgcmV0dXJuIHZpc2l0b3IuZnJvbU1hcChpbnB1dCwganNvblJlYWRlciwgdGhpcyk7XG4gIH1cblxuICByZWFkTnVsbDxSPihpbnB1dDogYW55LCB2aXNpdG9yOiBSZWFkVmlzaXRvcjxSPik6IFIge1xuICAgIGlmICh0aGlzLnRydXN0SW5wdXQpIHtcbiAgICAgIHJldHVybiB2aXNpdG9yLmZyb21OdWxsKCk7XG4gICAgfVxuICAgIGlmIChpbnB1dCAhPT0gXCJcIikge1xuICAgICAgdGhyb3cgY3JlYXRlSW52YWxpZFR5cGVFcnJvcihcIlxcXCJcXFwiXCIsIGlucHV0KTtcbiAgICB9XG4gICAgcmV0dXJuIHZpc2l0b3IuZnJvbU51bGwoKTtcbiAgfVxuXG4gIHJlYWRTdHJpbmc8Uj4oaW5wdXQ6IGFueSwgdmlzaXRvcjogUmVhZFZpc2l0b3I8Uj4pOiBSIHtcbiAgICBpZiAodHlwZW9mIGlucHV0ICE9PSBcInN0cmluZ1wiKSB7XG4gICAgICB0aHJvdyBjcmVhdGVJbnZhbGlkVHlwZUVycm9yKFwic3RyaW5nXCIsIGlucHV0KTtcbiAgICB9XG4gICAgcmV0dXJuIHZpc2l0b3IuZnJvbVN0cmluZyhpbnB1dCk7XG4gIH1cbn1cbiJdLCJzb3VyY2VSb290IjoiLi4vLi4ifQ==
