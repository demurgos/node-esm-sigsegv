/**
 * @module kryo/readers/bson-value
 */
import { Incident } from "incident";
import { createInvalidTypeError } from "../errors/invalid-type";
import { JsonReader } from "./json";
function isBinary(val) {
    return val._bsontype === "Binary";
}
export class BsonValueReader {
    constructor(trust) {
        this.trustInput = trust;
    }
    readAny(input, visitor) {
        switch (typeof input) {
            case "boolean":
                return visitor.fromBoolean(input);
            case "string":
                return visitor.fromString(input);
            case "object":
                return input === null
                    ? visitor.fromNull()
                    : visitor.fromMap(new Map(Object.keys(input).map(k => [k, input[k]])), this, this);
            default:
                throw createInvalidTypeError("boolean | null | object | string", input);
        }
    }
    readBoolean(input, visitor) {
        if (typeof input !== "boolean") {
            throw createInvalidTypeError("boolean", input);
        }
        return visitor.fromBoolean(input);
    }
    readBytes(raw, visitor) {
        let input;
        if (isBinary(raw)) {
            // TODO: Fix BSON type definitions
            input = raw.value(true);
        }
        else {
            // TODO: typecheck
            input = raw;
        }
        return visitor.fromBytes(input);
    }
    readDate(raw, visitor) {
        if (!(raw instanceof Date)) {
            throw createInvalidTypeError("Date", raw);
        }
        return visitor.fromDate(new Date(raw.getTime()));
    }
    readDocument(raw, visitor) {
        if (typeof raw !== "object" || raw === null) {
            throw createInvalidTypeError("object", raw);
        }
        const input = new Map();
        for (const key in raw) {
            input.set(key, raw[key]);
        }
        return visitor.fromMap(input, this, this);
    }
    readFloat64(input, visitor) {
        const specialValues = new Map([["NaN", NaN], ["Infinity", Infinity], ["-Infinity", Infinity]]);
        const special = specialValues.get(input);
        if (special === undefined && typeof input !== "number") {
            throw new Incident("InvalidInput", { input, expected: "float64" });
        }
        return visitor.fromFloat64(special !== undefined ? special : input);
    }
    readList(input, visitor) {
        if (!Array.isArray(input)) {
            throw createInvalidTypeError("array", input);
        }
        return visitor.fromList(input, this);
    }
    readMap(raw, visitor) {
        if (typeof raw !== "object" || raw === null) {
            throw createInvalidTypeError("object", raw);
        }
        const jsonReader = new JsonReader();
        const input = new Map();
        for (const rawKey in raw) {
            let key;
            try {
                key = JSON.parse(rawKey);
                // key = (/* keyType */ undefined as any).read(jsonReader, key);
            }
            catch (err) {
                throw new Incident(err, "InvalidMapKey", { rawKey });
            }
            input.set(key, raw[rawKey]);
        }
        return visitor.fromMap(input, jsonReader, this);
    }
    readNull(input, visitor) {
        if (this.trustInput) {
            return visitor.fromNull();
        }
        if (input !== null) {
            throw createInvalidTypeError("null", input);
        }
        return visitor.fromNull();
    }
    readString(input, visitor) {
        if (typeof input !== "string") {
            throw createInvalidTypeError("string", input);
        }
        return visitor.fromString(input);
    }
}

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9saWIvcmVhZGVycy9ic29uLXZhbHVlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBOztHQUVHO0FBR0gsT0FBTyxFQUFFLFFBQVEsRUFBRSxNQUFNLFVBQVUsQ0FBQztBQUVwQyxPQUFPLEVBQUUsc0JBQXNCLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQztBQUNoRSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sUUFBUSxDQUFDO0FBRXBDLFNBQVMsUUFBUSxDQUFDLEdBQVE7SUFDeEIsT0FBTyxHQUFHLENBQUMsU0FBUyxLQUFLLFFBQVEsQ0FBQztBQUNwQyxDQUFDO0FBRUQsTUFBTSxPQUFPLGVBQWU7SUFHMUIsWUFBWSxLQUFlO1FBQ3pCLElBQUksQ0FBQyxVQUFVLEdBQUcsS0FBSyxDQUFDO0lBQzFCLENBQUM7SUFFRCxPQUFPLENBQUksS0FBVSxFQUFFLE9BQXVCO1FBQzVDLFFBQVEsT0FBTyxLQUFLLEVBQUU7WUFDcEIsS0FBSyxTQUFTO2dCQUNaLE9BQU8sT0FBTyxDQUFDLFdBQVcsQ0FBQyxLQUFLLENBQUMsQ0FBQztZQUNwQyxLQUFLLFFBQVE7Z0JBQ1gsT0FBTyxPQUFPLENBQUMsVUFBVSxDQUFDLEtBQUssQ0FBQyxDQUFDO1lBQ25DLEtBQUssUUFBUTtnQkFDWCxPQUFPLEtBQUssS0FBSyxJQUFJO29CQUNuQixDQUFDLENBQUMsT0FBTyxDQUFDLFFBQVEsRUFBRTtvQkFDcEIsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsSUFBSSxHQUFHLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsRUFBRSxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQWtCLENBQUMsQ0FBQyxFQUFFLElBQUksRUFBRSxJQUFJLENBQUMsQ0FBQztZQUN4RztnQkFDRSxNQUFNLHNCQUFzQixDQUFDLGtDQUFrQyxFQUFFLEtBQUssQ0FBQyxDQUFDO1NBQzNFO0lBQ0gsQ0FBQztJQUVELFdBQVcsQ0FBSSxLQUFVLEVBQUUsT0FBdUI7UUFDaEQsSUFBSSxPQUFPLEtBQUssS0FBSyxTQUFTLEVBQUU7WUFDOUIsTUFBTSxzQkFBc0IsQ0FBQyxTQUFTLEVBQUUsS0FBSyxDQUFDLENBQUM7U0FDaEQ7UUFDRCxPQUFPLE9BQU8sQ0FBQyxXQUFXLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDcEMsQ0FBQztJQUVELFNBQVMsQ0FBSSxHQUFRLEVBQUUsT0FBdUI7UUFDNUMsSUFBSSxLQUFpQixDQUFDO1FBQ3RCLElBQUksUUFBUSxDQUFDLEdBQUcsQ0FBQyxFQUFFO1lBQ2pCLGtDQUFrQztZQUNsQyxLQUFLLEdBQVUsR0FBb0MsQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUM7U0FDakU7YUFBTTtZQUNMLGtCQUFrQjtZQUNsQixLQUFLLEdBQUcsR0FBRyxDQUFDO1NBQ2I7UUFDRCxPQUFPLE9BQU8sQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDbEMsQ0FBQztJQUVELFFBQVEsQ0FBSSxHQUFRLEVBQUUsT0FBdUI7UUFDM0MsSUFBSSxDQUFDLENBQUMsR0FBRyxZQUFZLElBQUksQ0FBQyxFQUFFO1lBQzFCLE1BQU0sc0JBQXNCLENBQUMsTUFBTSxFQUFFLEdBQUcsQ0FBQyxDQUFDO1NBQzNDO1FBQ0QsT0FBTyxPQUFPLENBQUMsUUFBUSxDQUFDLElBQUksSUFBSSxDQUFDLEdBQUcsQ0FBQyxPQUFPLEVBQUUsQ0FBQyxDQUFDLENBQUM7SUFDbkQsQ0FBQztJQUVELFlBQVksQ0FBSSxHQUFRLEVBQUUsT0FBdUI7UUFDL0MsSUFBSSxPQUFPLEdBQUcsS0FBSyxRQUFRLElBQUksR0FBRyxLQUFLLElBQUksRUFBRTtZQUMzQyxNQUFNLHNCQUFzQixDQUFDLFFBQVEsRUFBRSxHQUFHLENBQUMsQ0FBQztTQUM3QztRQUNELE1BQU0sS0FBSyxHQUFxQixJQUFJLEdBQUcsRUFBRSxDQUFDO1FBQzFDLEtBQUssTUFBTSxHQUFHLElBQUksR0FBRyxFQUFFO1lBQ3JCLEtBQUssQ0FBQyxHQUFHLENBQUMsR0FBRyxFQUFFLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO1NBQzFCO1FBQ0QsT0FBTyxPQUFPLENBQUMsT0FBTyxDQUFDLEtBQUssRUFBRSxJQUFJLEVBQUUsSUFBSSxDQUFDLENBQUM7SUFDNUMsQ0FBQztJQUVELFdBQVcsQ0FBSSxLQUFVLEVBQUUsT0FBdUI7UUFDaEQsTUFBTSxhQUFhLEdBQXdCLElBQUksR0FBRyxDQUFDLENBQUMsQ0FBQyxLQUFLLEVBQUUsR0FBRyxDQUFDLEVBQUUsQ0FBQyxVQUFVLEVBQUUsUUFBUSxDQUFDLEVBQUUsQ0FBQyxXQUFXLEVBQUUsUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ3BILE1BQU0sT0FBTyxHQUF1QixhQUFhLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQzdELElBQUksT0FBTyxLQUFLLFNBQVMsSUFBSSxPQUFPLEtBQUssS0FBSyxRQUFRLEVBQUU7WUFDdEQsTUFBTSxJQUFJLFFBQVEsQ0FBQyxjQUFjLEVBQUUsRUFBQyxLQUFLLEVBQUUsUUFBUSxFQUFFLFNBQVMsRUFBQyxDQUFDLENBQUM7U0FDbEU7UUFDRCxPQUFPLE9BQU8sQ0FBQyxXQUFXLENBQUMsT0FBTyxLQUFLLFNBQVMsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUN0RSxDQUFDO0lBRUQsUUFBUSxDQUFJLEtBQVUsRUFBRSxPQUF1QjtRQUM3QyxJQUFJLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsRUFBRTtZQUN6QixNQUFNLHNCQUFzQixDQUFDLE9BQU8sRUFBRSxLQUFLLENBQUMsQ0FBQztTQUM5QztRQUNELE9BQU8sT0FBTyxDQUFDLFFBQVEsQ0FBQyxLQUFLLEVBQUUsSUFBSSxDQUFDLENBQUM7SUFDdkMsQ0FBQztJQUVELE9BQU8sQ0FBSSxHQUFRLEVBQUUsT0FBdUI7UUFDMUMsSUFBSSxPQUFPLEdBQUcsS0FBSyxRQUFRLElBQUksR0FBRyxLQUFLLElBQUksRUFBRTtZQUMzQyxNQUFNLHNCQUFzQixDQUFDLFFBQVEsRUFBRSxHQUFHLENBQUMsQ0FBQztTQUM3QztRQUNELE1BQU0sVUFBVSxHQUFlLElBQUksVUFBVSxFQUFFLENBQUM7UUFFaEQsTUFBTSxLQUFLLEdBQWtCLElBQUksR0FBRyxFQUFFLENBQUM7UUFDdkMsS0FBSyxNQUFNLE1BQU0sSUFBSSxHQUFHLEVBQUU7WUFDeEIsSUFBSSxHQUFRLENBQUM7WUFDYixJQUFJO2dCQUNGLEdBQUcsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxDQUFDO2dCQUN6QixnRUFBZ0U7YUFDakU7WUFBQyxPQUFPLEdBQUcsRUFBRTtnQkFDWixNQUFNLElBQUksUUFBUSxDQUFDLEdBQUcsRUFBRSxlQUFlLEVBQUUsRUFBQyxNQUFNLEVBQUMsQ0FBQyxDQUFDO2FBQ3BEO1lBQ0QsS0FBSyxDQUFDLEdBQUcsQ0FBQyxHQUFHLEVBQUUsR0FBRyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUM7U0FDN0I7UUFDRCxPQUFPLE9BQU8sQ0FBQyxPQUFPLENBQUMsS0FBSyxFQUFFLFVBQVUsRUFBRSxJQUFJLENBQUMsQ0FBQztJQUNsRCxDQUFDO0lBRUQsUUFBUSxDQUFJLEtBQVUsRUFBRSxPQUF1QjtRQUM3QyxJQUFJLElBQUksQ0FBQyxVQUFVLEVBQUU7WUFDbkIsT0FBTyxPQUFPLENBQUMsUUFBUSxFQUFFLENBQUM7U0FDM0I7UUFDRCxJQUFJLEtBQUssS0FBSyxJQUFJLEVBQUU7WUFDbEIsTUFBTSxzQkFBc0IsQ0FBQyxNQUFNLEVBQUUsS0FBSyxDQUFDLENBQUM7U0FDN0M7UUFDRCxPQUFPLE9BQU8sQ0FBQyxRQUFRLEVBQUUsQ0FBQztJQUM1QixDQUFDO0lBRUQsVUFBVSxDQUFJLEtBQVUsRUFBRSxPQUF1QjtRQUMvQyxJQUFJLE9BQU8sS0FBSyxLQUFLLFFBQVEsRUFBRTtZQUM3QixNQUFNLHNCQUFzQixDQUFDLFFBQVEsRUFBRSxLQUFLLENBQUMsQ0FBQztTQUMvQztRQUNELE9BQU8sT0FBTyxDQUFDLFVBQVUsQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUNuQyxDQUFDO0NBQ0YiLCJmaWxlIjoibGliL3JlYWRlcnMvYnNvbi12YWx1ZS5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQG1vZHVsZSBrcnlvL3JlYWRlcnMvYnNvbi12YWx1ZVxuICovXG5cbmltcG9ydCBic29uIGZyb20gXCJic29uXCI7XG5pbXBvcnQgeyBJbmNpZGVudCB9IGZyb20gXCJpbmNpZGVudFwiO1xuaW1wb3J0IHsgUmVhZGVyLCBSZWFkVmlzaXRvciB9IGZyb20gXCIuLi9jb3JlXCI7XG5pbXBvcnQgeyBjcmVhdGVJbnZhbGlkVHlwZUVycm9yIH0gZnJvbSBcIi4uL2Vycm9ycy9pbnZhbGlkLXR5cGVcIjtcbmltcG9ydCB7IEpzb25SZWFkZXIgfSBmcm9tIFwiLi9qc29uXCI7XG5cbmZ1bmN0aW9uIGlzQmluYXJ5KHZhbDogYW55KTogdmFsIGlzIGJzb24uQmluYXJ5IHtcbiAgcmV0dXJuIHZhbC5fYnNvbnR5cGUgPT09IFwiQmluYXJ5XCI7XG59XG5cbmV4cG9ydCBjbGFzcyBCc29uVmFsdWVSZWFkZXIgaW1wbGVtZW50cyBSZWFkZXI8YW55PiB7XG4gIHRydXN0SW5wdXQ/OiBib29sZWFuIHwgdW5kZWZpbmVkO1xuXG4gIGNvbnN0cnVjdG9yKHRydXN0PzogYm9vbGVhbikge1xuICAgIHRoaXMudHJ1c3RJbnB1dCA9IHRydXN0O1xuICB9XG5cbiAgcmVhZEFueTxSPihpbnB1dDogYW55LCB2aXNpdG9yOiBSZWFkVmlzaXRvcjxSPik6IFIge1xuICAgIHN3aXRjaCAodHlwZW9mIGlucHV0KSB7XG4gICAgICBjYXNlIFwiYm9vbGVhblwiOlxuICAgICAgICByZXR1cm4gdmlzaXRvci5mcm9tQm9vbGVhbihpbnB1dCk7XG4gICAgICBjYXNlIFwic3RyaW5nXCI6XG4gICAgICAgIHJldHVybiB2aXNpdG9yLmZyb21TdHJpbmcoaW5wdXQpO1xuICAgICAgY2FzZSBcIm9iamVjdFwiOlxuICAgICAgICByZXR1cm4gaW5wdXQgPT09IG51bGxcbiAgICAgICAgICA/IHZpc2l0b3IuZnJvbU51bGwoKVxuICAgICAgICAgIDogdmlzaXRvci5mcm9tTWFwKG5ldyBNYXAoT2JqZWN0LmtleXMoaW5wdXQpLm1hcChrID0+IFtrLCBpbnB1dFtrXV0gYXMgW3N0cmluZywgYW55XSkpLCB0aGlzLCB0aGlzKTtcbiAgICAgIGRlZmF1bHQ6XG4gICAgICAgIHRocm93IGNyZWF0ZUludmFsaWRUeXBlRXJyb3IoXCJib29sZWFuIHwgbnVsbCB8IG9iamVjdCB8IHN0cmluZ1wiLCBpbnB1dCk7XG4gICAgfVxuICB9XG5cbiAgcmVhZEJvb2xlYW48Uj4oaW5wdXQ6IGFueSwgdmlzaXRvcjogUmVhZFZpc2l0b3I8Uj4pOiBSIHtcbiAgICBpZiAodHlwZW9mIGlucHV0ICE9PSBcImJvb2xlYW5cIikge1xuICAgICAgdGhyb3cgY3JlYXRlSW52YWxpZFR5cGVFcnJvcihcImJvb2xlYW5cIiwgaW5wdXQpO1xuICAgIH1cbiAgICByZXR1cm4gdmlzaXRvci5mcm9tQm9vbGVhbihpbnB1dCk7XG4gIH1cblxuICByZWFkQnl0ZXM8Uj4ocmF3OiBhbnksIHZpc2l0b3I6IFJlYWRWaXNpdG9yPFI+KTogUiB7XG4gICAgbGV0IGlucHV0OiBVaW50OEFycmF5O1xuICAgIGlmIChpc0JpbmFyeShyYXcpKSB7XG4gICAgICAvLyBUT0RPOiBGaXggQlNPTiB0eXBlIGRlZmluaXRpb25zXG4gICAgICBpbnB1dCA9ICg8YW55PiByYXcgYXMge3ZhbHVlKGFzUmF3OiB0cnVlKTogQnVmZmVyfSkudmFsdWUodHJ1ZSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIC8vIFRPRE86IHR5cGVjaGVja1xuICAgICAgaW5wdXQgPSByYXc7XG4gICAgfVxuICAgIHJldHVybiB2aXNpdG9yLmZyb21CeXRlcyhpbnB1dCk7XG4gIH1cblxuICByZWFkRGF0ZTxSPihyYXc6IGFueSwgdmlzaXRvcjogUmVhZFZpc2l0b3I8Uj4pOiBSIHtcbiAgICBpZiAoIShyYXcgaW5zdGFuY2VvZiBEYXRlKSkge1xuICAgICAgdGhyb3cgY3JlYXRlSW52YWxpZFR5cGVFcnJvcihcIkRhdGVcIiwgcmF3KTtcbiAgICB9XG4gICAgcmV0dXJuIHZpc2l0b3IuZnJvbURhdGUobmV3IERhdGUocmF3LmdldFRpbWUoKSkpO1xuICB9XG5cbiAgcmVhZERvY3VtZW50PFI+KHJhdzogYW55LCB2aXNpdG9yOiBSZWFkVmlzaXRvcjxSPik6IFIge1xuICAgIGlmICh0eXBlb2YgcmF3ICE9PSBcIm9iamVjdFwiIHx8IHJhdyA9PT0gbnVsbCkge1xuICAgICAgdGhyb3cgY3JlYXRlSW52YWxpZFR5cGVFcnJvcihcIm9iamVjdFwiLCByYXcpO1xuICAgIH1cbiAgICBjb25zdCBpbnB1dDogTWFwPHN0cmluZywgYW55PiA9IG5ldyBNYXAoKTtcbiAgICBmb3IgKGNvbnN0IGtleSBpbiByYXcpIHtcbiAgICAgIGlucHV0LnNldChrZXksIHJhd1trZXldKTtcbiAgICB9XG4gICAgcmV0dXJuIHZpc2l0b3IuZnJvbU1hcChpbnB1dCwgdGhpcywgdGhpcyk7XG4gIH1cblxuICByZWFkRmxvYXQ2NDxSPihpbnB1dDogYW55LCB2aXNpdG9yOiBSZWFkVmlzaXRvcjxSPik6IFIge1xuICAgIGNvbnN0IHNwZWNpYWxWYWx1ZXM6IE1hcDxzdHJpbmcsIG51bWJlcj4gPSBuZXcgTWFwKFtbXCJOYU5cIiwgTmFOXSwgW1wiSW5maW5pdHlcIiwgSW5maW5pdHldLCBbXCItSW5maW5pdHlcIiwgSW5maW5pdHldXSk7XG4gICAgY29uc3Qgc3BlY2lhbDogbnVtYmVyIHwgdW5kZWZpbmVkID0gc3BlY2lhbFZhbHVlcy5nZXQoaW5wdXQpO1xuICAgIGlmIChzcGVjaWFsID09PSB1bmRlZmluZWQgJiYgdHlwZW9mIGlucHV0ICE9PSBcIm51bWJlclwiKSB7XG4gICAgICB0aHJvdyBuZXcgSW5jaWRlbnQoXCJJbnZhbGlkSW5wdXRcIiwge2lucHV0LCBleHBlY3RlZDogXCJmbG9hdDY0XCJ9KTtcbiAgICB9XG4gICAgcmV0dXJuIHZpc2l0b3IuZnJvbUZsb2F0NjQoc3BlY2lhbCAhPT0gdW5kZWZpbmVkID8gc3BlY2lhbCA6IGlucHV0KTtcbiAgfVxuXG4gIHJlYWRMaXN0PFI+KGlucHV0OiBhbnksIHZpc2l0b3I6IFJlYWRWaXNpdG9yPFI+KTogUiB7XG4gICAgaWYgKCFBcnJheS5pc0FycmF5KGlucHV0KSkge1xuICAgICAgdGhyb3cgY3JlYXRlSW52YWxpZFR5cGVFcnJvcihcImFycmF5XCIsIGlucHV0KTtcbiAgICB9XG4gICAgcmV0dXJuIHZpc2l0b3IuZnJvbUxpc3QoaW5wdXQsIHRoaXMpO1xuICB9XG5cbiAgcmVhZE1hcDxSPihyYXc6IGFueSwgdmlzaXRvcjogUmVhZFZpc2l0b3I8Uj4pOiBSIHtcbiAgICBpZiAodHlwZW9mIHJhdyAhPT0gXCJvYmplY3RcIiB8fCByYXcgPT09IG51bGwpIHtcbiAgICAgIHRocm93IGNyZWF0ZUludmFsaWRUeXBlRXJyb3IoXCJvYmplY3RcIiwgcmF3KTtcbiAgICB9XG4gICAgY29uc3QganNvblJlYWRlcjogSnNvblJlYWRlciA9IG5ldyBKc29uUmVhZGVyKCk7XG5cbiAgICBjb25zdCBpbnB1dDogTWFwPGFueSwgYW55PiA9IG5ldyBNYXAoKTtcbiAgICBmb3IgKGNvbnN0IHJhd0tleSBpbiByYXcpIHtcbiAgICAgIGxldCBrZXk6IGFueTtcbiAgICAgIHRyeSB7XG4gICAgICAgIGtleSA9IEpTT04ucGFyc2UocmF3S2V5KTtcbiAgICAgICAgLy8ga2V5ID0gKC8qIGtleVR5cGUgKi8gdW5kZWZpbmVkIGFzIGFueSkucmVhZChqc29uUmVhZGVyLCBrZXkpO1xuICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgIHRocm93IG5ldyBJbmNpZGVudChlcnIsIFwiSW52YWxpZE1hcEtleVwiLCB7cmF3S2V5fSk7XG4gICAgICB9XG4gICAgICBpbnB1dC5zZXQoa2V5LCByYXdbcmF3S2V5XSk7XG4gICAgfVxuICAgIHJldHVybiB2aXNpdG9yLmZyb21NYXAoaW5wdXQsIGpzb25SZWFkZXIsIHRoaXMpO1xuICB9XG5cbiAgcmVhZE51bGw8Uj4oaW5wdXQ6IGFueSwgdmlzaXRvcjogUmVhZFZpc2l0b3I8Uj4pOiBSIHtcbiAgICBpZiAodGhpcy50cnVzdElucHV0KSB7XG4gICAgICByZXR1cm4gdmlzaXRvci5mcm9tTnVsbCgpO1xuICAgIH1cbiAgICBpZiAoaW5wdXQgIT09IG51bGwpIHtcbiAgICAgIHRocm93IGNyZWF0ZUludmFsaWRUeXBlRXJyb3IoXCJudWxsXCIsIGlucHV0KTtcbiAgICB9XG4gICAgcmV0dXJuIHZpc2l0b3IuZnJvbU51bGwoKTtcbiAgfVxuXG4gIHJlYWRTdHJpbmc8Uj4oaW5wdXQ6IGFueSwgdmlzaXRvcjogUmVhZFZpc2l0b3I8Uj4pOiBSIHtcbiAgICBpZiAodHlwZW9mIGlucHV0ICE9PSBcInN0cmluZ1wiKSB7XG4gICAgICB0aHJvdyBjcmVhdGVJbnZhbGlkVHlwZUVycm9yKFwic3RyaW5nXCIsIGlucHV0KTtcbiAgICB9XG4gICAgcmV0dXJuIHZpc2l0b3IuZnJvbVN0cmluZyhpbnB1dCk7XG4gIH1cbn1cbiJdLCJzb3VyY2VSb290IjoiLi4vLi4ifQ==
