"use strict";
/**
 * @module kryo/readers/json-value
 */
Object.defineProperty(exports, "__esModule", { value: true });
const incident_1 = require("incident");
const invalid_type_1 = require("../errors/invalid-type");
class JsonValueReader {
    constructor(trust) {
        this.trustInput = trust;
    }
    readAny(raw, visitor) {
        switch (typeof raw) {
            case "boolean":
                return visitor.fromBoolean(raw);
            case "string":
                return visitor.fromString(raw);
            case "object":
                return raw === null
                    ? visitor.fromNull()
                    : visitor.fromMap(new Map(Object.keys(raw).map(k => [k, raw[k]])), this, this);
            default:
                throw invalid_type_1.createInvalidTypeError("array | boolean | null | object | string", raw);
        }
    }
    readBoolean(raw, visitor) {
        if (typeof raw !== "boolean") {
            throw invalid_type_1.createInvalidTypeError("boolean", raw);
        }
        return visitor.fromBoolean(raw);
    }
    readBytes(raw, visitor) {
        if (typeof raw !== "string") {
            throw invalid_type_1.createInvalidTypeError("string", raw);
        }
        else if (!/^(?:[0-9a-f]{2})*$/.test(raw)) {
            throw invalid_type_1.createInvalidTypeError("lowerCaseHexEvenLengthString", raw);
        }
        let result;
        const len = raw.length / 2;
        result = new Uint8Array(len);
        for (let i = 0; i < len; i++) {
            result[i] = parseInt(raw.substr(2 * i, 2), 16);
        }
        return visitor.fromBytes(result);
    }
    readDate(raw, visitor) {
        if (this.trustInput) {
            return visitor.fromDate(new Date(raw));
        }
        if (typeof raw === "string") {
            return visitor.fromDate(new Date(raw));
        }
        else if (typeof raw === "number") {
            return visitor.fromDate(new Date(raw));
        }
        throw invalid_type_1.createInvalidTypeError("string | number", raw);
    }
    readDocument(raw, visitor) {
        if (typeof raw !== "object" || raw === null) {
            throw invalid_type_1.createInvalidTypeError("object", raw);
        }
        const input = new Map();
        for (const key in raw) {
            input.set(key, raw[key]);
        }
        return visitor.fromMap(input, this, this);
    }
    readFloat64(raw, visitor) {
        const specialValues = new Map([
            ["NaN", NaN],
            ["Infinity", Infinity],
            ["+Infinity", Infinity],
            ["-Infinity", -Infinity],
        ]);
        const special = specialValues.get(raw);
        if (special === undefined && typeof raw !== "number") {
            throw new incident_1.Incident("InvalidInput", { raw, expected: "float64" });
        }
        return visitor.fromFloat64(special !== undefined ? special : raw);
    }
    readList(raw, visitor) {
        if (!Array.isArray(raw)) {
            throw invalid_type_1.createInvalidTypeError("array", raw);
        }
        return visitor.fromList(raw, this);
    }
    readMap(raw, visitor) {
        if (typeof raw !== "object" || raw === null) {
            throw invalid_type_1.createInvalidTypeError("object", raw);
        }
        const keyReader = new JsonValueReader();
        const input = new Map();
        for (const rawKey in raw) {
            let key;
            try {
                key = JSON.parse(rawKey);
                // key = (/* keyType */ undefined as any).read(jsonReader, key);
            }
            catch (err) {
                throw new incident_1.Incident(err, "InvalidMapKey", { rawKey });
            }
            input.set(key, raw[rawKey]);
        }
        return visitor.fromMap(input, keyReader, this);
    }
    readNull(raw, visitor) {
        if (this.trustInput) {
            return visitor.fromNull();
        }
        if (raw !== null) {
            throw invalid_type_1.createInvalidTypeError("null", raw);
        }
        return visitor.fromNull();
    }
    readString(raw, visitor) {
        if (typeof raw !== "string") {
            throw invalid_type_1.createInvalidTypeError("string", raw);
        }
        return visitor.fromString(raw);
    }
}
exports.JsonValueReader = JsonValueReader;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9saWIvcmVhZGVycy9qc29uLXZhbHVlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQTs7R0FFRzs7QUFFSCx1Q0FBb0M7QUFFcEMseURBQWdFO0FBR2hFLE1BQWEsZUFBZTtJQUcxQixZQUFZLEtBQWU7UUFDekIsSUFBSSxDQUFDLFVBQVUsR0FBRyxLQUFLLENBQUM7SUFDMUIsQ0FBQztJQUVELE9BQU8sQ0FBSSxHQUFjLEVBQUUsT0FBdUI7UUFDaEQsUUFBUSxPQUFPLEdBQUcsRUFBRTtZQUNsQixLQUFLLFNBQVM7Z0JBQ1osT0FBTyxPQUFPLENBQUMsV0FBVyxDQUFDLEdBQWMsQ0FBQyxDQUFDO1lBQzdDLEtBQUssUUFBUTtnQkFDWCxPQUFPLE9BQU8sQ0FBQyxVQUFVLENBQUMsR0FBYSxDQUFDLENBQUM7WUFDM0MsS0FBSyxRQUFRO2dCQUNYLE9BQU8sR0FBRyxLQUFLLElBQUk7b0JBQ2pCLENBQUMsQ0FBQyxPQUFPLENBQUMsUUFBUSxFQUFFO29CQUNwQixDQUFDLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxJQUFJLEdBQUcsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxFQUFHLEdBQVcsQ0FBQyxDQUFDLENBQUMsQ0FBa0IsQ0FBQyxDQUFDLEVBQUUsSUFBSSxFQUFFLElBQUksQ0FBQyxDQUFDO1lBQzdHO2dCQUNFLE1BQU0scUNBQXNCLENBQUMsMENBQTBDLEVBQUUsR0FBRyxDQUFDLENBQUM7U0FDakY7SUFDSCxDQUFDO0lBRUQsV0FBVyxDQUFJLEdBQWMsRUFBRSxPQUF1QjtRQUNwRCxJQUFJLE9BQU8sR0FBRyxLQUFLLFNBQVMsRUFBRTtZQUM1QixNQUFNLHFDQUFzQixDQUFDLFNBQVMsRUFBRSxHQUFHLENBQUMsQ0FBQztTQUM5QztRQUNELE9BQU8sT0FBTyxDQUFDLFdBQVcsQ0FBQyxHQUFHLENBQUMsQ0FBQztJ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QztJQUVELFFBQVEsQ0FBSSxHQUFjLEVBQUUsT0FBdUI7UUFDakQsSUFBSSxJQUFJLENBQUMsVUFBVSxFQUFFO1lBQ25CLE9BQU8sT0FBTyxDQUFDLFFBQVEsRUFBRSxDQUFDO1NBQzNCO1FBQ0QsSUFBSSxHQUFHLEtBQUssSUFBSSxFQUFFO1lBQ2hCLE1BQU0scUNBQXNCLENBQUMsTUFBTSxFQUFFLEdBQUcsQ0FBQyxDQUFDO1NBQzNDO1FBQ0QsT0FBTyxPQUFPLENBQUMsUUFBUSxFQUFFLENBQUM7SUFDNUIsQ0FBQztJQUVELFVBQVUsQ0FBSSxHQUFjLEVBQUUsT0FBdUI7UUFDbkQsSUFBSSxPQUFPLEdBQUcsS0FBSyxRQUFRLEVBQUU7WUFDM0IsTUFBTSxxQ0FBc0IsQ0FBQyxRQUFRLEVBQUUsR0FBRyxDQUFDLENBQUM7U0FDN0M7UUFDRCxPQUFPLE9BQU8sQ0FBQyxVQUFVLENBQUMsR0FBRyxDQUFDLENBQUM7SUFDakMsQ0FBQztDQUNGO0FBN0hELDBDQTZIQyIsImZpbGUiOiJsaWIvcmVhZGVycy9qc29uLXZhbHVlLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBAbW9kdWxlIGtyeW8vcmVhZGVycy9qc29uLXZhbHVlXG4gKi9cblxuaW1wb3J0IHsgSW5jaWRlbnQgfSBmcm9tIFwiaW5jaWRlbnRcIjtcbmltcG9ydCB7IFJlYWRlciwgUmVhZFZpc2l0b3IgfSBmcm9tIFwiLi4vY29yZVwiO1xuaW1wb3J0IHsgY3JlYXRlSW52YWxpZFR5cGVFcnJvciB9IGZyb20gXCIuLi9lcnJvcnMvaW52YWxpZC10eXBlXCI7XG5pbXBvcnQgeyBKc29uVmFsdWUgfSBmcm9tIFwiLi4vanNvbi12YWx1ZVwiO1xuXG5leHBvcnQgY2xhc3MgSnNvblZhbHVlUmVhZGVyIGltcGxlbWVudHMgUmVhZGVyPEpzb25WYWx1ZT4ge1xuICB0cnVzdElucHV0PzogYm9vbGVhbiB8IHVuZGVmaW5lZDtcblxuICBjb25zdHJ1Y3Rvcih0cnVzdD86IGJvb2xlYW4pIHtcbiAgICB0aGlzLnRydXN0SW5wdXQgPSB0cnVzdDtcbiAgfVxuXG4gIHJlYWRBbnk8Uj4ocmF3OiBKc29uVmFsdWUsIHZpc2l0b3I6IFJlYWRWaXNpdG9yPFI+KTogUiB7XG4gICAgc3dpdGNoICh0eXBlb2YgcmF3KSB7XG4gICAgICBjYXNlIFwiYm9vbGVhblwiOlxuICAgICAgICByZXR1cm4gdmlzaXRvci5mcm9tQm9vbGVhbihyYXcgYXMgYm9vbGVhbik7XG4gICAgICBjYXNlIFwic3RyaW5nXCI6XG4gICAgICAgIHJldHVybiB2aXNpdG9yLmZyb21TdHJpbmcocmF3IGFzIHN0cmluZyk7XG4gICAgICBjYXNlIFwib2JqZWN0XCI6XG4gICAgICAgIHJldHVybiByYXcgPT09IG51bGxcbiAgICAgICAgICA/IHZpc2l0b3IuZnJvbU51bGwoKVxuICAgICAgICAgIDogdmlzaXRvci5mcm9tTWFwKG5ldyBNYXAoT2JqZWN0LmtleXMocmF3KS5tYXAoayA9PiBbaywgKHJhdyBhcyBhbnkpW2tdXSBhcyBbc3RyaW5nLCBhbnldKSksIHRoaXMsIHRoaXMpO1xuICAgICAgZGVmYXVsdDpcbiAgICAgICAgdGhyb3cgY3JlYXRlSW52YWxpZFR5cGVFcnJvcihcImFycmF5IHwgYm9vbGVhbiB8IG51bGwgfCBvYmplY3QgfCBzdHJpbmdcIiwgcmF3KTtcbiAgICB9XG4gIH1cblxuICByZWFkQm9vbGVhbjxSPihyYXc6IEpzb25WYWx1ZSwgdmlzaXRvcjogUmVhZFZpc2l0b3I8Uj4pOiBSIHtcbiAgICBpZiAodHlwZW9mIHJhdyAhPT0gXCJib29sZWFuXCIpIHtcbiAgICAgIHRocm93IGNyZWF0ZUludmFsaWRUeXBlRXJyb3IoXCJib29sZWFuXCIsIHJhdyk7XG4gICAgfVxuICAgIHJldHVybiB2aXNpdG9yLmZyb21Cb29sZWFuKHJhdyk7XG4gIH1cblxuICByZWFkQnl0ZXM8Uj4ocmF3OiBKc29uVmFsdWUsIHZpc2l0b3I6IFJlYWRWaXNpdG9yPFI+KTogUiB7XG4gICAgaWYgKHR5cGVvZiByYXcgIT09IFwic3RyaW5nXCIpIHtcbiAgICAgIHRocm93IGNyZWF0ZUludmFsaWRUeXBlRXJyb3IoXCJzdHJpbmdcIiwgcmF3KTtcbiAgICB9IGVsc2UgaWYgKCEvXig/OlswLTlhLWZdezJ9KSokLy50ZXN0KHJhdykpIHtcbiAgICAgIHRocm93IGNyZWF0ZUludmFsaWRUeXBlRXJyb3IoXCJsb3dlckNhc2VIZXhFdmVuTGVuZ3RoU3RyaW5nXCIsIHJhdyk7XG4gICAgfVxuICAgIGxldCByZXN1bHQ6IFVpbnQ4QXJyYXk7XG4gICAgY29uc3QgbGVuOiBudW1iZXIgPSByYXcubGVuZ3RoIC8gMjtcbiAgICByZXN1bHQgPSBuZXcgVWludDhBcnJheShsZW4pO1xuICAgIGZvciAobGV0IGk6IG51bWJlciA9IDA7IGkgPCBsZW47IGkrKykge1xuICAgICAgcmVzdWx0W2ldID0gcGFyc2VJbnQocmF3LnN1YnN0cigyICogaSwgMiksIDE2KTtcbiAgICB9XG4gICAgcmV0dXJuIHZpc2l0b3IuZnJvbUJ5dGVzKHJlc3VsdCk7XG4gIH1cblxuICByZWFkRGF0ZTxSPihyYXc6IEpzb25WYWx1ZSwgdmlzaXRvcjogUmVhZFZpc2l0b3I8Uj4pOiBSIHtcbiAgICBpZiAodGhpcy50cnVzdElucHV0KSB7XG4gICAgICByZXR1cm4gdmlzaXRvci5mcm9tRGF0ZShuZXcgRGF0ZShyYXcgYXMgYW55KSk7XG4gICAgfVxuXG4gICAgaWYgKHR5cGVvZiByYXcgPT09IFwic3RyaW5nXCIpIHtcbiAgICAgIHJldHVybiB2aXNpdG9yLmZyb21EYXRlKG5ldyBEYXRlKHJhdykpO1xuICAgIH0gZWxzZSBpZiAodHlwZW9mIHJhdyA9PT0gXCJudW1iZXJcIikge1xuICAgICAgcmV0dXJuIHZpc2l0b3IuZnJvbURhdGUobmV3IERhdGUocmF3KSk7XG4gICAgfVxuICAgIHRocm93IGNyZWF0ZUludmFsaWRUeXBlRXJyb3IoXCJzdHJpbmcgfCBudW1iZXJcIiwgcmF3KTtcbiAgfVxuXG4gIHJlYWREb2N1bWVudDxSPihyYXc6IGFueSwgdmlzaXRvcjogUmVhZFZpc2l0b3I8Uj4pOiBSIHtcbiAgICBpZiAodHlwZW9mIHJhdyAhPT0gXCJvYmplY3RcIiB8fCByYXcgPT09IG51bGwpIHtcbiAgICAgIHRocm93IGNyZWF0ZUludmFsaWRUeXBlRXJyb3IoXCJvYmplY3RcIiwgcmF3KTtcbiAgICB9XG4gICAgY29uc3QgaW5wdXQ6IE1hcDxzdHJpbmcsIGFueT4gPSBuZXcgTWFwKCk7XG4gICAgZm9yIChjb25zdCBrZXkgaW4gcmF3KSB7XG4gICAgICBpbnB1dC5zZXQoa2V5LCByYXdba2V5XSk7XG4gICAgfVxuICAgIHJldHVybiB2aXNpdG9yLmZyb21NYXAoaW5wdXQsIHRoaXMsIHRoaXMpO1xuICB9XG5cbiAgcmVhZEZsb2F0NjQ8Uj4ocmF3OiBKc29uVmFsdWUsIHZpc2l0b3I6IFJlYWRWaXNpdG9yPFI+KTogUiB7XG4gICAgY29uc3Qgc3BlY2lhbFZhbHVlczogTWFwPGFueSwgbnVtYmVyPiA9IG5ldyBNYXAoW1xuICAgICAgW1wiTmFOXCIsIE5hTl0sXG4gICAgICBbXCJJbmZpbml0eVwiLCBJbmZpbml0eV0sXG4gICAgICBbXCIrSW5maW5pdHlcIiwgSW5maW5pdHldLFxuICAgICAgW1wiLUluZmluaXR5XCIsIC1JbmZpbml0eV0sXG4gICAgXSk7XG4gICAgY29uc3Qgc3BlY2lhbDogbnVtYmVyIHwgdW5kZWZpbmVkID0gc3BlY2lhbFZhbHVlcy5nZXQocmF3KTtcbiAgICBpZiAoc3BlY2lhbCA9PT0gdW5kZWZpbmVkICYmIHR5cGVvZiByYXcgIT09IFwibnVtYmVyXCIpIHtcbiAgICAgIHRocm93IG5ldyBJbmNpZGVudChcIkludmFsaWRJbnB1dFwiLCB7cmF3LCBleHBlY3RlZDogXCJmbG9hdDY0XCJ9KTtcbiAgICB9XG4gICAgcmV0dXJuIHZpc2l0b3IuZnJvbUZsb2F0NjQoc3BlY2lhbCAhPT0gdW5kZWZpbmVkID8gc3BlY2lhbCA6IHJhdyBhcyBudW1iZXIpO1xuICB9XG5cbiAgcmVhZExpc3Q8Uj4ocmF3OiBhbnksIHZpc2l0b3I6IFJlYWRWaXNpdG9yPFI+KTogUiB7XG4gICAgaWYgKCFBcnJheS5pc0FycmF5KHJhdykpIHtcbiAgICAgIHRocm93IGNyZWF0ZUludmFsaWRUeXBlRXJyb3IoXCJhcnJheVwiLCByYXcpO1xuICAgIH1cbiAgICByZXR1cm4gdmlzaXRvci5mcm9tTGlzdChyYXcsIHRoaXMpO1xuICB9XG5cbiAgcmVhZE1hcDxSPihyYXc6IGFueSwgdmlzaXRvcjogUmVhZFZpc2l0b3I8Uj4pOiBSIHtcbiAgICBpZiAodHlwZW9mIHJhdyAhPT0gXCJvYmplY3RcIiB8fCByYXcgPT09IG51bGwpIHtcbiAgICAgIHRocm93IGNyZWF0ZUludmFsaWRUeXBlRXJyb3IoXCJvYmplY3RcIiwgcmF3KTtcbiAgICB9XG4gICAgY29uc3Qga2V5UmVhZGVyOiBKc29uVmFsdWVSZWFkZXIgPSBuZXcgSnNvblZhbHVlUmVhZGVyKCk7XG5cbiAgICBjb25zdCBpbnB1dDogTWFwPGFueSwgYW55PiA9IG5ldyBNYXAoKTtcbiAgICBmb3IgKGNvbnN0IHJhd0tleSBpbiByYXcpIHtcbiAgICAgIGxldCBrZXk6IGFueTtcbiAgICAgIHRyeSB7XG4gICAgICAgIGtleSA9IEpTT04ucGFyc2UocmF3S2V5KTtcbiAgICAgICAgLy8ga2V5ID0gKC8qIGtleVR5cGUgKi8gdW5kZWZpbmVkIGFzIGFueSkucmVhZChqc29uUmVhZGVyLCBrZXkpO1xuICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgIHRocm93IG5ldyBJbmNpZGVudChlcnIsIFwiSW52YWxpZE1hcEtleVwiLCB7cmF3S2V5fSk7XG4gICAgICB9XG4gICAgICBpbnB1dC5zZXQoa2V5LCByYXdbcmF3S2V5XSk7XG4gICAgfVxuICAgIHJldHVybiB2aXNpdG9yLmZyb21NYXAoaW5wdXQsIGtleVJlYWRlciwgdGhpcyk7XG4gIH1cblxuICByZWFkTnVsbDxSPihyYXc6IEpzb25WYWx1ZSwgdmlzaXRvcjogUmVhZFZpc2l0b3I8Uj4pOiBSIHtcbiAgICBpZiAodGhpcy50cnVzdElucHV0KSB7XG4gICAgICByZXR1cm4gdmlzaXRvci5mcm9tTnVsbCgpO1xuICAgIH1cbiAgICBpZiAocmF3ICE9PSBudWxsKSB7XG4gICAgICB0aHJvdyBjcmVhdGVJbnZhbGlkVHlwZUVycm9yKFwibnVsbFwiLCByYXcpO1xuICAgIH1cbiAgICByZXR1cm4gdmlzaXRvci5mcm9tTnVsbCgpO1xuICB9XG5cbiAgcmVhZFN0cmluZzxSPihyYXc6IEpzb25WYWx1ZSwgdmlzaXRvcjogUmVhZFZpc2l0b3I8Uj4pOiBSIHtcbiAgICBpZiAodHlwZW9mIHJhdyAhPT0gXCJzdHJpbmdcIikge1xuICAgICAgdGhyb3cgY3JlYXRlSW52YWxpZFR5cGVFcnJvcihcInN0cmluZ1wiLCByYXcpO1xuICAgIH1cbiAgICByZXR1cm4gdmlzaXRvci5mcm9tU3RyaW5nKHJhdyk7XG4gIH1cbn1cbiJdLCJzb3VyY2VSb290IjoiLi4vLi4ifQ==
