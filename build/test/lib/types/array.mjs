import { Incident } from "incident";
import { lazyProperties } from "../_helpers/lazy-properties";
import { createInvalidArrayItemsError } from "../errors/invalid-array-items";
import { createInvalidTypeError } from "../errors/invalid-type";
import { createLazyOptionsError } from "../errors/lazy-options";
import { createMaxArrayLengthError } from "../errors/max-array-length";
import { createMinArrayLengthError } from "../errors/min-array-length";
import { readVisitor } from "../readers/read-visitor";
import { testError } from "../test-error";
export const name = "array";
// tslint:disable-next-line:variable-name
export const ArrayType = class {
    constructor(options) {
        this.name = name;
        this._options = options;
        if (typeof options !== "function") {
            this._applyOptions();
        }
        else {
            lazyProperties(this, this._applyOptions, ["itemType", "minLength", "maxLength"]);
        }
    }
    // TODO: Dynamically add with prototype?
    read(reader, raw) {
        const itemType = this.itemType;
        const minLength = this.minLength;
        const maxLength = this.maxLength;
        return reader.readList(raw, readVisitor({
            fromList(input, itemReader) {
                let invalid = undefined;
                const result = [];
                let i = 0;
                for (const rawItem of input) {
                    if (maxLength !== undefined && i === maxLength) {
                        throw createMaxArrayLengthError([...input], maxLength);
                    }
                    try {
                        const item = itemType.read(itemReader, rawItem);
                        if (invalid === undefined) {
                            result.push(item);
                        }
                    }
                    catch (err) {
                        if (invalid === undefined) {
                            invalid = new Map();
                        }
                        invalid.set(i, err);
                    }
                    i++;
                }
                if (invalid !== undefined) {
                    throw createInvalidArrayItemsError(invalid);
                }
                if (minLength !== undefined && i < minLength) {
                    throw createMinArrayLengthError([...input], minLength);
                }
                return result;
            },
        }));
    }
    // TODO: Dynamically add with prototype?
    write(writer, value) {
        return writer.writeList(value.length, (index, itemWriter) => {
            if (this.itemType.write === undefined) {
                throw new Incident("NotWritable", { type: this.itemType });
            }
            return this.itemType.write(itemWriter, value[index]);
        });
    }
    testError(value) {
        if (!Array.isArray(value)) {
            return createInvalidTypeError("array", value);
        }
        if (this.maxLength !== undefined && value.length > this.maxLength) {
            return createMaxArrayLengthError(value, this.maxLength);
        }
        if (this.minLength !== undefined && value.length < this.minLength) {
            return createMinArrayLengthError(value, this.minLength);
        }
        const invalid = new Map();
        const itemCount = value.length;
        for (let i = 0; i < itemCount; i++) {
            const error = testError(this.itemType, value[i]);
            if (error !== undefined) {
                invalid.set(i, error);
            }
        }
        if (invalid.size !== 0) {
            return createInvalidArrayItemsError(invalid);
        }
        return undefined;
    }
    test(val) {
        if (!Array.isArray(val)
            || (this.maxLength !== undefined && val.length > this.maxLength)
            || (this.minLength !== undefined && val.length < this.minLength)) {
            return false;
        }
        for (const item of val) {
            if (!this.itemType.test(item)) {
                return false;
            }
        }
        return true;
    }
    equals(val1, val2) {
        if (val2.length !== val1.length) {
            return false;
        }
        for (let i = 0; i < val1.length; i++) {
            if (!this.itemType.equals(val2[i], val1[i])) {
                return false;
            }
        }
        return true;
    }
    clone(val) {
        return val.map((item) => this.itemType.clone(item));
    }
    _applyOptions() {
        if (this._options === undefined) {
            throw createLazyOptionsError(this);
        }
        const options = typeof this._options === "function" ? this._options() : this._options;
        const itemType = options.itemType;
        const minLength = options.minLength;
        const maxLength = options.maxLength;
        Object.assign(this, { itemType, minLength, maxLength });
    }
};

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9saWIvdHlwZXMvYXJyYXkudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFFBQVEsRUFBRSxNQUFNLFVBQVUsQ0FBQztBQUNwQyxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sNkJBQTZCLENBQUM7QUFFN0QsT0FBTyxFQUFFLDRCQUE0QixFQUFFLE1BQU0sK0JBQStCLENBQUM7QUFDN0UsT0FBTyxFQUFFLHNCQUFzQixFQUFFLE1BQU0sd0JBQXdCLENBQUM7QUFDaEUsT0FBTyxFQUFFLHNCQUFzQixFQUFFLE1BQU0sd0JBQXdCLENBQUM7QUFDaEUsT0FBTyxFQUFFLHlCQUF5QixFQUFFLE1BQU0sNEJBQTRCLENBQUM7QUFDdkUsT0FBTyxFQUFFLHlCQUF5QixFQUFFLE1BQU0sNEJBQTRCLENBQUM7QUFDdkUsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLHlCQUF5QixDQUFDO0FBQ3RELE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFHMUMsTUFBTSxDQUFDLE1BQU0sSUFBSSxHQUFTLE9BQU8sQ0FBQztBQWdDbEMseUNBQXlDO0FBQ3pDLE1BQU0sQ0FBQyxNQUFNLFNBQVMsR0FBK0I7SUFRbkQsWUFBWSxPQUFxQztRQVB4QyxTQUFJLEdBQVMsSUFBSSxDQUFDO1FBUXpCLElBQUksQ0FBQyxRQUFRLEdBQUcsT0FBTyxDQUFDO1FBQ3hCLElBQUksT0FBTyxPQUFPLEtBQUssVUFBVSxFQUFFO1lBQ2pDLElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQztTQUN0QjthQUFNO1lBQ0wsY0FBYyxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsYUFBYSxFQUFFLENBQUMsVUFBVSxFQUFFLFdBQVcsRUFBRSxXQUFXLENBQUMsQ0FBQyxDQUFDO1NBQ2xGO0lBQ0gsQ0FBQztJQUVELHdDQUF3QztJQUN4QyxJQUFJLENBQUksTUFBaUIsRUFBRSxHQUFNO1FBQy9CLE1BQU0sUUFBUSxHQUFNLElBQUksQ0FBQyxRQUFR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QUFDO0NBQ0YsQ0FBQyIsImZpbGUiOiJsaWIvdHlwZXMvYXJyYXkuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmNpZGVudCB9IGZyb20gXCJpbmNpZGVudFwiO1xuaW1wb3J0IHsgbGF6eVByb3BlcnRpZXMgfSBmcm9tIFwiLi4vX2hlbHBlcnMvbGF6eS1wcm9wZXJ0aWVzXCI7XG5pbXBvcnQgeyBJb1R5cGUsIExhenksIFJlYWRlciwgVHlwZSwgV3JpdGVyIH0gZnJvbSBcIi4uL2NvcmVcIjtcbmltcG9ydCB7IGNyZWF0ZUludmFsaWRBcnJheUl0ZW1zRXJyb3IgfSBmcm9tIFwiLi4vZXJyb3JzL2ludmFsaWQtYXJyYXktaXRlbXNcIjtcbmltcG9ydCB7IGNyZWF0ZUludmFsaWRUeXBlRXJyb3IgfSBmcm9tIFwiLi4vZXJyb3JzL2ludmFsaWQtdHlwZVwiO1xuaW1wb3J0IHsgY3JlYXRlTGF6eU9wdGlvbnNFcnJvciB9IGZyb20gXCIuLi9lcnJvcnMvbGF6eS1vcHRpb25zXCI7XG5pbXBvcnQgeyBjcmVhdGVNYXhBcnJheUxlbmd0aEVycm9yIH0gZnJvbSBcIi4uL2Vycm9ycy9tYXgtYXJyYXktbGVuZ3RoXCI7XG5pbXBvcnQgeyBjcmVhdGVNaW5BcnJheUxlbmd0aEVycm9yIH0gZnJvbSBcIi4uL2Vycm9ycy9taW4tYXJyYXktbGVuZ3RoXCI7XG5pbXBvcnQgeyByZWFkVmlzaXRvciB9IGZyb20gXCIuLi9yZWFkZXJzL3JlYWQtdmlzaXRvclwiO1xuaW1wb3J0IHsgdGVzdEVycm9yIH0gZnJvbSBcIi4uL3Rlc3QtZXJyb3JcIjtcblxuZXhwb3J0IHR5cGUgTmFtZSA9IFwiYXJyYXlcIjtcbmV4cG9ydCBjb25zdCBuYW1lOiBOYW1lID0gXCJhcnJheVwiO1xuZXhwb3J0IHR5cGUgRGlmZiA9IGFueTtcblxuLyoqXG4gKiBUOiBJdGVtIHR5cGVcbiAqIE06IE1ldGEtVHlwZVxuICovXG5leHBvcnQgaW50ZXJmYWNlIEFycmF5VHlwZU9wdGlvbnM8VCwgTSBleHRlbmRzIFR5cGU8VD4gPSBUeXBlPFQ+PiB7XG4gIGl0ZW1UeXBlOiBNO1xuICBtaW5MZW5ndGg/OiBudW1iZXI7XG4gIG1heExlbmd0aDogbnVtYmVyO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIEFycmF5VHlwZUNvbnN0cnVjdG9yIHtcbiAgLyoqXG4gICAqIENyZWF0ZSBhIG5ldyBhcnJheSB0eXBlIHdpdGggZnVsbCByZWFkL3dyaXRlIHN1cHBvcnRcbiAgICovXG4gIG5ldzxUPihvcHRpb25zOiBMYXp5PEFycmF5VHlwZU9wdGlvbnM8VCwgSW9UeXBlPFQ+Pj4pOiBBcnJheUlvVHlwZTxULCBJb1R5cGU8VD4+O1xuXG4gIC8qKlxuICAgKiBDcmVhdGUgYSBuZXcgc2ltcGxlIGFycmF5IHR5cGVcbiAgICovXG4gIG5ldzxUPihvcHRpb25zOiBMYXp5PEFycmF5VHlwZU9wdGlvbnM8VD4+KTogQXJyYXlUeXBlPFQ+O1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIEFycmF5VHlwZTxULCBNIGV4dGVuZHMgVHlwZTxUPiA9IFR5cGU8VD4+IGV4dGVuZHMgVHlwZTxUW10+LCBBcnJheVR5cGVPcHRpb25zPFQsIE0+IHtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBBcnJheUlvVHlwZTxULCBNIGV4dGVuZHMgSW9UeXBlPFQ+ID0gSW9UeXBlPFQ+PiBleHRlbmRzIElvVHlwZTxUW10+LFxuICBBcnJheVR5cGVPcHRpb25zPFQsIE0+IHtcbn1cblxuLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOnZhcmlhYmxlLW5hbWVcbmV4cG9ydCBjb25zdCBBcnJheVR5cGU6IEFycmF5VHlwZUNvbnN0cnVjdG9yID0gPGFueT4gY2xhc3M8VCwgTSBleHRlbmRzIFR5cGU8VD4gPSBUeXBlPFQ+PiB7XG4gIHJlYWRvbmx5IG5hbWU6IE5hbWUgPSBuYW1lO1xuICByZWFkb25seSBpdGVtVHlwZSE6IE07XG4gIHJlYWRvbmx5IG1pbkxlbmd0aD86IG51bWJlcjtcbiAgcmVhZG9ubHkgbWF4TGVuZ3RoITogbnVtYmVyO1xuXG4gIHByaXZhdGUgX29wdGlvbnM6IExhenk8QXJyYXlUeXBlT3B0aW9uczxULCBNPj47XG5cbiAgY29uc3RydWN0b3Iob3B0aW9uczogTGF6eTxBcnJheVR5cGVPcHRpb25zPFQsIE0+Pikge1xuICAgIHRoaXMuX29wdGlvbnMgPSBvcHRpb25zO1xuICAgIGlmICh0eXBlb2Ygb3B0aW9ucyAhPT0gXCJmdW5jdGlvblwiKSB7XG4gICAgICB0aGlzLl9hcHBseU9wdGlvbnMoKTtcbiAgICB9IGVsc2Uge1xuICAgICAgbGF6eVByb3BlcnRpZXModGhpcywgdGhpcy5fYXBwbHlPcHRpb25zLCBbXCJpdGVtVHlwZVwiLCBcIm1pbkxlbmd0aFwiLCBcIm1heExlbmd0aFwiXSk7XG4gICAgfVxuICB9XG5cbiAgLy8gVE9ETzogRHluYW1pY2FsbHkgYWRkIHdpdGggcHJvdG90eXBlP1xuICByZWFkPFI+KHJlYWRlcjogUmVhZGVyPFI+LCByYXc6IFIpOiBUW10ge1xuICAgIGNvbnN0IGl0ZW1UeXBlOiBNID0gdGhpcy5pdGVtVHlwZTtcbiAgICBjb25zdCBtaW5MZW5ndGg6IG51bWJlciB8IHVuZGVmaW5lZCA9IHRoaXMubWluTGVuZ3RoO1xuICAgIGNvbnN0IG1heExlbmd0aDogbnVtYmVyIHwgdW5kZWZpbmVkID0gdGhpcy5tYXhMZW5ndGg7XG5cbiAgICByZXR1cm4gcmVhZGVyLnJlYWRMaXN0KHJhdywgcmVhZFZpc2l0b3Ioe1xuICAgICAgZnJvbUxpc3Q8Ukk+KGlucHV0OiBJdGVyYWJsZTxSST4sIGl0ZW1SZWFkZXI6IFJlYWRlcjxSST4pOiBUW10ge1xuICAgICAgICBsZXQgaW52YWxpZDogdW5kZWZpbmVkIHwgTWFwPG51bWJlciwgRXJyb3I+ID0gdW5kZWZpbmVkO1xuICAgICAgICBjb25zdCByZXN1bHQ6IFRbXSA9IFtdO1xuICAgICAgICBsZXQgaTogbnVtYmVyID0gMDtcbiAgICAgICAgZm9yIChjb25zdCByYXdJdGVtIG9mIGlucHV0KSB7XG4gICAgICAgICAgaWYgKG1heExlbmd0aCAhPT0gdW5kZWZpbmVkICYmIGkgPT09IG1heExlbmd0aCkge1xuICAgICAgICAgICAgdGhyb3cgY3JlYXRlTWF4QXJyYXlMZW5ndGhFcnJvcihbLi4uaW5wdXRdLCBtYXhMZW5ndGgpO1xuICAgICAgICAgIH1cbiAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgY29uc3QgaXRlbTogVCA9IGl0ZW1UeXBlLnJlYWQhKGl0ZW1SZWFkZXIsIHJhd0l0ZW0pO1xuICAgICAgICAgICAgaWYgKGludmFsaWQgPT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgICByZXN1bHQucHVzaChpdGVtKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgICAgIGlmIChpbnZhbGlkID09PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgICAgaW52YWxpZCA9IG5ldyBNYXAoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGludmFsaWQuc2V0KGksIGVycik7XG4gICAgICAgICAgfVxuICAgICAgICAgIGkrKztcbiAgICAgICAgfVxuICAgICAgICBpZiAoaW52YWxpZCAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgdGhyb3cgY3JlYXRlSW52YWxpZEFycmF5SXRlbXNFcnJvcihpbnZhbGlkKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAobWluTGVuZ3RoICE9PSB1bmRlZmluZWQgJiYgaSA8IG1pbkxlbmd0aCkge1xuICAgICAgICAgIHRocm93IGNyZWF0ZU1pbkFycmF5TGVuZ3RoRXJyb3IoWy4uLmlucHV0XSwgbWluTGVuZ3RoKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gcmVzdWx0O1xuICAgICAgfSxcbiAgICB9KSk7XG4gIH1cblxuICAvLyBUT0RPOiBEeW5hbWljYWxseSBhZGQgd2l0aCBwcm90b3R5cGU/XG4gIHdyaXRlPFc+KHdyaXRlcjogV3JpdGVyPFc+LCB2YWx1ZTogVFtdKTogVyB7XG4gICAgcmV0dXJuIHdyaXRlci53cml0ZUxpc3QodmFsdWUubGVuZ3RoLCA8SVc+KGluZGV4OiBudW1iZXIsIGl0ZW1Xcml0ZXI6IFdyaXRlcjxJVz4pOiBJVyA9PiB7XG4gICAgICBpZiAodGhpcy5pdGVtVHlwZS53cml0ZSA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIHRocm93IG5ldyBJbmNpZGVudChcIk5vdFdyaXRhYmxlXCIsIHt0eXBlOiB0aGlzLml0ZW1UeXBlfSk7XG4gICAgICB9XG4gICAgICByZXR1cm4gdGhpcy5pdGVtVHlwZS53cml0ZShpdGVtV3JpdGVyLCB2YWx1ZVtpbmRleF0pO1xuICAgIH0pO1xuICB9XG5cbiAgdGVzdEVycm9yKHZhbHVlOiBUW10pOiBFcnJvciB8IHVuZGVmaW5lZCB7XG4gICAgaWYgKCFBcnJheS5pc0FycmF5KHZhbHVlKSkge1xuICAgICAgcmV0dXJuIGNyZWF0ZUludmFsaWRUeXBlRXJyb3IoXCJhcnJheVwiLCB2YWx1ZSk7XG4gICAgfVxuICAgIGlmICh0aGlzLm1heExlbmd0aCAhPT0gdW5kZWZpbmVkICYmIHZhbHVlLmxlbmd0aCA+IHRoaXMubWF4TGVuZ3RoKSB7XG4gICAgICByZXR1cm4gY3JlYXRlTWF4QXJyYXlMZW5ndGhFcnJvcih2YWx1ZSwgdGhpcy5tYXhMZW5ndGgpO1xuICAgIH1cbiAgICBpZiAodGhpcy5taW5MZW5ndGggIT09IHVuZGVmaW5lZCAmJiB2YWx1ZS5sZW5ndGggPCB0aGlzLm1pbkxlbmd0aCkge1xuICAgICAgcmV0dXJuIGNyZWF0ZU1pbkFycmF5TGVuZ3RoRXJyb3IodmFsdWUsIHRoaXMubWluTGVuZ3RoKTtcbiAgICB9XG4gICAgY29uc3QgaW52YWxpZDogTWFwPG51bWJlciwgRXJyb3I+ID0gbmV3IE1hcCgpO1xuICAgIGNvbnN0IGl0ZW1Db3VudDogbnVtYmVyID0gdmFsdWUubGVuZ3RoO1xuICAgIGZvciAobGV0IGk6IG51bWJlciA9IDA7IGkgPCBpdGVtQ291bnQ7IGkrKykge1xuICAgICAgY29uc3QgZXJyb3I6IEVycm9yIHwgdW5kZWZpbmVkID0gdGVzdEVycm9yKHRoaXMuaXRlbVR5cGUsIHZhbHVlW2ldKTtcbiAgICAgIGlmIChlcnJvciAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIGludmFsaWQuc2V0KGksIGVycm9yKTtcbiAgICAgIH1cbiAgICB9XG4gICAgaWYgKGludmFsaWQuc2l6ZSAhPT0gMCkge1xuICAgICAgcmV0dXJuIGNyZWF0ZUludmFsaWRBcnJheUl0ZW1zRXJyb3IoaW52YWxpZCk7XG4gICAgfVxuICAgIHJldHVybiB1bmRlZmluZWQ7XG4gIH1cblxuICB0ZXN0KHZhbDogVFtdKTogdmFsIGlzIFRbXSB7XG4gICAgaWYgKFxuICAgICAgIUFycmF5LmlzQXJyYXkodmFsKVxuICAgICAgfHwgKHRoaXMubWF4TGVuZ3RoICE9PSB1bmRlZmluZWQgJiYgdmFsLmxlbmd0aCA+IHRoaXMubWF4TGVuZ3RoKVxuICAgICAgfHwgKHRoaXMubWluTGVuZ3RoICE9PSB1bmRlZmluZWQgJiYgdmFsLmxlbmd0aCA8IHRoaXMubWluTGVuZ3RoKVxuICAgICkge1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgICBmb3IgKGNvbnN0IGl0ZW0gb2YgdmFsKSB7XG4gICAgICBpZiAoIXRoaXMuaXRlbVR5cGUudGVzdChpdGVtKSkge1xuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiB0cnVlO1xuICB9XG5cbiAgZXF1YWxzKHZhbDE6IFRbXSwgdmFsMjogVFtdKTogYm9vbGVhbiB7XG4gICAgaWYgKHZhbDIubGVuZ3RoICE9PSB2YWwxLmxlbmd0aCkge1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgICBmb3IgKGxldCBpOiBudW1iZXIgPSAwOyBpIDwgdmFsMS5sZW5ndGg7IGkrKykge1xuICAgICAgaWYgKCF0aGlzLml0ZW1UeXBlLmVxdWFscyh2YWwyW2ldLCB2YWwxW2ldKSkge1xuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiB0cnVlO1xuICB9XG5cbiAgY2xvbmUodmFsOiBUW10pOiBUW10ge1xuICAgIHJldHVybiB2YWwubWFwKChpdGVtOiBUKTogVCA9PiB0aGlzLml0ZW1UeXBlLmNsb25lKGl0ZW0pKTtcbiAgfVxuXG4gIHByaXZhdGUgX2FwcGx5T3B0aW9ucygpOiB2b2lkIHtcbiAgICBpZiAodGhpcy5fb3B0aW9ucyA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICB0aHJvdyBjcmVhdGVMYXp5T3B0aW9uc0Vycm9yKHRoaXMpO1xuICAgIH1cbiAgICBjb25zdCBvcHRpb25zOiBBcnJheVR5cGVPcHRpb25zPFQsIE0+ID0gdHlwZW9mIHRoaXMuX29wdGlvbnMgPT09IFwiZnVuY3Rpb25cIiA/IHRoaXMuX29wdGlvbnMoKSA6IHRoaXMuX29wdGlvbnM7XG5cbiAgICBjb25zdCBpdGVtVHlwZTogTSA9IG9wdGlvbnMuaXRlbVR5cGU7XG4gICAgY29uc3QgbWluTGVuZ3RoOiBudW1iZXIgfCB1bmRlZmluZWQgPSBvcHRpb25zLm1pbkxlbmd0aDtcbiAgICBjb25zdCBtYXhMZW5ndGg6IG51bWJlciA9IG9wdGlvbnMubWF4TGVuZ3RoO1xuXG4gICAgT2JqZWN0LmFzc2lnbih0aGlzLCB7aXRlbVR5cGUsIG1pbkxlbmd0aCwgbWF4TGVuZ3RofSk7XG4gIH1cbn07XG4iXSwic291cmNlUm9vdCI6Ii4uLy4uIn0=
