"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const lazy_properties_1 = require("../_helpers/lazy-properties");
const invalid_float64_1 = require("../errors/invalid-float64");
const invalid_type_1 = require("../errors/invalid-type");
const lazy_options_1 = require("../errors/lazy-options");
const read_visitor_1 = require("../readers/read-visitor");
exports.name = "float64";
class Float64Type {
    constructor(options) {
        this.name = exports.name;
        this._options = options !== undefined ? options : {};
        if (typeof options !== "function") {
            this._applyOptions();
        }
        else {
            lazy_properties_1.lazyProperties(this, this._applyOptions, ["allowNaN", "allowInfinity"]);
        }
    }
    static fromJSON(options) {
        return new Float64Type(options);
    }
    toJSON() {
        return {
            name: exports.name,
            allowNaN: this.allowNaN,
            allowInfinity: this.allowInfinity,
        };
    }
    read(reader, raw) {
        return reader.readFloat64(raw, read_visitor_1.readVisitor({
            fromFloat64: (input) => {
                const error = reader.trustInput ? undefined : this.testError(input);
                if (error !== undefined) {
                    throw error;
                }
                return input;
            },
        }));
    }
    // TODO: Dynamically add with prototype?
    write(writer, value) {
        return writer.writeFloat64(value);
    }
    testError(val) {
        if (typeof val !== "number") {
            return invalid_type_1.createInvalidTypeError("number", val);
        }
        if (isNaN(val) && !this.allowNaN) {
            return invalid_float64_1.createInvalidFloat64Error(val);
        }
        else if (Math.abs(val) === Infinity && !this.allowInfinity) {
            return invalid_float64_1.createInvalidFloat64Error(val);
        }
        return undefined;
    }
    test(val) {
        return typeof val === "number"
            && (this.allowNaN || !isNaN(val))
            && (this.allowInfinity || Math.abs(val) !== Infinity);
    }
    /**
     * Tests the equivalence of two valid float64 values.
     *
     * Two values are equivalent if they are both `NaN`, both `-0`, both `+0` or non-zero and
     * numerically equal.
     */
    equals(left, right) {
        return Object.is(left, right);
    }
    /**
     * Compares two valid float64 values.
     *
     * The values are ordered as follow:
     * - `-Infinity`
     * - Negative non-zero finite values
     * - `-0`
     * - `+0`
     * - Positive non-zero finite values
     * - `+Infinity`
     * - `NaN`
     *
     * @param left Left operand.
     * @param right Right operand.
     * @return Boolean indicating if `left <= right`
     */
    lte(left, right) {
        if (isNaN(right)) {
            return true;
        }
        else if (isNaN(left)) {
            return false;
        }
        if (left === 0 && right === 0) {
            return Object.is(left, -0) || Object.is(right, +0);
        }
        return left <= right;
    }
    clone(value) {
        return value;
    }
    diff(oldVal, newVal) {
        // We can't use an arithmetic difference due to possible precision loss
        return this.equals(oldVal, newVal) ? undefined : [oldVal, newVal];
    }
    patch(oldVal, diff) {
        return diff === undefined ? oldVal : diff[1];
    }
    reverseDiff(diff) {
        return diff === undefined ? undefined : [diff[1], diff[0]];
    }
    squash(diff1, diff2) {
        if (diff1 === undefined) {
            return diff2 === undefined ? undefined : [diff2[0], diff2[1]];
        }
        else if (diff2 === undefined) {
            return [diff1[0], diff1[1]];
        }
        return this.equals(diff1[0], diff2[1]) ? undefined : [diff1[0], diff2[1]];
    }
    _applyOptions() {
        if (this._options === undefined) {
            throw lazy_options_1.createLazyOptionsError(this);
        }
        const options = typeof this._options === "function" ? this._options() : this._options;
        const allowNaN = options.allowNaN !== undefined ? options.allowNaN : false;
        const allowInfinity = options.allowInfinity !== undefined ? options.allowInfinity : false;
        Object.assign(this, { allowNaN, allowInfinity });
    }
}
exports.Float64Type = Float64Type;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9saWIvdHlwZXMvZmxvYXQ2NC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLGlFQUE2RDtBQUU3RCwrREFBc0U7QUFDdEUseURBQWdFO0FBQ2hFLHlEQUFnRTtBQUNoRSwwREFBc0Q7QUFHekMsUUFBQSxJQUFJLEdBQVMsU0FBUyxDQUFDO0FBK0JwQyxNQUFhLFdBQVc7SUFPdEIsWUFBWSxPQUFrQztRQU5yQyxTQUFJLEdBQVMsWUFBSSxDQUFDO1FBT3pCLElBQUksQ0FBQyxRQUFRLEdBQUcsT0FBTyxLQUFLLFNBQVMsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUM7UUFDckQsSUFBSSxPQUFPLE9BQU8sS0FBSyxVQUFVLEVBQUU7WUFDakMsSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFDO1NBQ3RCO2FBQU07WUFDTCxnQ0FBYyxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsYUFBYSxFQUFFLENBQUMsVUFBVSxFQUFFLGVBQWUsQ0FBQyxDQUFDLENBQUM7U0FDekU7SUFDSCxDQUFDO0lBRUQsTUFBTSxDQUFDLFFBQVEsQ0FBQyxPQUFrQjtRQUNoQyxPQUFPLElBQUksV0FBVyxDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBQ2xDLENBQUM7SUFFRCxNQUFNO1FBQ0osT0FBTztZQUNMLElBQUksRUFBSixZQUFJO1lBQ0osUUFBUSxFQUFFLElBQUksQ0FBQyxRQUFRO1lBQ3ZCLGFBQWEsRUFBRSxJQUFJLENBQUMsYUFBYTtTQUNsQyxDQUFDO0lBQ0osQ0FBQztJQUVELElBQUksQ0FBSSxNQUFpQixFQUFFLEdBQU07UUFDL0IsT0FBTyxNQUFNLENBQUMsV0FBVyxDQUFDLEdBQUcsRUFBRSwwQkFBVyxDQUFDO1lBQ3pDLFdBQVcsRUFBRSxDQUFDLEtBQWEsRUFBVSxFQUFFO2dCQUNyQyxNQUFNLEtBQUssR0FBc0IsTUFBTSxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxJQUFJ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QUFDLENBQUMsQ0FBQyxLQUFLLENBQUM7UUFFbkcsTUFBTSxDQUFDLE1BQU0sQ0FBQyxJQUFJLEVBQUUsRUFBQyxRQUFRLEVBQUUsYUFBYSxFQUFDLENBQUMsQ0FBQztJQUNqRCxDQUFDO0NBQ0Y7QUF6SUQsa0NBeUlDIiwiZmlsZSI6ImxpYi90eXBlcy9mbG9hdDY0LmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgbGF6eVByb3BlcnRpZXMgfSBmcm9tIFwiLi4vX2hlbHBlcnMvbGF6eS1wcm9wZXJ0aWVzXCI7XG5pbXBvcnQgeyBJb1R5cGUsIExhenksIE9yZCwgUmVhZGVyLCBWZXJzaW9uZWRUeXBlLCBXcml0ZXIgfSBmcm9tIFwiLi4vY29yZVwiO1xuaW1wb3J0IHsgY3JlYXRlSW52YWxpZEZsb2F0NjRFcnJvciB9IGZyb20gXCIuLi9lcnJvcnMvaW52YWxpZC1mbG9hdDY0XCI7XG5pbXBvcnQgeyBjcmVhdGVJbnZhbGlkVHlwZUVycm9yIH0gZnJvbSBcIi4uL2Vycm9ycy9pbnZhbGlkLXR5cGVcIjtcbmltcG9ydCB7IGNyZWF0ZUxhenlPcHRpb25zRXJyb3IgfSBmcm9tIFwiLi4vZXJyb3JzL2xhenktb3B0aW9uc1wiO1xuaW1wb3J0IHsgcmVhZFZpc2l0b3IgfSBmcm9tIFwiLi4vcmVhZGVycy9yZWFkLXZpc2l0b3JcIjtcblxuZXhwb3J0IHR5cGUgTmFtZSA9IFwiZmxvYXQ2NFwiO1xuZXhwb3J0IGNvbnN0IG5hbWU6IE5hbWUgPSBcImZsb2F0NjRcIjtcbmV4cG9ydCBuYW1lc3BhY2UganNvbiB7XG4gIGV4cG9ydCBpbnRlcmZhY2UgVHlwZSB7XG4gICAgcmVhZG9ubHkgbmFtZTogTmFtZTtcbiAgICByZWFkb25seSBhbGxvd05hTjogYm9vbGVhbjtcbiAgICByZWFkb25seSBhbGxvd0luZmluaXR5OiBib29sZWFuO1xuICB9XG59XG5cbi8qKlxuICogT3B0aW9ucyBmb3IgdGhlIGBGbG9hdDY0YCBtZXRhLXR5cGUuXG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgRmxvYXQ2NFR5cGVPcHRpb25zIHtcbiAgLyoqXG4gICAqIEFjY2VwdCBgTmFOYCB2YWx1ZXMuXG4gICAqIElmIHlvdSBlbmFibGUgdGhpcyBvcHRpb24sIHRoZSBgdGVzdGAgbWV0aG9kIHdpbGwgdHJlYXQgdHdvIGBOYU5gIHZhbHVlcyBhcyBlcXVhbC5cbiAgICpcbiAgICogQGRlZmF1bHQgYGZhbHNlYFxuICAgKi9cbiAgcmVhZG9ubHkgYWxsb3dOYU4/OiBib29sZWFuO1xuXG4gIC8qKlxuICAgKiBBY2NlcHQgYCtJbmZpbml0eWAgYW5kIGAtSW5maW5pdHlgLlxuICAgKlxuICAgKiBAZGVmYXVsdCBgZmFsc2VgXG4gICAqL1xuICByZWFkb25seSBhbGxvd0luZmluaXR5PzogYm9vbGVhbjtcblxuICAvLyBUT0RPOiBBZGQgYHVuaWZ5WmVyb3NgIChkZWZhdWx0cyB0byBgdHJ1ZWApIHRvIGhhbmRsZSBgKzBgIGFuZCBgLTBgXG59XG5cbmV4cG9ydCBjbGFzcyBGbG9hdDY0VHlwZSBpbXBsZW1lbnRzIElvVHlwZTxudW1iZXI+LCBWZXJzaW9uZWRUeXBlPG51bWJlciwgW251bWJlciwgbnVtYmVyXT4sIE9yZDxudW1iZXI+IHtcbiAgcmVhZG9ubHkgbmFtZTogTmFtZSA9IG5hbWU7XG4gIHJlYWRvbmx5IGFsbG93TmFOITogYm9vbGVhbjtcbiAgcmVhZG9ubHkgYWxsb3dJbmZpbml0eSE6IGJvb2xlYW47XG5cbiAgcHJpdmF0ZSBfb3B0aW9uczogTGF6eTxGbG9hdDY0VHlwZU9wdGlvbnM+O1xuXG4gIGNvbnN0cnVjdG9yKG9wdGlvbnM/OiBMYXp5PEZsb2F0NjRUeXBlT3B0aW9ucz4pIHtcbiAgICB0aGlzLl9vcHRpb25zID0gb3B0aW9ucyAhPT0gdW5kZWZpbmVkID8gb3B0aW9ucyA6IHt9O1xuICAgIGlmICh0eXBlb2Ygb3B0aW9ucyAhPT0gXCJmdW5jdGlvblwiKSB7XG4gICAgICB0aGlzLl9hcHBseU9wdGlvbnMoKTtcbiAgICB9IGVsc2Uge1xuICAgICAgbGF6eVByb3BlcnRpZXModGhpcywgdGhpcy5fYXBwbHlPcHRpb25zLCBbXCJhbGxvd05hTlwiLCBcImFsbG93SW5maW5pdHlcIl0pO1xuICAgIH1cbiAgfVxuXG4gIHN0YXRpYyBmcm9tSlNPTihvcHRpb25zOiBqc29uLlR5cGUpOiBGbG9hdDY0VHlwZSB7XG4gICAgcmV0dXJuIG5ldyBGbG9hdDY0VHlwZShvcHRpb25zKTtcbiAgfVxuXG4gIHRvSlNPTigpOiBqc29uLlR5cGUge1xuICAgIHJldHVybiB7XG4gICAgICBuYW1lLFxuICAgICAgYWxsb3dOYU46IHRoaXMuYWxsb3dOYU4sXG4gICAgICBhbGxvd0luZmluaXR5OiB0aGlzLmFsbG93SW5maW5pdHksXG4gICAgfTtcbiAgfVxuXG4gIHJlYWQ8Uj4ocmVhZGVyOiBSZWFkZXI8Uj4sIHJhdzogUik6IG51bWJlciB7XG4gICAgcmV0dXJuIHJlYWRlci5yZWFkRmxvYXQ2NChyYXcsIHJlYWRWaXNpdG9yKHtcbiAgICAgIGZyb21GbG9hdDY0OiAoaW5wdXQ6IG51bWJlcik6IG51bWJlciA9PiB7XG4gICAgICAgIGNvbnN0IGVycm9yOiBFcnJvciB8IHVuZGVmaW5lZCA9IHJlYWRlci50cnVzdElucHV0ID8gdW5kZWZpbmVkIDogdGhpcy50ZXN0RXJyb3IoaW5wdXQpO1xuICAgICAgICBpZiAoZXJyb3IgIT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgIHRocm93IGVycm9yO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBpbnB1dDtcbiAgICAgIH0sXG4gICAgfSkpO1xuICB9XG5cbiAgLy8gVE9ETzogRHluYW1pY2FsbHkgYWRkIHdpdGggcHJvdG90eXBlP1xuICB3cml0ZTxXPih3cml0ZXI6IFdyaXRlcjxXPiwgdmFsdWU6IG51bWJlcik6IFcge1xuICAgIHJldHVybiB3cml0ZXIud3JpdGVGbG9hdDY0KHZhbHVlKTtcbiAgfVxuXG4gIHRlc3RFcnJvcih2YWw6IG51bWJlcik6IEVycm9yIHwgdW5kZWZpbmVkIHtcbiAgICBpZiAodHlwZW9mIHZhbCAhPT0gXCJudW1iZXJcIikge1xuICAgICAgcmV0dXJuIGNyZWF0ZUludmFsaWRUeXBlRXJyb3IoXCJudW1iZXJcIiwgdmFsKTtcbiAgICB9XG4gICAgaWYgKGlzTmFOKHZhbCkgJiYgIXRoaXMuYWxsb3dOYU4pIHtcbiAgICAgIHJldHVybiBjcmVhdGVJbnZhbGlkRmxvYXQ2NEVycm9yKHZhbCk7XG4gICAgfSBlbHNlIGlmIChNYXRoLmFicyh2YWwpID09PSBJbmZpbml0eSAmJiAhdGhpcy5hbGxvd0luZmluaXR5KSB7XG4gICAgICByZXR1cm4gY3JlYXRlSW52YWxpZEZsb2F0NjRFcnJvcih2YWwpO1xuICAgIH1cbiAgICByZXR1cm4gdW5kZWZpbmVkO1xuICB9XG5cbiAgdGVzdCh2YWw6IG51bWJlcik6IGJvb2xlYW4ge1xuICAgIHJldHVybiB0eXBlb2YgdmFsID09PSBcIm51bWJlclwiXG4gICAgICAmJiAodGhpcy5hbGxvd05hTiB8fCAhaXNOYU4odmFsKSlcbiAgICAgICYmICh0aGlzLmFsbG93SW5maW5pdHkgfHwgTWF0aC5hYnModmFsKSAhPT0gSW5maW5pdHkpO1xuICB9XG5cbiAgLyoqXG4gICAqIFRlc3RzIHRoZSBlcXVpdmFsZW5jZSBvZiB0d28gdmFsaWQgZmxvYXQ2NCB2YWx1ZXMuXG4gICAqXG4gICAqIFR3byB2YWx1ZXMgYXJlIGVxdWl2YWxlbnQgaWYgdGhleSBhcmUgYm90aCBgTmFOYCwgYm90aCBgLTBgLCBib3RoIGArMGAgb3Igbm9uLXplcm8gYW5kXG4gICAqIG51bWVyaWNhbGx5IGVxdWFsLlxuICAgKi9cbiAgZXF1YWxzKGxlZnQ6IG51bWJlciwgcmlnaHQ6IG51bWJlcik6IGJvb2xlYW4ge1xuICAgIHJldHVybiBPYmplY3QuaXMobGVmdCwgcmlnaHQpO1xuICB9XG5cbiAgLyoqXG4gICAqIENvbXBhcmVzIHR3byB2YWxpZCBmbG9hdDY0IHZhbHVlcy5cbiAgICpcbiAgICogVGhlIHZhbHVlcyBhcmUgb3JkZXJlZCBhcyBmb2xsb3c6XG4gICAqIC0gYC1JbmZpbml0eWBcbiAgICogLSBOZWdhdGl2ZSBub24temVybyBmaW5pdGUgdmFsdWVzXG4gICAqIC0gYC0wYFxuICAgKiAtIGArMGBcbiAgICogLSBQb3NpdGl2ZSBub24temVybyBmaW5pdGUgdmFsdWVzXG4gICAqIC0gYCtJbmZpbml0eWBcbiAgICogLSBgTmFOYFxuICAgKlxuICAgKiBAcGFyYW0gbGVmdCBMZWZ0IG9wZXJhbmQuXG4gICAqIEBwYXJhbSByaWdodCBSaWdodCBvcGVyYW5kLlxuICAgKiBAcmV0dXJuIEJvb2xlYW4gaW5kaWNhdGluZyBpZiBgbGVmdCA8PSByaWdodGBcbiAgICovXG4gIGx0ZShsZWZ0OiBudW1iZXIsIHJpZ2h0OiBudW1iZXIpOiBib29sZWFuIHtcbiAgICBpZiAoaXNOYU4ocmlnaHQpKSB7XG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9IGVsc2UgaWYgKGlzTmFOKGxlZnQpKSB7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuICAgIGlmIChsZWZ0ID09PSAwICYmIHJpZ2h0ID09PSAwKSB7XG4gICAgICByZXR1cm4gT2JqZWN0LmlzKGxlZnQsIC0wKSB8fCBPYmplY3QuaXMocmlnaHQsICswKTtcbiAgICB9XG4gICAgcmV0dXJuIGxlZnQgPD0gcmlnaHQ7XG4gIH1cblxuICBjbG9uZSh2YWx1ZTogbnVtYmVyKTogbnVtYmVyIHtcbiAgICByZXR1cm4gdmFsdWU7XG4gIH1cblxuICBkaWZmKG9sZFZhbDogbnVtYmVyLCBuZXdWYWw6IG51bWJlcik6IFtudW1iZXIsIG51bWJlcl0gfCB1bmRlZmluZWQge1xuICAgIC8vIFdlIGNhbid0IHVzZSBhbiBhcml0aG1ldGljIGRpZmZlcmVuY2UgZHVlIHRvIHBvc3NpYmxlIHByZWNpc2lvbiBsb3NzXG4gICAgcmV0dXJuIHRoaXMuZXF1YWxzKG9sZFZhbCwgbmV3VmFsKSA/IHVuZGVmaW5lZCA6IFtvbGRWYWwsIG5ld1ZhbF07XG4gIH1cblxuICBwYXRjaChvbGRWYWw6IG51bWJlciwgZGlmZjogW251bWJlciwgbnVtYmVyXSB8IHVuZGVmaW5lZCk6IG51bWJlciB7XG4gICAgcmV0dXJuIGRpZmYgPT09IHVuZGVmaW5lZCA/IG9sZFZhbCA6IGRpZmZbMV07XG4gIH1cblxuICByZXZlcnNlRGlmZihkaWZmOiBbbnVtYmVyLCBudW1iZXJdIHwgdW5kZWZpbmVkKTogW251bWJlciwgbnVtYmVyXSB8IHVuZGVmaW5lZCB7XG4gICAgcmV0dXJuIGRpZmYgPT09IHVuZGVmaW5lZCA/IHVuZGVmaW5lZCA6IFtkaWZmWzFdLCBkaWZmWzBdXTtcbiAgfVxuXG4gIHNxdWFzaChkaWZmMTogW251bWJlciwgbnVtYmVyXSB8IHVuZGVmaW5lZCwgZGlmZjI6IFtudW1iZXIsIG51bWJlcl0gfCB1bmRlZmluZWQpOiBbbnVtYmVyLCBudW1iZXJdIHwgdW5kZWZpbmVkIHtcbiAgICBpZiAoZGlmZjEgPT09IHVuZGVmaW5lZCkge1xuICAgICAgcmV0dXJuIGRpZmYyID09PSB1bmRlZmluZWQgPyB1bmRlZmluZWQgOiBbZGlmZjJbMF0sIGRpZmYyWzFdXTtcbiAgICB9IGVsc2UgaWYgKGRpZmYyID09PSB1bmRlZmluZWQpIHtcbiAgICAgIHJldHVybiBbZGlmZjFbMF0sIGRpZmYxWzFdXTtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMuZXF1YWxzKGRpZmYxWzBdLCBkaWZmMlsxXSkgPyB1bmRlZmluZWQgOiBbZGlmZjFbMF0sIGRpZmYyWzFdXTtcbiAgfVxuXG4gIHByaXZhdGUgX2FwcGx5T3B0aW9ucygpOiB2b2lkIHtcbiAgICBpZiAodGhpcy5fb3B0aW9ucyA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICB0aHJvdyBjcmVhdGVMYXp5T3B0aW9uc0Vycm9yKHRoaXMpO1xuICAgIH1cbiAgICBjb25zdCBvcHRpb25zOiBGbG9hdDY0VHlwZU9wdGlvbnMgPSB0eXBlb2YgdGhpcy5fb3B0aW9ucyA9PT0gXCJmdW5jdGlvblwiID8gdGhpcy5fb3B0aW9ucygpIDogdGhpcy5fb3B0aW9ucztcbiAgICBjb25zdCBhbGxvd05hTjogYm9vbGVhbiA9IG9wdGlvbnMuYWxsb3dOYU4gIT09IHVuZGVmaW5lZCA/IG9wdGlvbnMuYWxsb3dOYU4gOiBmYWxzZTtcbiAgICBjb25zdCBhbGxvd0luZmluaXR5OiBib29sZWFuID0gb3B0aW9ucy5hbGxvd0luZmluaXR5ICE9PSB1bmRlZmluZWQgPyBvcHRpb25zLmFsbG93SW5maW5pdHkgOiBmYWxzZTtcblxuICAgIE9iamVjdC5hc3NpZ24odGhpcywge2FsbG93TmFOLCBhbGxvd0luZmluaXR5fSk7XG4gIH1cbn1cbiJdLCJzb3VyY2VSb290IjoiLi4vLi4ifQ==
