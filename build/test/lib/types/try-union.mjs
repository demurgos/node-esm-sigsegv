import { Incident } from "incident";
import { lazyProperties } from "../_helpers/lazy-properties";
import { createLazyOptionsError } from "../errors/lazy-options";
import { testError } from "../test-error";
export const name = "union";
export class TryUnionType {
    constructor(options) {
        this.name = name;
        this._options = options;
        if (typeof options !== "function") {
            this._applyOptions();
        }
        else {
            lazyProperties(this, this._applyOptions, ["variants"]);
        }
    }
    match(value) {
        for (const variant of this.variants) {
            if (variant.test(value)) {
                return variant;
            }
        }
        return undefined;
    }
    matchTrusted(value) {
        return this.match(value);
    }
    write(writer, value) {
        const variant = this.match(value);
        if (variant === undefined) {
            throw new Incident("UnknownUnionVariant", "Unknown union variant");
        }
        if (variant.write === undefined) {
            throw new Incident("NotWritable", { type: variant });
        }
        return variant.write(writer, value);
    }
    read(reader, raw) {
        return this.variantRead(reader, raw).value;
    }
    variantRead(reader, raw) {
        for (const variant of this.variants) {
            try {
                const value = variant.read(reader, raw);
                return { value, variant };
            }
            catch (err) {
                // TODO: Do not swallow all errors
            }
        }
        throw new Incident("InputVariantNotFound", { union: this, raw });
    }
    testError(value) {
        const variant = this.match(value);
        if (variant === undefined) {
            return new Incident("UnknownUnionVariant", "Unknown union variant");
        }
        return testError(variant, value);
    }
    test(val) {
        const type = this.match(val);
        if (type === undefined) {
            return false;
        }
        return type.test(val);
    }
    // TODO: Always return true?
    equals(val1, val2) {
        const type1 = this.matchTrusted(val1);
        const type2 = this.matchTrusted(val2);
        return type1 === type2 && type1.equals(val1, val2);
    }
    clone(val) {
        return this.matchTrusted(val).clone(val);
    }
    _applyOptions() {
        if (this._options === undefined) {
            throw createLazyOptionsError(this);
        }
        const options = typeof this._options === "function"
            ? this._options()
            : this._options;
        delete this._options;
        const variants = options.variants;
        Object.assign(this, { variants });
    }
}

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9saWIvdHlwZXMvdHJ5LXVuaW9uLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxVQUFVLENBQUM7QUFDcEMsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLDZCQUE2QixDQUFDO0FBRTdELE9BQU8sRUFBRSxzQkFBc0IsRUFBRSxNQUFNLHdCQUF3QixDQUFDO0FBQ2hFLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFHMUMsTUFBTSxDQUFDLE1BQU0sSUFBSSxHQUFTLE9BQU8sQ0FBQztBQWdCbEMsTUFBTSxPQUFPLFlBQVk7SUFNdkIsWUFBWSxPQUF3QztRQUwzQyxTQUFJLEdBQVMsSUFBSSxDQUFDO1FBTXpCLElBQUksQ0FBQyxRQUFRLEdBQUcsT0FBTyxDQUFDO1FBQ3hCLElBQUksT0FBTyxPQUFPLEtBQUssVUFBVSxFQUFFO1lBQ2pDLElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQztTQUN0QjthQUFNO1lBQ0wsY0FBYyxDQUNaLElBQUksRUFDSixJQUFJLENBQUMsYUFBYSxFQUNsQixDQUFDLFVBQVUsQ0FBQyxDQUNiLENBQUM7U0FDSDtJQUNILENBQUM7SUFFRCxLQUFLLENBQUMsS0FBUTtRQUNaLEtBQUssTUFBTSxPQUFPLElBQUksSUFBSSxDQUFDLFFBQVEsRUFBRTtZQUNuQyxJQUFJLE9BQU8sQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLEVBQUU7Z0JBQ3ZCLE9BQU8sT0FBTyxDQUFDO2FBQ2hCO1NBQ0Y7UUFDRCxPQUFPLFNBQVMsQ0FBQztJQUNuQixDQUFDO0lBRUQsWUFBWSxDQUFDLEtBQVE7UUFDbkIsT0FBTyxJQUFJLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBRSxDQUFDO0lBQzVCLENBQUM7SUFFRCxLQUFLLENBQUksTUFBaUIsRUFBRSxLQUFRO1FBQ2xDLE1BQU0sT0FBTyxHQUFrQixJQUFJLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDO1FB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QUUsRUFBQyxRQUFRLEVBQUMsQ0FBQyxDQUFDO0lBQ2xDLENBQUM7Q0FDRiIsImZpbGUiOiJsaWIvdHlwZXMvdHJ5LXVuaW9uLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5jaWRlbnQgfSBmcm9tIFwiaW5jaWRlbnRcIjtcbmltcG9ydCB7IGxhenlQcm9wZXJ0aWVzIH0gZnJvbSBcIi4uL19oZWxwZXJzL2xhenktcHJvcGVydGllc1wiO1xuaW1wb3J0IHsgSW9UeXBlLCBMYXp5LCBSZWFkZXIsIFR5cGUsIFZlcnNpb25lZFR5cGUsIFdyaXRlciB9IGZyb20gXCIuLi9jb3JlXCI7XG5pbXBvcnQgeyBjcmVhdGVMYXp5T3B0aW9uc0Vycm9yIH0gZnJvbSBcIi4uL2Vycm9ycy9sYXp5LW9wdGlvbnNcIjtcbmltcG9ydCB7IHRlc3RFcnJvciB9IGZyb20gXCIuLi90ZXN0LWVycm9yXCI7XG5cbmV4cG9ydCB0eXBlIE5hbWUgPSBcInVuaW9uXCI7XG5leHBvcnQgY29uc3QgbmFtZTogTmFtZSA9IFwidW5pb25cIjtcbmV4cG9ydCB0eXBlIERpZmYgPSBhbnk7XG5cbmV4cG9ydCBpbnRlcmZhY2UgVHJ5VW5pb25UeXBlT3B0aW9uczxULCBNIGV4dGVuZHMgVHlwZTxUPiA9IFR5cGU8VD4+IHtcbiAgdmFyaWFudHM6IE1bXTtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBWYXJpYW50VmFsdWU8VCwgSz4ge1xuICB2YXJpYW50OiBLO1xuICB2YWx1ZTogVDtcbn1cblxuZXhwb3J0IHR5cGUgVGVzdFdpdGhWYXJpYW50UmVzdWx0PFQ+ID1cbiAgW3RydWUsIFZlcnNpb25lZFR5cGU8VCwgYW55Pl1cbiAgfCBbZmFsc2UsIFZlcnNpb25lZFR5cGU8VCwgYW55PiB8IHVuZGVmaW5lZF07XG5cbmV4cG9ydCBjbGFzcyBUcnlVbmlvblR5cGU8VCwgTSBleHRlbmRzIFR5cGU8VD4gPSBUeXBlPFQ+PiBpbXBsZW1lbnRzIElvVHlwZTxUPiwgVHJ5VW5pb25UeXBlT3B0aW9uczxULCBNPiB7XG4gIHJlYWRvbmx5IG5hbWU6IE5hbWUgPSBuYW1lO1xuICByZWFkb25seSB2YXJpYW50cyE6IE1bXTtcblxuICBwcml2YXRlIF9vcHRpb25zPzogTGF6eTxUcnlVbmlvblR5cGVPcHRpb25zPFQsIE0+PjtcblxuICBjb25zdHJ1Y3RvcihvcHRpb25zOiBMYXp5PFRyeVVuaW9uVHlwZU9wdGlvbnM8VCwgTT4+KSB7XG4gICAgdGhpcy5fb3B0aW9ucyA9IG9wdGlvbnM7XG4gICAgaWYgKHR5cGVvZiBvcHRpb25zICE9PSBcImZ1bmN0aW9uXCIpIHtcbiAgICAgIHRoaXMuX2FwcGx5T3B0aW9ucygpO1xuICAgIH0gZWxzZSB7XG4gICAgICBsYXp5UHJvcGVydGllcyhcbiAgICAgICAgdGhpcyxcbiAgICAgICAgdGhpcy5fYXBwbHlPcHRpb25zLFxuICAgICAgICBbXCJ2YXJpYW50c1wiXSxcbiAgICAgICk7XG4gICAgfVxuICB9XG5cbiAgbWF0Y2godmFsdWU6IFQpOiBNIHwgdW5kZWZpbmVkIHtcbiAgICBmb3IgKGNvbnN0IHZhcmlhbnQgb2YgdGhpcy52YXJpYW50cykge1xuICAgICAgaWYgKHZhcmlhbnQudGVzdCh2YWx1ZSkpIHtcbiAgICAgICAgcmV0dXJuIHZhcmlhbnQ7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiB1bmRlZmluZWQ7XG4gIH1cblxuICBtYXRjaFRydXN0ZWQodmFsdWU6IFQpOiBNIHtcbiAgICByZXR1cm4gdGhpcy5tYXRjaCh2YWx1ZSkhO1xuICB9XG5cbiAgd3JpdGU8Vz4od3JpdGVyOiBXcml0ZXI8Vz4sIHZhbHVlOiBUKTogVyB7XG4gICAgY29uc3QgdmFyaWFudDogTSB8IHVuZGVmaW5lZCA9IHRoaXMubWF0Y2godmFsdWUpO1xuICAgIGlmICh2YXJpYW50ID09PSB1bmRlZmluZWQpIHtcbiAgICAgIHRocm93IG5ldyBJbmNpZGVudChcIlVua25vd25VbmlvblZhcmlhbnRcIiwgXCJVbmtub3duIHVuaW9uIHZhcmlhbnRcIik7XG4gICAgfVxuICAgIGlmICh2YXJpYW50LndyaXRlID09PSB1bmRlZmluZWQpIHtcbiAgICAgIHRocm93IG5ldyBJbmNpZGVudChcIk5vdFdyaXRhYmxlXCIsIHt0eXBlOiB2YXJpYW50fSk7XG4gICAgfVxuICAgIHJldHVybiB2YXJpYW50LndyaXRlKHdyaXRlciwgdmFsdWUpO1xuICB9XG5cbiAgcmVhZDxSPihyZWFkZXI6IFJlYWRlcjxSPiwgcmF3OiBSKTogVCB7XG4gICAgcmV0dXJuIHRoaXMudmFyaWFudFJlYWQocmVhZGVyLCByYXcpLnZhbHVlO1xuICB9XG5cbiAgdmFyaWFudFJlYWQ8Uj4ocmVhZGVyOiBSZWFkZXI8Uj4sIHJhdzogUik6IFZhcmlhbnRWYWx1ZTxULCBNPiB7XG4gICAgZm9yIChjb25zdCB2YXJpYW50IG9mIHRoaXMudmFyaWFudHMpIHtcbiAgICAgIHRyeSB7XG4gICAgICAgIGNvbnN0IHZhbHVlOiBUID0gdmFyaWFudC5yZWFkIShyZWFkZXIsIHJhdyk7XG4gICAgICAgIHJldHVybiB7dmFsdWUsIHZhcmlhbnR9O1xuICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgIC8vIFRPRE86IERvIG5vdCBzd2FsbG93IGFsbCBlcnJvcnNcbiAgICAgIH1cbiAgICB9XG4gICAgdGhyb3cgbmV3IEluY2lkZW50KFwiSW5wdXRWYXJpYW50Tm90Rm91bmRcIiwge3VuaW9uOiB0aGlzLCByYXd9KTtcbiAgfVxuXG4gIHRlc3RFcnJvcih2YWx1ZTogVCk6IEVycm9yIHwgdW5kZWZpbmVkIHtcbiAgICBjb25zdCB2YXJpYW50OiBNIHwgdW5kZWZpbmVkID0gdGhpcy5tYXRjaCh2YWx1ZSk7XG4gICAgaWYgKHZhcmlhbnQgPT09IHVuZGVmaW5lZCkge1xuICAgICAgcmV0dXJuIG5ldyBJbmNpZGVudChcIlVua25vd25VbmlvblZhcmlhbnRcIiwgXCJVbmtub3duIHVuaW9uIHZhcmlhbnRcIik7XG4gICAgfVxuICAgIHJldHVybiB0ZXN0RXJyb3IodmFyaWFudCwgdmFsdWUpO1xuICB9XG5cbiAgdGVzdCh2YWw6IFQpOiBib29sZWFuIHtcbiAgICBjb25zdCB0eXBlOiBNIHwgdW5kZWZpbmVkID0gdGhpcy5tYXRjaCh2YWwpO1xuICAgIGlmICh0eXBlID09PSB1bmRlZmluZWQpIHtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG4gICAgcmV0dXJuIHR5cGUudGVzdCh2YWwpO1xuICB9XG5cbiAgLy8gVE9ETzogQWx3YXlzIHJldHVybiB0cnVlP1xuICBlcXVhbHModmFsMTogVCwgdmFsMjogVCk6IGJvb2xlYW4ge1xuICAgIGNvbnN0IHR5cGUxOiBNID0gdGhpcy5tYXRjaFRydXN0ZWQodmFsMSk7XG4gICAgY29uc3QgdHlwZTI6IE0gPSB0aGlzLm1hdGNoVHJ1c3RlZCh2YWwyKTtcbiAgICByZXR1cm4gdHlwZTEgPT09IHR5cGUyICYmIHR5cGUxLmVxdWFscyh2YWwxLCB2YWwyKTtcbiAgfVxuXG4gIGNsb25lKHZhbDogVCk6IFQge1xuICAgIHJldHVybiB0aGlzLm1hdGNoVHJ1c3RlZCh2YWwpLmNsb25lKHZhbCk7XG4gIH1cblxuICBwcml2YXRlIF9hcHBseU9wdGlvbnMoKTogdm9pZCB7XG4gICAgaWYgKHRoaXMuX29wdGlvbnMgPT09IHVuZGVmaW5lZCkge1xuICAgICAgdGhyb3cgY3JlYXRlTGF6eU9wdGlvbnNFcnJvcih0aGlzKTtcbiAgICB9XG4gICAgY29uc3Qgb3B0aW9uczogVHJ5VW5pb25UeXBlT3B0aW9uczxULCBNPiA9IHR5cGVvZiB0aGlzLl9vcHRpb25zID09PSBcImZ1bmN0aW9uXCJcbiAgICAgID8gdGhpcy5fb3B0aW9ucygpXG4gICAgICA6IHRoaXMuX29wdGlvbnM7XG4gICAgZGVsZXRlIHRoaXMuX29wdGlvbnM7XG4gICAgY29uc3QgdmFyaWFudHM6IE1bXSA9IG9wdGlvbnMudmFyaWFudHM7XG4gICAgT2JqZWN0LmFzc2lnbih0aGlzLCB7dmFyaWFudHN9KTtcbiAgfVxufVxuIl0sInNvdXJjZVJvb3QiOiIuLi8uLiJ9
