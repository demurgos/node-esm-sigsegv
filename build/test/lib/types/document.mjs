import { Incident } from "incident";
import { lazyProperties } from "../_helpers/lazy-properties";
import { rename } from "../case-style";
import { createInvalidDocumentError } from "../errors/invalid-document";
import { createInvalidTypeError } from "../errors/invalid-type";
import { createLazyOptionsError } from "../errors/lazy-options";
import { createNotImplementedError } from "../errors/not-implemented";
import { readVisitor } from "../readers/read-visitor";
export const name = "document";
// We use an `any` cast because of the `properties` property.
// tslint:disable-next-line:variable-name
export const DocumentType = class {
    constructor(options) {
        this.name = name;
        this._options = options;
        if (typeof options !== "function") {
            this._applyOptions();
        }
        else {
            lazyProperties(this, this._applyOptions, ["noExtraKeys", "properties", "changeCase", "rename"]);
        }
    }
    /**
     * Map from serialized keys to the document keys
     */
    get outKeys() {
        if (this._outKeys === undefined) {
            this._outKeys = new Map();
            for (const key of Object.keys(this.properties)) {
                this._outKeys.set(this.getOutKey(key), key);
            }
        }
        return this._outKeys;
    }
    getOutKey(key) {
        if (typeof key !== "string") {
            throw new Error(`NonStringKey: ${key}`);
        }
        const descriptor = this.properties[key];
        if (descriptor.rename !== undefined) {
            return descriptor.rename;
        }
        else if (descriptor.changeCase !== undefined) {
            return rename(key, descriptor.changeCase);
        }
        if (this.rename !== undefined && this.rename[key] !== undefined) {
            return this.rename[key];
        }
        else if (this.changeCase !== undefined) {
            return rename(key, this.changeCase);
        }
        return key;
    }
    // TODO: Dynamically add with prototype?
    read(reader, raw) {
        return reader.readDocument(raw, readVisitor({
            fromMap: (input, keyReader, valueReader) => {
                const extra = new Set();
                const missing = new Set();
                for (const key in this.properties) {
                    const descriptor = this.properties[key];
                    if (!descriptor.optional) {
                        missing.add(key);
                    }
                }
                const invalid = new Map();
                const result = {}; // Object.create(null);
                for (const [rawKey, rawValue] of input) {
                    const outKey = keyReader.readString(rawKey, readVisitor({ fromString: (input) => input }));
                    const key = this.outKeys.get(outKey);
                    if (key === undefined) {
                        // Extra key
                        extra.add(outKey);
                        continue;
                    }
                    missing.delete(key);
                    const descriptor = this.properties[key];
                    // TODO: Update readers so `undefined` is impossible/not handled here
                    if (rawValue === undefined) {
                        if (descriptor.optional) {
                            result[key] = undefined;
                        }
                        else {
                            missing.add(key);
                        }
                        continue;
                    }
                    try {
                        result[key] = descriptor.type.read(valueReader, rawValue);
                    }
                    catch (err) {
                        invalid.set(key, err);
                    }
                }
                if (this.noExtraKeys && extra.size > 0 || missing.size > 0 || invalid.size > 0) {
                    throw createInvalidDocumentError({ extra, missing, invalid });
                }
                return result;
            },
        }));
    }
    // TODO: Dynamically add with prototype?
    write(writer, value) {
        const outKeys = new Map(this.outKeys);
        for (const [outKey, jskey] of outKeys) {
            if (value[jskey] === undefined) {
                outKeys.delete(outKey);
            }
        }
        return writer.writeDocument(outKeys.keys(), (outKey, fieldWriter) => {
            const jsKey = this.outKeys.get(outKey);
            const descriptor = this.properties[jsKey];
            if (descriptor.type.write === undefined) {
                throw new Incident("NotWritable", { type: descriptor.type });
            }
            return descriptor.type.write(fieldWriter, value[jsKey]);
        });
    }
    testError(val) {
        if (typeof val !== "object" || val === null) {
            return createInvalidTypeError("object", val);
        }
        const extra = this.noExtraKeys ? new Set(Object.keys(val)) : undefined;
        const missing = new Set();
        const invalid = new Map();
        for (const key in this.properties) {
            if (extra !== undefined) {
                extra.delete(key);
            }
            const descriptor = this.properties[key];
            const propertyValue = val[key];
            if (propertyValue === undefined) {
                if (!descriptor.optional) {
                    missing.add(key);
                }
                continue;
            }
            const error = descriptor.type.testError(propertyValue);
            if (error !== undefined) {
                invalid.set(key, error);
            }
        }
        if (extra !== undefined && extra.size > 0 || missing.size > 0 || invalid.size > 0) {
            return createInvalidDocumentError({ extra, missing, invalid });
        }
        return undefined;
    }
    test(val) {
        if (typeof val !== "object" || val === null) {
            return false;
        }
        const extra = this.noExtraKeys ? new Set(Object.keys(val)) : undefined;
        for (const key in this.properties) {
            if (extra !== undefined) {
                extra.delete(key);
            }
            const descriptor = this.properties[key];
            const propertyValue = val[key];
            if (propertyValue === undefined) {
                if (!descriptor.optional) {
                    return false;
                }
            }
            else if (!descriptor.type.test(propertyValue)) {
                return false;
            }
        }
        return extra === undefined || extra.size === 0;
    }
    equals(val1, val2) {
        for (const key in this.properties) {
            const descriptor = this.properties[key];
            if (!descriptor.optional) {
                if (!descriptor.type.equals(val1[key], val2[key])) {
                    return false;
                }
                continue;
            }
            if (val1[key] === undefined && val2[key] === undefined) {
                continue;
            }
            if (val1[key] === undefined || val2[key] === undefined || !descriptor.type.equals(val1[key], val2[key])) {
                return false;
            }
        }
        return true;
    }
    clone(val) {
        const result = {}; // Object.create(null);
        for (const key in this.properties) {
            result[key] = val[key] === undefined ? undefined : this.properties[key].type.clone(val[key]);
        }
        return result;
    }
    diff(oldVal, newVal) {
        let equal = true;
        const result = { set: {}, unset: {}, update: {} };
        for (const key in this.properties) {
            // TODO: Remove cast
            const descriptor = this.properties[key];
            const oldMember = oldVal[key];
            const newMember = newVal[key];
            if (oldMember !== undefined) {
                if (newMember !== undefined) {
                    const diff = descriptor.type.diff(oldMember, newMember);
                    if (diff !== undefined) {
                        result.update[key] = diff;
                        equal = false;
                    }
                }
                else {
                    result.unset[key] = descriptor.type.clone(oldMember);
                    equal = false;
                }
            }
            else {
                if (newMember === undefined) {
                    result.set[key] = descriptor.type.clone(newMember);
                    equal = false;
                }
            }
        }
        return equal ? undefined : result;
    }
    patch(oldVal, diff) {
        const result = this.clone(oldVal);
        if (diff === undefined) {
            return result;
        }
        for (const key in diff.set) {
            result[key] = this.properties[key].type.clone(diff.set[key]);
        }
        for (const key in diff.unset) {
            Reflect.deleteProperty(result, key);
        }
        for (const key in diff.update) {
            // TODO: Remove cast
            result[key] = this.properties[key].type.patch(result[key], diff.update[key]);
        }
        return result;
    }
    reverseDiff(diff) {
        if (diff === undefined) {
            return undefined;
        }
        const result = { set: {}, unset: {}, update: {} };
        for (const key in diff.unset) {
            result.set[key] = this.properties[key].type.clone(diff.unset[key]);
        }
        for (const key in diff.set) {
            result.unset[key] = this.properties[key].type.clone(diff.set[key]);
        }
        for (const key in diff.update) {
            // TODO: Remove cast
            result.update[key] = this.properties[key].type.reverseDiff(diff.update[key]);
        }
        return result;
    }
    squash(_diff1, _diff2) {
        throw createNotImplementedError("DocumentType#squash");
    }
    _applyOptions() {
        if (this._options === undefined) {
            throw createLazyOptionsError(this);
        }
        const options = typeof this._options === "function" ?
            this._options() :
            this._options;
        const noExtraKeys = options.noExtraKeys;
        const properties = options.properties;
        const rename = options.rename;
        const changeCase = options.changeCase;
        Object.assign(this, { noExtraKeys, properties, rename, changeCase });
    }
};
export function renameKeys(obj, renameAll) {
    const keys = Object.keys(obj);
    const result = new Map();
    const outKeys = new Set();
    for (const key of keys) {
        const renamed = renameAll === undefined ? key : rename(key, renameAll);
        result.set(key, renamed);
        if (outKeys.has(renamed)) {
            throw new Incident("NonBijectiveKeyRename", "Some keys are the same after renaming");
        }
        outKeys.add(renamed);
    }
    return result;
}

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9saWIvdHlwZXMvZG9jdW1lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFFBQVEsRUFBRSxNQUFNLFVBQVUsQ0FBQztBQUNwQyxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sNkJBQTZCLENBQUM7QUFDN0QsT0FBTyxFQUFhLE1BQU0sRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUVsRCxPQUFPLEVBQUUsMEJBQTBCLEVBQUUsTUFBTSw0QkFBNEIsQ0FBQztBQUN4RSxPQUFPLEVBQUUsc0JBQXNCLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQztBQUNoRSxPQUFPLEVBQUUsc0JBQXNCLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQztBQUNoRSxPQUFPLEVBQUUseUJBQXlCLEVBQUUsTUFBTSwyQkFBMkIsQ0FBQztBQUN0RSxPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0seUJBQXlCLENBQUM7QUFHdEQsTUFBTSxDQUFDLE1BQU0sSUFBSSxHQUFTLFVBQVUsQ0FBQztBQWtGckMsNkRBQTZEO0FBQzdELHlDQUF5QztBQUN6QyxNQUFNLENBQUMsTUFBTSxZQUFZLEdBQWtDO0lBVXpELFlBQVksT0FBcUM7UUFSeEMsU0FBSSxHQUFTLElBQUksQ0FBQztRQVN6QixJQUFJLENBQUMsUUFBUSxHQUFHLE9BQU8sQ0FBQztRQUN4QixJQUFJLE9BQU8sT0FBTyxLQUFLLFVBQVUsRUFBRTtZQUNqQyxJQUFJLENBQUMsYUFBYSxFQUFFLENBQUM7U0FDdEI7YUFBTTtZQUNMLGNBQWMsQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFDLGFBQWEsRUFBRSxZQUFZLEVBQUUsWUFBWSxFQUFFLFFBQXNCLENBQUMsQ0FBQyxDQUFDO1NBQy9HO0lBQ0gsQ0FBQztJQUVEOztPQUVHO0lBQ0gsSUFBSSxPQUFPO1FBQ1QsSUFBSSxJQUFJLENBQUMsUUFBUSxLQUFLLFNBQVMsRUFBRTtZQUMvQixJQUFJLENBQUMsUUFBUSxHQUFHLElBQUksR0FBRyxFQUFFLENBQUM7WUFDMUIsS0FBSyxNQUFNLEdBQUcsSUFBSSxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQWdCLEVBQUU7Z0JBQzdELElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDLEVBQUUsR0FBRyxDQUFDLENBQUM7YUFDN0M7U0FDRjtRQUNELE9BQU8sSUFBSSxDQUFDLFFBQVEsQ0FBQztJQUN2QixDQUFDO0lBRUQsU0FBUyxDQUFDLEdBQVk7UUFDcEIsSUFBSSxPQUFPLEdBQUcsS0FBSyxRQUFRLEVBQUU7WUFDM0IsTUFBTSxJQUFJLEtBQUssQ0FBQyxpQkFBaUIsR0FBRyxFQUFFLENBQUMsQ0FBQztTQUN6QztRQUNELE1BQU0sVUFBVSxHQUE0QixJQUFJLENBQUMsVUFBVSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQ2pFLElBQUksVUFBVSxDQUFDLE1BQU0sS0FBSyxTQUFTLEVBQUU7WUFDbkMsT0FBTyxVQUFVLENBQUMsTUFBTSxDQUFDO1NBQzFCO2FBQU0sSUFBSSxVQUFVLENBQUMsVUFBVSxLQUFLLFNBQVMsRUFBRTtZQUM5QyxPQUFPLE1BQU0sQ0FBQyxHQUFhLEVBQUUsVUFBVSxDQUFDLFVBQVUsQ0FBQyxDQUFDO1NBQ3JEO1FBQ0QsSUFBSSxJQUFJLENBQUMsTUFBTSxLQUFLLFNBQVMsSUFBSSxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxLQUFLLFNBQVMsRUFBRTtZQUMvRCxPQUFPLElBQUksQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFFLENBQUM7U0FDMUI7YUFBTSxJQUFJLElBQUksQ0FBQyxVQUFVLEtBQUssU0FBUyxFQUFFO1lBQ3hDLE9BQU8sTUFBTSxDQUFDLEdBQWEsRUFBRSxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUM7U0FDL0M7UUFDRCxPQUFPLEdBQUcsQ0FBQztJQUNiLENBQUM7SUFFRCx3Q0FBd0M7SUFDeEMsSUFBSSxDQUFJLE1BQWlCLEVBQUUsR0FBTTtRQUMvQixPQUFPLE1BQU0sQ0FBQyxZQUFZLENBQUMsR0FBRyxFQUFFLFdBQVcsQ0FBQztZQUMxQyxPQUFPLEVBQUUsQ0FBUyxLQUFrQixFQUFFLFNBQXFCLEVBQUUsV0FBdUIsRUFBSyxFQUFFO2dCQUN6RixNQUFNLEtBQUssR0FBZ0IsSUFBSSxHQUFHLEVBQUUsQ0FBQztnQkFDckMsTUFBTSxPQUFPLEdBQWdCLElBQUksR0FBRyxFQUFFLENBQUM7Z0JBQ3ZDLEtBQUssTUFBTSxHQUFHLElBQUksSUFBSSxDQUFDLFVBQVUsRUFBRTtvQkFDakMsTUFBTSxVQUFVLEdBQTRCLElBQUksQ0FBQyxVQUFVLENBQUMsR0FBRyxDQUFDLENBQUM7b0JBQ2pFLElBQUksQ0FBQyxVQUFVLENBQUMsUUFBUSxFQUFFO3dCQUN4QixPQUFPLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFDO3FCQUNsQjtpQkFDRjtnQkFDRCxNQUFNLE9BQU8sR0FBdUIsSUFBSSxHQUFHLEVBQUUsQ0FBQztnQkFDOUMsTUFBTSxNQUFNLEdBQWUsRUFBRSxDQUFDLENBQUMsdUJBQXVCO2dCQUV0RCxLQUFLLE1BQU0sQ0FBQyxNQUFNLEVBQUUsUUFBUSxDQUFDLElBQUksS0FBSyxFQUFFO29CQUN0QyxNQUFNLE1BQU0sR0FBVyxTQUFTLENBQUMsVUFBVSxDQUN6QyxNQUFNLEVBQ04sV0FBVyxDQUFDLEVBQUMsVUFBVSxFQUFFLENBQUMsS0FBYSxFQUFXLEVBQUUsQ0FBQyxLQUFLLEVBQUMsQ0FBQyxDQUM3RCxDQUFDO29CQUNGLE1BQU0sR0FBRyxHQUF3QixJQUFJLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsQ0FBQztvQkFDMUQsSUFBSSxHQUFHLEtBQUssU0FBUyxFQUFFO3dCQUNyQixZQUFZO3dCQUNaLEtBQUssQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLENBQUM7d0JBQ2xCLFNBQVM7cUJBQ1Y7b0JBQ0QsT0FBTyxDQUFDLE1BQU0sQ0FBQyxHQUFhLENBQUMsQ0FBQztvQkFDOUIsTUFBTSxVQUFVLEdBQTRCLElBQUksQ0FBQyxVQUFVLENBQUMsR0FBRyxDQUFDLENBQUM7b0JBQ2pFLHFFQUFxRTtvQkFDckUsSUFBSSxRQUFRLEtBQUssU0FBUyxFQUFFO3dCQUMxQixJQUFJLFVBQVUsQ0FBQyxRQUFRLEVBQUU7NEJBQ3ZCLE1BQU0sQ0FBQyxHQUFHLENBQUMsR0FBRyxTQUFTLENBQUM7eUJBQ3pCOzZCQUFNOzRCQUNMLE9BQU8sQ0FBQyxHQUFHLENBQUMsR0FBYSxDQUFDLENBQUM7eUJBQzVCO3dCQUNELFNBQVM7cUJBQ1Y7b0JBQ0QsSUFBSTt3QkFDRixNQUFNLENBQUMsR0FBRyxDQUFDLEdBQUcsVUFBVSxDQUFDLElBQUksQ0FBQyxJQUFLLENBQUMsV0FBVyxFQUFFLFFBQVEsQ0FBQyxDQUFDO3FCQUM1RDtvQkFBQyxPQUFPLEdBQUcsRUFBRTt3QkFDWixPQUFPLENBQUMsR0FBRyxDQUFDLEdBQWEsRUFBRSxHQUFHLENBQUMsQ0FBQztxQkFDakM7aUJBQ0Y7Z0JBRUQsSUFBSSxJQUFJLENBQUMsV0FBVyxJQUFJLEtBQUssQ0FBQyxJQUFJLEdBQUcsQ0FBQyxJQUFJLE9BQU8sQ0FBQyxJQUFJLEdBQUcsQ0FBQyxJQUFJLE9BQU8sQ0FBQyxJQUFJLEdBQUcsQ0FBQyxFQUFFO29CQUM5RSxNQUFNLDBCQUEwQixDQUFDLEVBQUMsS0FBSyxFQUFFLE9BQU8sRUFBRSxPQUFPLEVBQUMsQ0FBQyxDQUFDO2lCQUM3RDtnQkFDRCxPQUFPLE1BQVcsQ0FBQztZQUNyQixDQUFDO1NBQ0YsQ0FBQyxDQUFDLENBQUM7SUFDTixDQUFDO0lBRUQsd0NBQXdDO0lBQ3hDLEtBQUssQ0FBSSxNQUFpQixFQUFFLEtBQVE7UUFDbEMsTUFBTSxPQUFPLEdBQXlCLElBQUksR0FBRyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUU1RCxLQUFLLE1BQU0sQ0FBQyxNQUFNLEVBQUUsS0FBSyxDQUFDLElBQUksT0FBTyxFQUFFO1lBQ3JDLElBQUksS0FBSyxDQUFDLEtBQUssQ0FBQyxLQUFLLFNBQVMsRUFBRTtnQkFDOUIsT0FBTyxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQzthQUN4QjtTQUNGO1FBRUQsT0FBTyxNQUFNLENBQUMsYUFBYSxDQUFDLE9BQU8sQ0FBQyxJQUFJLEVBQUUsRUFBRSxDQUFLLE1BQWMsRUFBRSxXQUF1QixFQUFNLEVBQUU7WUFDOUYsTUFBTSxLQUFLLEdBQVksSUFBSSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFFLENBQUM7WUFDakQsTUFBTSxVQUFVLEdBQTRCLElBQUksQ0FBQyxVQUFVLENBQUMsS0FBSyxDQUFDLENBQUM7WUFDbkUsSUFBSSxVQUFVLENBQUMsSUFBSSxDQUFDLEtBQUssS0FBSyxTQUFTLEVBQUU7Z0JBQ3ZDLE1BQU0sSUFBSSxRQUFRLENBQUMsYUFBYSxFQUFFLEVBQUMsSUFBSSxFQUFFLFVBQVUsQ0FBQyxJQUFJLEVBQUMsQ0FBQyxDQUFDO2FBQzVEO1lBQ0QsT0FBTyxVQUFVLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxXQUFXLEVBQUUsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUM7UUFDMUQsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDO0lBRUQsU0FBUyxDQUFDLEdBQU07UUFDZCxJQUFJLE9BQU8sR0FBRyxLQUFLLFFBQVEsSUFBSSxHQUFHLEtBQUssSUFBSSxFQUFFO1lBQzNDLE9BQU8sc0JBQXNCLENBQUMsUUFBUSxFQUFFLEdBQUcsQ0FBQyxDQUFDO1NBQzlDO1FBRUQsTUFBTSxLQUFLLEdBQTRCLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDLElBQUksR0FBRyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFDO1FBQ2hHLE1BQU0sT0FBTyxHQUFnQixJQUFJLEdBQUcsRUFBRSxDQUFDO1FBQ3ZDLE1BQU0sT0FBTyxHQUF1QixJQUFJLEdBQUcsRUFBRSxDQUFDO1FBRTlDLEtBQUssTUFBTSxHQUFHLElBQUksSUFBSSxDQUFDLFVBQVUsRUFBRTtZQUNqQyxJQUFJLEtBQUssS0FBSyxTQUFTLEVBQUU7Z0JBQ3ZCLEtBQUssQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUM7YUFDbkI7WUFDRCxNQUFNLFVBQVUsR0FBNEIsSUFBSSxDQUFDLFVBQVUsQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUNqRSxNQUFNLGFBQWEsR0FBUSxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUM7WUFDcEMsSUFBSSxhQUFhLEtBQUssU0FBUyxFQUFFO2dCQUMvQixJQUFJLENBQUMsVUFBVSxDQUFDLFFBQVEsRUFBRTtvQkFDeEIsT0FBTyxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQztpQkFDbEI7Z0JBQ0QsU0FBUzthQUNWO1lBQ0QsTUFBTSxLQUFLLEdBQXNCLFVBQVUsQ0FBQyxJQUFJLENBQUMsU0FBVSxDQUFDLGFBQWEsQ0FBQyxDQUFDO1lBQzNFLElBQUksS0FBSyxLQUFLLFNBQVMsRUFBRTtnQkFDdkIsT0FBTyxDQUFDLEdBQUcsQ0FBQyxHQUFhLEVBQUUsS0FBSyxDQUFDLENBQUM7YUFDbkM7U0FDRjtRQUVELElBQUksS0FBSyxLQUFLLFNBQVMsSUFBSSxLQUFLLENBQUMsSUFBSSxHQUFHLENBQUMsSUFBSSxPQUFPLENBQUMsSUFBSSxHQUFHLENBQUMsSUFBSSxPQUFPLENBQUMsSUFBSSxHQUFHLENBQUMsRUFBRTtZQUNqRixPQUFPLDBCQUEwQixDQUFDLEVBQUMsS0FBSyxFQUFFLE9BQU8sRUFBRSxPQUFPLEVBQUMsQ0FBQyxDQUFDO1NBQzlEO1FBQ0QsT0FBTyxTQUFTLENBQUM7SUFDbkIsQ0FBQztJQUVELElBQUksQ0FBQyxHQUFNO1FBQ1QsSUFBSSxPQUFPLEdBQUcsS0FBSyxRQUFRLElBQUksR0FBRyxLQUFLLElBQUksRUFBRTtZQUMzQyxPQUFPLEtBQUssQ0FBQztTQUNkO1FBRUQsTUFBTSxLQUFLLEdBQTRCLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDLElBQUksR0FBRyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFDO1FBRWhHLEtBQUssTUFBTSxHQUFHLElBQUksSUFBSSxDQUFDLFVBQVUsRUFBRTtZQUNqQyxJQUFJLEtBQUssS0FBSyxTQUFTLEVBQUU7Z0JBQ3ZCLEtBQUssQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUM7YUFDbkI7WUFDRCxNQUFNLFVBQVUsR0FBNEIsSUFBSSxDQUFDLFVBQVUsQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUNqRSxNQUFNLGFBQWEsR0FBUSxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUM7WUFDcEMsSUFBSSxhQUFhLEtBQUssU0FBUyxFQUFFO2dCQUMvQixJQUFJLENBQUMsVUFBVSxDQUFDLFFBQVEsRUFBRTtvQkFDeEIsT0FBTyxLQUFLLENBQUM7aUJBQ2Q7YUFDRjtpQkFBTSxJQUFJLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLEVBQUU7Z0JBQy9DLE9BQU8sS0FBSyxDQUFDO2FBQ2Q7U0FDRjtRQUVELE9BQU8sS0FBSyxLQUFLLFNBQVMsSUFBSSxLQUFLLENBQUMsSUFBSSxLQUFLLENBQUMsQ0FBQztJQUNqRCxDQUFDO0lBRUQsTUFBTSxDQUFDLElBQU8sRUFBRSxJQUFPO1FBQ3JCLEtBQUssTUFBTSxHQUFHLElBQUksSUFBSSxDQUFDLFVBQVUsRUFBRTtZQUNqQyxNQUFNLFVBQVUsR0FBNEIsSUFBSSxDQUFDLFVBQVUsQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUNqRSxJQUFJLENBQUMsVUFBVSxDQUFDLFFBQVEsRUFBRTtnQkFDeEIsSUFBSSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsRUFBRTtvQkFDakQsT0FBTyxLQUFLLENBQUM7aUJBQ2Q7Z0JBQ0QsU0FBUzthQUNWO1lBQ0QsSUFBSSxJQUFJLENBQUMsR0FBRyxDQUFDLEtBQUssU0FBUyxJQUFJLElBQUksQ0FBQyxHQUFHLENBQUMsS0FBSyxTQUFTLEVBQUU7Z0JBQ3RELFNBQVM7YUFDVjtZQUNELElBQUksSUFBSSxDQUFDLEdBQUcsQ0FBQyxLQUFLLFNBQVMsSUFBSSxJQUFJLENBQUMsR0FBRyxDQUFDLEtBQUssU0FBUyxJQUFJLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxFQUFFO2dCQUN2RyxPQUFPLEtBQUssQ0FBQzthQUNkO1NBQ0Y7UUFDRCxPQUFPLElBQUksQ0FBQztJQUNkLENBQUM7SUFFRCxLQUFLLENBQUMsR0FBTTtRQUNWLE1BQU0sTUFBTSxHQUFlLEVBQUUsQ0FBQyxDQUFDLHVCQUF1QjtRQUN0RCxLQUFLLE1BQU0sR0FBRyxJQUFJLElBQUksQ0FBQyxVQUFVLEVBQUU7WUFDakMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxHQUFHLEdBQUcsQ0FBQyxHQUFHLENBQUMsS0FBSyxTQUFTLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO1NBQzlGO1FBQ0QsT0FBTyxNQUFXLENBQUM7SUFDckIsQ0FBQztJQUVELElBQUksQ0FBQyxNQUFTLEVBQUUsTUFBUztRQUN2QixJQUFJLEtBQUssR0FBWSxJQUFJLENBQUM7UUFDMUIsTUFBTSxNQUFNLEdBQVksRUFBQyxHQUFHLEVBQUUsRUFBRSxFQUFFLEtBQUssRUFBRSxFQUFFLEVBQUUsTUFBTSxFQUFFLEVBQUUsRUFBQyxDQUFDO1FBQ3pELEtBQUssTUFBTSxHQUFHLElBQUksSUFBSSxDQUFDLFVBQVUsRUFBRTtZQUNqQyxvQkFBb0I7WUFDcEIsTUFBTSxVQUFVLEdBQTJELElBQUksQ0FBQyxVQUFVLENBQUMsR0FBRyxDQUFDLENBQUM7WUFDaEcsTUFBTSxTQUFTLEdBQWUsTUFBTyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1lBQzNDLE1BQU0sU0FBUyxHQUFlLE1BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUMzQyxJQUFJLFNBQVMsS0FBSyxTQUFTLEVBQUU7Z0JBQzNCLElBQUksU0FBUyxLQUFLLFNBQVMsRUFBRTtvQkFDM0IsTUFBTSxJQUFJLEdBQVEsVUFBVSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxFQUFFLFNBQVMsQ0FBQyxDQUFDO29CQUM3RCxJQUFJLElBQUksS0FBSyxTQUFTLEVBQUU7d0JBQ3RCLE1BQU0sQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLEdBQUcsSUFBSSxDQUFDO3dCQUMxQixLQUFLLEdBQUcsS0FBSyxDQUFDO3FCQUNmO2lCQUNGO3FCQUFNO29CQUNMLE1BQU0sQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLEdBQUcsVUFBVSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsU0FBUyxDQUFDLENBQUM7b0JBQ3JELEtBQUssR0FBRyxLQUFLLENBQUM7aUJBQ2Y7YUFDRjtpQkFBTTtnQkFDTCxJQUFJLFNBQVMsS0FBSyxTQUFTLEVBQUU7b0JBQzNCLE1BQU0sQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLEdBQUcsVUFBVSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsU0FBUyxDQUFDLENBQUM7b0JBQ25ELEtBQUssR0FBRyxLQUFLLENBQUM7aUJBQ2Y7YUFDRjtTQUNGO1FBQ0QsT0FBTyxLQUFLLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDO0lBQ3BDLENBQUM7SUFFRCxLQUFLLENBQUMsTUFBUyxFQUFFLElBQXlCO1FBQ3hDLE1BQU0sTUFBTSxHQUFNLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLENBQUM7UUFDckMsSUFBSSxJQUFJLEtBQUssU0FBUyxFQUFFO1lBQ3RCLE9BQU8sTUFBTSxDQUFDO1NBQ2Y7UUFDRCxLQUFLLE1BQU0sR0FBRyxJQUFJLElBQUksQ0FBQyxHQUFHLEVBQUU7WUFDMUIsTUFBTSxDQUFDLEdBQUcsQ0FBQyxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7U0FDOUQ7UUFDRCxLQUFLLE1BQU0sR0FBRyxJQUFJLElBQUksQ0FBQyxLQUFLLEVBQUU7WUFDNUIsT0FBTyxDQUFDLGNBQWMsQ0FBQyxNQUF1QixFQUFFLEdBQUcsQ0FBQyxDQUFDO1NBQ3REO1FBQ0QsS0FBSyxNQUFNLEdBQUcsSUFBSSxJQUFJLENBQUMsTUFBTSxFQUFFO1lBQzdCLG9CQUFvQjtZQUNwQixNQUFNLENBQUMsR0FBRyxDQUFDLEdBQUksSUFBSSxDQUFDLFVBQVUsQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFZLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsRUFBRSxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7U0FDdkY7UUFDRCxPQUFPLE1BQU0sQ0FBQztJQUNoQixDQUFDO0lBRUQsV0FBVyxDQUFDLElBQXlCO1FBQ25DLElBQUksSUFBSSxLQUFLLFNBQVMsRUFBRTtZQUN0QixPQUFPLFNBQVMsQ0FBQztTQUNsQjtRQUNELE1BQU0sTUFBTSxHQUFZLEVBQUMsR0FBRyxFQUFFLEVBQUUsRUFBRSxLQUFLLEVBQUUsRUFBRSxFQUFFLE1BQU0sRUFBRSxFQUFFLEVBQUMsQ0FBQztRQUN6RCxLQUFLLE1BQU0sR0FBRyxJQUFJLElBQUksQ0FBQyxLQUFLLEVBQUU7WUFDNUIsTUFBTSxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO1NBQ3BFO1FBQ0QsS0FBSyxNQUFNLEdBQUcsSUFBSSxJQUFJLENBQUMsR0FBRyxFQUFFO1lBQzFCLE1BQU0sQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztTQUNwRTtRQUNELEtBQUssTUFBTSxHQUFHLElBQUksSUFBSSxDQUFDLE1BQU0sRUFBRTtZQUM3QixvQkFBb0I7WUFDcEIsTUFBTSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsR0FBSSxJQUFJLENBQUMsVUFBVSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQVksQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO1NBQ3ZGO1FBQ0QsT0FBTyxNQUFNLENBQUM7SUFDaEIsQ0FBQztJQUVELE1BQU0sQ0FBQyxNQUEyQixFQUFFLE1BQTJCO1FBQzdELE1BQU0seUJBQXlCLENBQUMscUJBQXFCLENBQUMsQ0FBQztJQUN6RCxDQUFDO0lBRU8sYUFBYTtRQUNuQixJQUFJLElBQUksQ0FBQyxRQUFRLEtBQUssU0FBUyxFQUFFO1lBQy9CLE1BQU0sc0JBQXNCLENBQUMsSUFBSSxDQUFDLENBQUM7U0FDcEM7UUFDRCxNQUFNLE9BQU8sR0FBMkIsT0FBTyxJQUFJLENBQUMsUUFBUSxLQUFLLFVBQVUsQ0FBQyxDQUFDO1lBQzNFLElBQUksQ0FBQyxRQUFRLEVBQUUsQ0FBQyxDQUFDO1lBQ2pCLElBQUksQ0FBQyxRQUFRLENBQUM7UUFFaEIsTUFBTSxXQUFXLEdBQXdCLE9BQU8sQ0FBQyxXQUFXLENBQUM7UUFDN0QsTUFBTSxVQUFVLEdBQThDLE9BQU8sQ0FBQyxVQUFVLENBQUM7UUFDakYsTUFBTSxNQUFNLEdBQTBDLE9BQU8sQ0FBQyxNQUFNLENBQUM7UUFDckUsTUFBTSxVQUFVLEdBQTBCLE9BQU8sQ0FBQyxVQUFVLENBQUM7UUFFN0QsTUFBTSxDQUFDLE1BQU0sQ0FBQyxJQUFJLEVBQUUsRUFBQyxXQUFXLEVBQUUsVUFBVSxFQUFFLE1BQU0sRUFBRSxVQUFVLEVBQUMsQ0FBQyxDQUFDO0lBQ3JFLENBQUM7Q0FDRixDQUFDO0FBRUYsTUFBTSxVQUFVLFVBQVUsQ0FBSSxHQUFNLEVBQUUsU0FBcUI7SUFDekQsTUFBTSxJQUFJLEdBQWEsTUFBTSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUN4QyxNQUFNLE1BQU0sR0FBeUIsSUFBSSxHQUFHLEVBQUUsQ0FBQztJQUMvQyxNQUFNLE9BQU8sR0FBZ0IsSUFBSSxHQUFHLEVBQUUsQ0FBQztJQUN2QyxLQUFLLE1BQU0sR0FBRyxJQUFJLElBQUksRUFBRTtRQUN0QixNQUFNLE9BQU8sR0FBVyxTQUFTLEtBQUssU0FBUyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxHQUFHLEVBQUUsU0FBUyxDQUFDLENBQUM7UUFDL0UsTUFBTSxDQUFDLEdBQUcsQ0FBQyxHQUFjLEVBQUUsT0FBTyxDQUFDLENBQUM7UUFDcEMsSUFBSSxPQUFPLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxFQUFFO1lBQ3hCLE1BQU0sSUFBSSxRQUFRLENBQUMsdUJBQXVCLEVBQUUsdUNBQXVDLENBQUMsQ0FBQztTQUN0RjtRQUNELE9BQU8sQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLENBQUM7S0FDdEI7SUFDRCxPQUFPLE1BQU0sQ0FBQztBQUNoQixDQUFDIiwiZmlsZSI6ImxpYi90eXBlcy9kb2N1bWVudC5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluY2lkZW50IH0gZnJvbSBcImluY2lkZW50XCI7XG5pbXBvcnQgeyBsYXp5UHJvcGVydGllcyB9IGZyb20gXCIuLi9faGVscGVycy9sYXp5LXByb3BlcnRpZXNcIjtcbmltcG9ydCB7IENhc2VTdHlsZSwgcmVuYW1lIH0gZnJvbSBcIi4uL2Nhc2Utc3R5bGVcIjtcbmltcG9ydCB7IElvVHlwZSwgTGF6eSwgUmVhZGVyLCBUeXBlLCBWZXJzaW9uZWRUeXBlLCBXcml0ZXIgfSBmcm9tIFwiLi4vY29yZVwiO1xuaW1wb3J0IHsgY3JlYXRlSW52YWxpZERvY3VtZW50RXJyb3IgfSBmcm9tIFwiLi4vZXJyb3JzL2ludmFsaWQtZG9jdW1lbnRcIjtcbmltcG9ydCB7IGNyZWF0ZUludmFsaWRUeXBlRXJyb3IgfSBmcm9tIFwiLi4vZXJyb3JzL2ludmFsaWQtdHlwZVwiO1xuaW1wb3J0IHsgY3JlYXRlTGF6eU9wdGlvbnNFcnJvciB9IGZyb20gXCIuLi9lcnJvcnMvbGF6eS1vcHRpb25zXCI7XG5pbXBvcnQgeyBjcmVhdGVOb3RJbXBsZW1lbnRlZEVycm9yIH0gZnJvbSBcIi4uL2Vycm9ycy9ub3QtaW1wbGVtZW50ZWRcIjtcbmltcG9ydCB7IHJlYWRWaXNpdG9yIH0gZnJvbSBcIi4uL3JlYWRlcnMvcmVhZC12aXNpdG9yXCI7XG5cbmV4cG9ydCB0eXBlIE5hbWUgPSBcImRvY3VtZW50XCI7XG5leHBvcnQgY29uc3QgbmFtZTogTmFtZSA9IFwiZG9jdW1lbnRcIjtcblxuZXhwb3J0IGludGVyZmFjZSBEaWZmPFQ+IHtcbiAgc2V0OiB7W1AgaW4ga2V5b2YgVF0/OiBhbnl9OyAvLyB2YWxcbiAgdXBkYXRlOiB7W1AgaW4ga2V5b2YgVF0/OiBhbnl9OyAvLyBkaWZmXG4gIHVuc2V0OiB7W1AgaW4ga2V5b2YgVF0/OiBhbnl9OyAvLyB2YWxcbn1cblxuZXhwb3J0IGludGVyZmFjZSBEb2N1bWVudFR5cGVPcHRpb25zPFQ+IHtcbiAgLyoqXG4gICAqIFRyZWF0IHZhbHVlcyB3aXRoIGV4dHJhIGtleXMgYXMgaW52YWxpZC5cbiAgICovXG4gIG5vRXh0cmFLZXlzPzogYm9vbGVhbjtcblxuICAvKipcbiAgICogQSBkaWN0aW9uYXJ5IGJldHdlZW4gYSBwcm9wZXJ0eSBuYW1lIGFuZCBpdHMgZGVzY3JpcHRpb24uXG4gICAqL1xuICBwcm9wZXJ0aWVzOiB7cmVhZG9ubHkgW1AgaW4ga2V5b2YgVF06IFByb3BlcnR5RGVzY3JpcHRvcjxUW1BdLCBUeXBlPFRbUF0+Pn07XG5cbiAgLyoqXG4gICAqIFRoZSBrZXlzIG9mIHRoZSBzZXJpYWxpemVkIGRvY3VtZW50cyBhcmUgcmVuYW1lZCBmb2xsb3dpbmcgdGhlXG4gICAqIHN1cHBsaWVkIHN0eWxlICh1bmRlZmluZWQgdG8ga2VlcCB0aGUgb3JpZ2luYWwgbmFtZSkuXG4gICAqL1xuICBjaGFuZ2VDYXNlPzogQ2FzZVN0eWxlO1xuXG4gIHJlbmFtZT86IHtyZWFkb25seSBbUCBpbiBrZXlvZiBUXT86IHN0cmluZ307XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgRG9jdW1lbnRJb1R5cGVPcHRpb25zPFQ+IGV4dGVuZHMgRG9jdW1lbnRUeXBlT3B0aW9uczxUPiB7XG4gIHByb3BlcnRpZXM6IHtyZWFkb25seSBbUCBpbiBrZXlvZiBUXTogUHJvcGVydHlEZXNjcmlwdG9yPFRbUF0sIElvVHlwZTxUW1BdPj59O1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIFByb3BlcnR5RGVzY3JpcHRvcjxULCBLIGV4dGVuZHMgVHlwZTxUPiA9IFR5cGU8VD4+IHtcbiAgLyoqXG4gICAqIEFsbG93cyB0aGlzIHByb3BlcnR5IHRvIGJlIG1pc3NpbmcgKHVuZGVmaW5lZCB2YWx1ZXMgdGhyb3cgZXJyb3JzKS5cbiAgICovXG4gIG9wdGlvbmFsPzogYm9vbGVhbjtcblxuICAvKipcbiAgICogVGhlIHR5cGUgb2YgdGhpcyBwcm9wZXJ0eS5cbiAgICovXG4gIHR5cGU6IEs7XG5cbiAgLyoqXG4gICAqIFRoZSBrZXkgaW4gdGhlIHNlcmlhbGl6ZWQgZG9jdW1lbnRzIHdpbGwgYmUgYXV0b21hdGljYWxseSByZW5hbWVkIHdpdGggdGhlIHByb3ZpZGVkXG4gICAqIGNhc2Ugc3R5bGUuXG4gICAqL1xuICBjaGFuZ2VDYXNlPzogQ2FzZVN0eWxlO1xuXG4gIC8qKlxuICAgKiBUaGUgbmFtZSBvZiB0aGUga2V5IHVzZWQgaW4gdGhlIHNlcmlhbGl6ZWQgZG9jdW1lbnRzLlxuICAgKi9cbiAgcmVuYW1lPzogc3RyaW5nO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIERvY3VtZW50VHlwZUNvbnN0cnVjdG9yIHtcbiAgbmV3PFQ+KG9wdGlvbnM6IExhenk8RG9jdW1lbnRJb1R5cGVPcHRpb25zPFQ+Pik6IERvY3VtZW50SW9UeXBlPFQ+O1xuXG4gIC8qKlxuICAgKiBDcmVhdGUgYSBuZXcgZG9jdW1lbnQgdHlwZSBjaGVja2luZyBmb3Igb2JqZWN0cyB3aXRoIHRoZSBzdXBwbGllZCBwcm9wZXJ0aWVzLlxuICAgKlxuICAgKiBUaGUgZ2VuZXJpYyB0eXBlIGBUYCBpcyB0aGUgaW50ZXJmYWNlIGRlc2NyaWJlZCBieSB0aGlzIGluc3RhbmNlLlxuICAgKlxuICAgKiBAcGFyYW0gb3B0aW9ucyBPcHRpb25zIGRlc2NyaWJpbmcgdGhpcyBkb2N1bWVudCB0eXBlLlxuICAgKiBAcmV0dXJuIFRoZSBkb2N1bWVudCB0eXBlIGNvcnJlc3BvbmRpbmcgdG8gdGhlIHByb3ZpZGVkIG9wdGlvbnNcbiAgICovXG4gIG5ldzxUPihvcHRpb25zOiBMYXp5PERvY3VtZW50VHlwZU9wdGlvbnM8VD4+KTogRG9jdW1lbnRUeXBlPFQ+O1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIERvY3VtZW50VHlwZTxUPiBleHRlbmRzIFR5cGU8VD4sIFZlcnNpb25lZFR5cGU8VCwgRGlmZjxUPj4sIERvY3VtZW50VHlwZU9wdGlvbnM8VD4ge1xuICBnZXRPdXRLZXkoa2V5OiBrZXlvZiBUKTogc3RyaW5nO1xufVxuXG4vLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bWF4LWxpbmUtbGVuZ3RoXG5leHBvcnQgaW50ZXJmYWNlIERvY3VtZW50SW9UeXBlPFQ+IGV4dGVuZHMgSW9UeXBlPFQ+LCBWZXJzaW9uZWRUeXBlPFQsIERpZmY8VD4+LCBEb2N1bWVudElvVHlwZU9wdGlvbnM8VD4ge1xuICBnZXRPdXRLZXkoa2V5OiBrZXlvZiBUKTogc3RyaW5nO1xuXG4gIHJlYWQ8Uj4ocmVhZGVyOiBSZWFkZXI8Uj4sIHJhdzogUik6IFQ7XG5cbiAgd3JpdGU8Vz4od3JpdGVyOiBXcml0ZXI8Vz4sIHZhbHVlOiBUKTogVztcbn1cblxuLy8gV2UgdXNlIGFuIGBhbnlgIGNhc3QgYmVjYXVzZSBvZiB0aGUgYHByb3BlcnRpZXNgIHByb3BlcnR5LlxuLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOnZhcmlhYmxlLW5hbWVcbmV4cG9ydCBjb25zdCBEb2N1bWVudFR5cGU6IERvY3VtZW50VHlwZUNvbnN0cnVjdG9yID0gPGFueT4gY2xhc3M8VD4gaW1wbGVtZW50cyBJb1R5cGU8VD4sXG4gIERvY3VtZW50SW9UeXBlT3B0aW9uczxUPiB7XG4gIHJlYWRvbmx5IG5hbWU6IE5hbWUgPSBuYW1lO1xuICByZWFkb25seSBub0V4dHJhS2V5cz86IGJvb2xlYW47XG4gIHJlYWRvbmx5IHByb3BlcnRpZXMhOiB7cmVhZG9ubHkgW1AgaW4ga2V5b2YgVF06IFByb3BlcnR5RGVzY3JpcHRvcjxUW1BdLCBhbnk+fTtcbiAgcmVhZG9ubHkgcmVuYW1lPzoge3JlYWRvbmx5IFtQIGluIGtleW9mIFRdPzogc3RyaW5nfTtcbiAgcmVhZG9ubHkgY2hhbmdlQ2FzZT86IENhc2VTdHlsZTtcbiAgcHJpdmF0ZSBfb3B0aW9uczogTGF6eTxEb2N1bWVudFR5cGVPcHRpb25zPFQ+PjtcbiAgcHJpdmF0ZSBfb3V0S2V5czogTWFwPHN0cmluZywga2V5b2YgVD4gfCB1bmRlZmluZWQ7XG5cbiAgY29uc3RydWN0b3Iob3B0aW9uczogTGF6eTxEb2N1bWVudFR5cGVPcHRpb25zPFQ+Pikge1xuICAgIHRoaXMuX29wdGlvbnMgPSBvcHRpb25zO1xuICAgIGlmICh0eXBlb2Ygb3B0aW9ucyAhPT0gXCJmdW5jdGlvblwiKSB7XG4gICAgICB0aGlzLl9hcHBseU9wdGlvbnMoKTtcbiAgICB9IGVsc2Uge1xuICAgICAgbGF6eVByb3BlcnRpZXModGhpcywgdGhpcy5fYXBwbHlPcHRpb25zLCBbXCJub0V4dHJhS2V5c1wiLCBcInByb3BlcnRpZXNcIiwgXCJjaGFuZ2VDYXNlXCIsIFwicmVuYW1lXCIgYXMga2V5b2YgdGhpc10pO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBNYXAgZnJvbSBzZXJpYWxpemVkIGtleXMgdG8gdGhlIGRvY3VtZW50IGtleXNcbiAgICovXG4gIGdldCBvdXRLZXlzKCk6IE1hcDxzdHJpbmcsIGtleW9mIFQ+IHtcbiAgICBpZiAodGhpcy5fb3V0S2V5cyA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICB0aGlzLl9vdXRLZXlzID0gbmV3IE1hcCgpO1xuICAgICAgZm9yIChjb25zdCBrZXkgb2YgT2JqZWN0LmtleXModGhpcy5wcm9wZXJ0aWVzKSBhcyAoa2V5b2YgVClbXSkge1xuICAgICAgICB0aGlzLl9vdXRLZXlzLnNldCh0aGlzLmdldE91dEtleShrZXkpLCBrZXkpO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gdGhpcy5fb3V0S2V5cztcbiAgfVxuXG4gIGdldE91dEtleShrZXk6IGtleW9mIFQpOiBzdHJpbmcge1xuICAgIGlmICh0eXBlb2Yga2V5ICE9PSBcInN0cmluZ1wiKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYE5vblN0cmluZ0tleTogJHtrZXl9YCk7XG4gICAgfVxuICAgIGNvbnN0IGRlc2NyaXB0b3I6IFByb3BlcnR5RGVzY3JpcHRvcjxhbnk+ID0gdGhpcy5wcm9wZXJ0aWVzW2tleV07XG4gICAgaWYgKGRlc2NyaXB0b3IucmVuYW1lICE9PSB1bmRlZmluZWQpIHtcbiAgICAgIHJldHVybiBkZXNjcmlwdG9yLnJlbmFtZTtcbiAgICB9IGVsc2UgaWYgKGRlc2NyaXB0b3IuY2hhbmdlQ2FzZSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICByZXR1cm4gcmVuYW1lKGtleSBhcyBzdHJpbmcsIGRlc2NyaXB0b3IuY2hhbmdlQ2FzZSk7XG4gICAgfVxuICAgIGlmICh0aGlzLnJlbmFtZSAhPT0gdW5kZWZpbmVkICYmIHRoaXMucmVuYW1lW2tleV0gIT09IHVuZGVmaW5lZCkge1xuICAgICAgcmV0dXJuIHRoaXMucmVuYW1lW2tleV0hO1xuICAgIH0gZWxzZSBpZiAodGhpcy5jaGFuZ2VDYXNlICE9PSB1bmRlZmluZWQpIHtcbiAgICAgIHJldHVybiByZW5hbWUoa2V5IGFzIHN0cmluZywgdGhpcy5jaGFuZ2VDYXNlKTtcbiAgICB9XG4gICAgcmV0dXJuIGtleTtcbiAgfVxuXG4gIC8vIFRPRE86IER5bmFtaWNhbGx5IGFkZCB3aXRoIHByb3RvdHlwZT9cbiAgcmVhZDxSPihyZWFkZXI6IFJlYWRlcjxSPiwgcmF3OiBSKTogVCB7XG4gICAgcmV0dXJuIHJlYWRlci5yZWFkRG9jdW1lbnQocmF3LCByZWFkVmlzaXRvcih7XG4gICAgICBmcm9tTWFwOiA8UkssIFJWPihpbnB1dDogTWFwPFJLLCBSVj4sIGtleVJlYWRlcjogUmVhZGVyPFJLPiwgdmFsdWVSZWFkZXI6IFJlYWRlcjxSVj4pOiBUID0+IHtcbiAgICAgICAgY29uc3QgZXh0cmE6IFNldDxzdHJpbmc+ID0gbmV3IFNldCgpO1xuICAgICAgICBjb25zdCBtaXNzaW5nOiBTZXQ8c3RyaW5nPiA9IG5ldyBTZXQoKTtcbiAgICAgICAgZm9yIChjb25zdCBrZXkgaW4gdGhpcy5wcm9wZXJ0aWVzKSB7XG4gICAgICAgICAgY29uc3QgZGVzY3JpcHRvcjogUHJvcGVydHlEZXNjcmlwdG9yPGFueT4gPSB0aGlzLnByb3BlcnRpZXNba2V5XTtcbiAgICAgICAgICBpZiAoIWRlc2NyaXB0b3Iub3B0aW9uYWwpIHtcbiAgICAgICAgICAgIG1pc3NpbmcuYWRkKGtleSk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGNvbnN0IGludmFsaWQ6IE1hcDxzdHJpbmcsIEVycm9yPiA9IG5ldyBNYXAoKTtcbiAgICAgICAgY29uc3QgcmVzdWx0OiBQYXJ0aWFsPFQ+ID0ge307IC8vIE9iamVjdC5jcmVhdGUobnVsbCk7XG5cbiAgICAgICAgZm9yIChjb25zdCBbcmF3S2V5LCByYXdWYWx1ZV0gb2YgaW5wdXQpIHtcbiAgICAgICAgICBjb25zdCBvdXRLZXk6IHN0cmluZyA9IGtleVJlYWRlci5yZWFkU3RyaW5nKFxuICAgICAgICAgICAgcmF3S2V5LFxuICAgICAgICAgICAgcmVhZFZpc2l0b3Ioe2Zyb21TdHJpbmc6IChpbnB1dDogc3RyaW5nKTogc3RyaW5nICA9PiBpbnB1dH0pLFxuICAgICAgICAgICk7XG4gICAgICAgICAgY29uc3Qga2V5OiBrZXlvZiBUIHwgdW5kZWZpbmVkID0gdGhpcy5vdXRLZXlzLmdldChvdXRLZXkpO1xuICAgICAgICAgIGlmIChrZXkgPT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgLy8gRXh0cmEga2V5XG4gICAgICAgICAgICBleHRyYS5hZGQob3V0S2V5KTtcbiAgICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICAgIH1cbiAgICAgICAgICBtaXNzaW5nLmRlbGV0ZShrZXkgYXMgc3RyaW5nKTtcbiAgICAgICAgICBjb25zdCBkZXNjcmlwdG9yOiBQcm9wZXJ0eURlc2NyaXB0b3I8YW55PiA9IHRoaXMucHJvcGVydGllc1trZXldO1xuICAgICAgICAgIC8vIFRPRE86IFVwZGF0ZSByZWFkZXJzIHNvIGB1bmRlZmluZWRgIGlzIGltcG9zc2libGUvbm90IGhhbmRsZWQgaGVyZVxuICAgICAgICAgIGlmIChyYXdWYWx1ZSA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICBpZiAoZGVzY3JpcHRvci5vcHRpb25hbCkge1xuICAgICAgICAgICAgICByZXN1bHRba2V5XSA9IHVuZGVmaW5lZDtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgIG1pc3NpbmcuYWRkKGtleSBhcyBzdHJpbmcpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgY29udGludWU7XG4gICAgICAgICAgfVxuICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICByZXN1bHRba2V5XSA9IGRlc2NyaXB0b3IudHlwZS5yZWFkISh2YWx1ZVJlYWRlciwgcmF3VmFsdWUpO1xuICAgICAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICAgICAgaW52YWxpZC5zZXQoa2V5IGFzIHN0cmluZywgZXJyKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICBpZiAodGhpcy5ub0V4dHJhS2V5cyAmJiBleHRyYS5zaXplID4gMCB8fCBtaXNzaW5nLnNpemUgPiAwIHx8IGludmFsaWQuc2l6ZSA+IDApIHtcbiAgICAgICAgICB0aHJvdyBjcmVhdGVJbnZhbGlkRG9jdW1lbnRFcnJvcih7ZXh0cmEsIG1pc3NpbmcsIGludmFsaWR9KTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gcmVzdWx0IGFzIFQ7XG4gICAgICB9LFxuICAgIH0pKTtcbiAgfVxuXG4gIC8vIFRPRE86IER5bmFtaWNhbGx5IGFkZCB3aXRoIHByb3RvdHlwZT9cbiAgd3JpdGU8Vz4od3JpdGVyOiBXcml0ZXI8Vz4sIHZhbHVlOiBUKTogVyB7XG4gICAgY29uc3Qgb3V0S2V5czogTWFwPHN0cmluZywga2V5b2YgVD4gPSBuZXcgTWFwKHRoaXMub3V0S2V5cyk7XG5cbiAgICBmb3IgKGNvbnN0IFtvdXRLZXksIGpza2V5XSBvZiBvdXRLZXlzKSB7XG4gICAgICBpZiAodmFsdWVbanNrZXldID09PSB1bmRlZmluZWQpIHtcbiAgICAgICAgb3V0S2V5cy5kZWxldGUob3V0S2V5KTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gd3JpdGVyLndyaXRlRG9jdW1lbnQob3V0S2V5cy5rZXlzKCksIDxGVz4ob3V0S2V5OiBzdHJpbmcsIGZpZWxkV3JpdGVyOiBXcml0ZXI8Rlc+KTogRlcgPT4ge1xuICAgICAgY29uc3QganNLZXk6IGtleW9mIFQgPSB0aGlzLm91dEtleXMuZ2V0KG91dEtleSkhO1xuICAgICAgY29uc3QgZGVzY3JpcHRvcjogUHJvcGVydHlEZXNjcmlwdG9yPGFueT4gPSB0aGlzLnByb3BlcnRpZXNbanNLZXldO1xuICAgICAgaWYgKGRlc2NyaXB0b3IudHlwZS53cml0ZSA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIHRocm93IG5ldyBJbmNpZGVudChcIk5vdFdyaXRhYmxlXCIsIHt0eXBlOiBkZXNjcmlwdG9yLnR5cGV9KTtcbiAgICAgIH1cbiAgICAgIHJldHVybiBkZXNjcmlwdG9yLnR5cGUud3JpdGUoZmllbGRXcml0ZXIsIHZhbHVlW2pzS2V5XSk7XG4gICAgfSk7XG4gIH1cblxuICB0ZXN0RXJyb3IodmFsOiBUKTogRXJyb3IgfCB1bmRlZmluZWQge1xuICAgIGlmICh0eXBlb2YgdmFsICE9PSBcIm9iamVjdFwiIHx8IHZhbCA9PT0gbnVsbCkge1xuICAgICAgcmV0dXJuIGNyZWF0ZUludmFsaWRUeXBlRXJyb3IoXCJvYmplY3RcIiwgdmFsKTtcbiAgICB9XG5cbiAgICBjb25zdCBleHRyYTogU2V0PHN0cmluZz4gfCB1bmRlZmluZWQgPSB0aGlzLm5vRXh0cmFLZXlzID8gbmV3IFNldChPYmplY3Qua2V5cyh2YWwpKSA6IHVuZGVmaW5lZDtcbiAgICBjb25zdCBtaXNzaW5nOiBTZXQ8c3RyaW5nPiA9IG5ldyBTZXQoKTtcbiAgICBjb25zdCBpbnZhbGlkOiBNYXA8c3RyaW5nLCBFcnJvcj4gPSBuZXcgTWFwKCk7XG5cbiAgICBmb3IgKGNvbnN0IGtleSBpbiB0aGlzLnByb3BlcnRpZXMpIHtcbiAgICAgIGlmIChleHRyYSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIGV4dHJhLmRlbGV0ZShrZXkpO1xuICAgICAgfVxuICAgICAgY29uc3QgZGVzY3JpcHRvcjogUHJvcGVydHlEZXNjcmlwdG9yPGFueT4gPSB0aGlzLnByb3BlcnRpZXNba2V5XTtcbiAgICAgIGNvbnN0IHByb3BlcnR5VmFsdWU6IGFueSA9IHZhbFtrZXldO1xuICAgICAgaWYgKHByb3BlcnR5VmFsdWUgPT09IHVuZGVmaW5lZCkge1xuICAgICAgICBpZiAoIWRlc2NyaXB0b3Iub3B0aW9uYWwpIHtcbiAgICAgICAgICBtaXNzaW5nLmFkZChrZXkpO1xuICAgICAgICB9XG4gICAgICAgIGNvbnRpbnVlO1xuICAgICAgfVxuICAgICAgY29uc3QgZXJyb3I6IEVycm9yIHwgdW5kZWZpbmVkID0gZGVzY3JpcHRvci50eXBlLnRlc3RFcnJvciEocHJvcGVydHlWYWx1ZSk7XG4gICAgICBpZiAoZXJyb3IgIT09IHVuZGVmaW5lZCkge1xuICAgICAgICBpbnZhbGlkLnNldChrZXkgYXMgc3RyaW5nLCBlcnJvcik7XG4gICAgICB9XG4gICAgfVxuXG4gICAgaWYgKGV4dHJhICE9PSB1bmRlZmluZWQgJiYgZXh0cmEuc2l6ZSA+IDAgfHwgbWlzc2luZy5zaXplID4gMCB8fCBpbnZhbGlkLnNpemUgPiAwKSB7XG4gICAgICByZXR1cm4gY3JlYXRlSW52YWxpZERvY3VtZW50RXJyb3Ioe2V4dHJhLCBtaXNzaW5nLCBpbnZhbGlkfSk7XG4gICAgfVxuICAgIHJldHVybiB1bmRlZmluZWQ7XG4gIH1cblxuICB0ZXN0KHZhbDogVCk6IHZhbCBpcyBUIHtcbiAgICBpZiAodHlwZW9mIHZhbCAhPT0gXCJvYmplY3RcIiB8fCB2YWwgPT09IG51bGwpIHtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG5cbiAgICBjb25zdCBleHRyYTogU2V0PHN0cmluZz4gfCB1bmRlZmluZWQgPSB0aGlzLm5vRXh0cmFLZXlzID8gbmV3IFNldChPYmplY3Qua2V5cyh2YWwpKSA6IHVuZGVmaW5lZDtcblxuICAgIGZvciAoY29uc3Qga2V5IGluIHRoaXMucHJvcGVydGllcykge1xuICAgICAgaWYgKGV4dHJhICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgZXh0cmEuZGVsZXRlKGtleSk7XG4gICAgICB9XG4gICAgICBjb25zdCBkZXNjcmlwdG9yOiBQcm9wZXJ0eURlc2NyaXB0b3I8YW55PiA9IHRoaXMucHJvcGVydGllc1trZXldO1xuICAgICAgY29uc3QgcHJvcGVydHlWYWx1ZTogYW55ID0gdmFsW2tleV07XG4gICAgICBpZiAocHJvcGVydHlWYWx1ZSA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIGlmICghZGVzY3JpcHRvci5vcHRpb25hbCkge1xuICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfVxuICAgICAgfSBlbHNlIGlmICghZGVzY3JpcHRvci50eXBlLnRlc3QocHJvcGVydHlWYWx1ZSkpIHtcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiBleHRyYSA9PT0gdW5kZWZpbmVkIHx8IGV4dHJhLnNpemUgPT09IDA7XG4gIH1cblxuICBlcXVhbHModmFsMTogVCwgdmFsMjogVCk6IGJvb2xlYW4ge1xuICAgIGZvciAoY29uc3Qga2V5IGluIHRoaXMucHJvcGVydGllcykge1xuICAgICAgY29uc3QgZGVzY3JpcHRvcjogUHJvcGVydHlEZXNjcmlwdG9yPGFueT4gPSB0aGlzLnByb3BlcnRpZXNba2V5XTtcbiAgICAgIGlmICghZGVzY3JpcHRvci5vcHRpb25hbCkge1xuICAgICAgICBpZiAoIWRlc2NyaXB0b3IudHlwZS5lcXVhbHModmFsMVtrZXldLCB2YWwyW2tleV0pKSB7XG4gICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICB9XG4gICAgICAgIGNvbnRpbnVlO1xuICAgICAgfVxuICAgICAgaWYgKHZhbDFba2V5XSA9PT0gdW5kZWZpbmVkICYmIHZhbDJba2V5XSA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIGNvbnRpbnVlO1xuICAgICAgfVxuICAgICAgaWYgKHZhbDFba2V5XSA9PT0gdW5kZWZpbmVkIHx8IHZhbDJba2V5XSA9PT0gdW5kZWZpbmVkIHx8ICFkZXNjcmlwdG9yLnR5cGUuZXF1YWxzKHZhbDFba2V5XSwgdmFsMltrZXldKSkge1xuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiB0cnVlO1xuICB9XG5cbiAgY2xvbmUodmFsOiBUKTogVCB7XG4gICAgY29uc3QgcmVzdWx0OiBQYXJ0aWFsPFQ+ID0ge307IC8vIE9iamVjdC5jcmVhdGUobnVsbCk7XG4gICAgZm9yIChjb25zdCBrZXkgaW4gdGhpcy5wcm9wZXJ0aWVzKSB7XG4gICAgICByZXN1bHRba2V5XSA9IHZhbFtrZXldID09PSB1bmRlZmluZWQgPyB1bmRlZmluZWQgOiB0aGlzLnByb3BlcnRpZXNba2V5XS50eXBlLmNsb25lKHZhbFtrZXldKTtcbiAgICB9XG4gICAgcmV0dXJuIHJlc3VsdCBhcyBUO1xuICB9XG5cbiAgZGlmZihvbGRWYWw6IFQsIG5ld1ZhbDogVCk6IERpZmY8VD4gfCB1bmRlZmluZWQge1xuICAgIGxldCBlcXVhbDogYm9vbGVhbiA9IHRydWU7XG4gICAgY29uc3QgcmVzdWx0OiBEaWZmPFQ+ID0ge3NldDoge30sIHVuc2V0OiB7fSwgdXBkYXRlOiB7fX07XG4gICAgZm9yIChjb25zdCBrZXkgaW4gdGhpcy5wcm9wZXJ0aWVzKSB7XG4gICAgICAvLyBUT0RPOiBSZW1vdmUgY2FzdFxuICAgICAgY29uc3QgZGVzY3JpcHRvcjogUHJvcGVydHlEZXNjcmlwdG9yPGFueSwgVmVyc2lvbmVkVHlwZTxhbnksIGFueT4+ID0gPGFueT4gdGhpcy5wcm9wZXJ0aWVzW2tleV07XG4gICAgICBjb25zdCBvbGRNZW1iZXI6IGFueSA9ICg8YW55PiBvbGRWYWwpW2tleV07XG4gICAgICBjb25zdCBuZXdNZW1iZXI6IGFueSA9ICg8YW55PiBuZXdWYWwpW2tleV07XG4gICAgICBpZiAob2xkTWVtYmVyICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgaWYgKG5ld01lbWJlciAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgY29uc3QgZGlmZjogYW55ID0gZGVzY3JpcHRvci50eXBlLmRpZmYob2xkTWVtYmVyLCBuZXdNZW1iZXIpO1xuICAgICAgICAgIGlmIChkaWZmICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgIHJlc3VsdC51cGRhdGVba2V5XSA9IGRpZmY7XG4gICAgICAgICAgICBlcXVhbCA9IGZhbHNlO1xuICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICByZXN1bHQudW5zZXRba2V5XSA9IGRlc2NyaXB0b3IudHlwZS5jbG9uZShvbGRNZW1iZXIpO1xuICAgICAgICAgIGVxdWFsID0gZmFsc2U7XG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGlmIChuZXdNZW1iZXIgPT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgIHJlc3VsdC5zZXRba2V5XSA9IGRlc2NyaXB0b3IudHlwZS5jbG9uZShuZXdNZW1iZXIpO1xuICAgICAgICAgIGVxdWFsID0gZmFsc2U7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIGVxdWFsID8gdW5kZWZpbmVkIDogcmVzdWx0O1xuICB9XG5cbiAgcGF0Y2gob2xkVmFsOiBULCBkaWZmOiBEaWZmPFQ+IHwgdW5kZWZpbmVkKTogVCB7XG4gICAgY29uc3QgcmVzdWx0OiBUID0gdGhpcy5jbG9uZShvbGRWYWwpO1xuICAgIGlmIChkaWZmID09PSB1bmRlZmluZWQpIHtcbiAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgfVxuICAgIGZvciAoY29uc3Qga2V5IGluIGRpZmYuc2V0KSB7XG4gICAgICByZXN1bHRba2V5XSA9IHRoaXMucHJvcGVydGllc1trZXldLnR5cGUuY2xvbmUoZGlmZi5zZXRba2V5XSk7XG4gICAgfVxuICAgIGZvciAoY29uc3Qga2V5IGluIGRpZmYudW5zZXQpIHtcbiAgICAgIFJlZmxlY3QuZGVsZXRlUHJvcGVydHkocmVzdWx0IGFzIGFueSBhcyBvYmplY3QsIGtleSk7XG4gICAgfVxuICAgIGZvciAoY29uc3Qga2V5IGluIGRpZmYudXBkYXRlKSB7XG4gICAgICAvLyBUT0RPOiBSZW1vdmUgY2FzdFxuICAgICAgcmVzdWx0W2tleV0gPSAodGhpcy5wcm9wZXJ0aWVzW2tleV0udHlwZSBhcyBhbnkpLnBhdGNoKHJlc3VsdFtrZXldLCBkaWZmLnVwZGF0ZVtrZXldKTtcbiAgICB9XG4gICAgcmV0dXJuIHJlc3VsdDtcbiAgfVxuXG4gIHJldmVyc2VEaWZmKGRpZmY6IERpZmY8VD4gfCB1bmRlZmluZWQpOiBEaWZmPFQ+IHwgdW5kZWZpbmVkIHtcbiAgICBpZiAoZGlmZiA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICByZXR1cm4gdW5kZWZpbmVkO1xuICAgIH1cbiAgICBjb25zdCByZXN1bHQ6IERpZmY8VD4gPSB7c2V0OiB7fSwgdW5zZXQ6IHt9LCB1cGRhdGU6IHt9fTtcbiAgICBmb3IgKGNvbnN0IGtleSBpbiBkaWZmLnVuc2V0KSB7XG4gICAgICByZXN1bHQuc2V0W2tleV0gPSB0aGlzLnByb3BlcnRpZXNba2V5XS50eXBlLmNsb25lKGRpZmYudW5zZXRba2V5XSk7XG4gICAgfVxuICAgIGZvciAoY29uc3Qga2V5IGluIGRpZmYuc2V0KSB7XG4gICAgICByZXN1bHQudW5zZXRba2V5XSA9IHRoaXMucHJvcGVydGllc1trZXldLnR5cGUuY2xvbmUoZGlmZi5zZXRba2V5XSk7XG4gICAgfVxuICAgIGZvciAoY29uc3Qga2V5IGluIGRpZmYudXBkYXRlKSB7XG4gICAgICAvLyBUT0RPOiBSZW1vdmUgY2FzdFxuICAgICAgcmVzdWx0LnVwZGF0ZVtrZXldID0gKHRoaXMucHJvcGVydGllc1trZXldLnR5cGUgYXMgYW55KS5yZXZlcnNlRGlmZihkaWZmLnVwZGF0ZVtrZXldKTtcbiAgICB9XG4gICAgcmV0dXJuIHJlc3VsdDtcbiAgfVxuXG4gIHNxdWFzaChfZGlmZjE6IERpZmY8VD4gfCB1bmRlZmluZWQsIF9kaWZmMjogRGlmZjxUPiB8IHVuZGVmaW5lZCk6IERpZmY8VD4gfCB1bmRlZmluZWQge1xuICAgIHRocm93IGNyZWF0ZU5vdEltcGxlbWVudGVkRXJyb3IoXCJEb2N1bWVudFR5cGUjc3F1YXNoXCIpO1xuICB9XG5cbiAgcHJpdmF0ZSBfYXBwbHlPcHRpb25zKCk6IHZvaWQge1xuICAgIGlmICh0aGlzLl9vcHRpb25zID09PSB1bmRlZmluZWQpIHtcbiAgICAgIHRocm93IGNyZWF0ZUxhenlPcHRpb25zRXJyb3IodGhpcyk7XG4gICAgfVxuICAgIGNvbnN0IG9wdGlvbnM6IERvY3VtZW50VHlwZU9wdGlvbnM8VD4gPSB0eXBlb2YgdGhpcy5fb3B0aW9ucyA9PT0gXCJmdW5jdGlvblwiID9cbiAgICAgIHRoaXMuX29wdGlvbnMoKSA6XG4gICAgICB0aGlzLl9vcHRpb25zO1xuXG4gICAgY29uc3Qgbm9FeHRyYUtleXM6IGJvb2xlYW4gfCB1bmRlZmluZWQgPSBvcHRpb25zLm5vRXh0cmFLZXlzO1xuICAgIGNvbnN0IHByb3BlcnRpZXM6IHtbUCBpbiBrZXlvZiBUXTogUHJvcGVydHlEZXNjcmlwdG9yPGFueT59ID0gb3B0aW9ucy5wcm9wZXJ0aWVzO1xuICAgIGNvbnN0IHJlbmFtZToge1tQIGluIGtleW9mIFRdPzogc3RyaW5nfSB8IHVuZGVmaW5lZCA9IG9wdGlvbnMucmVuYW1lO1xuICAgIGNvbnN0IGNoYW5nZUNhc2U6IENhc2VTdHlsZSB8IHVuZGVmaW5lZCA9IG9wdGlvbnMuY2hhbmdlQ2FzZTtcblxuICAgIE9iamVjdC5hc3NpZ24odGhpcywge25vRXh0cmFLZXlzLCBwcm9wZXJ0aWVzLCByZW5hbWUsIGNoYW5nZUNhc2V9KTtcbiAgfVxufTtcblxuZXhwb3J0IGZ1bmN0aW9uIHJlbmFtZUtleXM8VD4ob2JqOiBULCByZW5hbWVBbGw/OiBDYXNlU3R5bGUpOiBNYXA8a2V5b2YgVCwgc3RyaW5nPiB7XG4gIGNvbnN0IGtleXM6IHN0cmluZ1tdID0gT2JqZWN0LmtleXMob2JqKTtcbiAgY29uc3QgcmVzdWx0OiBNYXA8a2V5b2YgVCwgc3RyaW5nPiA9IG5ldyBNYXAoKTtcbiAgY29uc3Qgb3V0S2V5czogU2V0PHN0cmluZz4gPSBuZXcgU2V0KCk7XG4gIGZvciAoY29uc3Qga2V5IG9mIGtleXMpIHtcbiAgICBjb25zdCByZW5hbWVkOiBzdHJpbmcgPSByZW5hbWVBbGwgPT09IHVuZGVmaW5lZCA/IGtleSA6IHJlbmFtZShrZXksIHJlbmFtZUFsbCk7XG4gICAgcmVzdWx0LnNldChrZXkgYXMga2V5b2YgVCwgcmVuYW1lZCk7XG4gICAgaWYgKG91dEtleXMuaGFzKHJlbmFtZWQpKSB7XG4gICAgICB0aHJvdyBuZXcgSW5jaWRlbnQoXCJOb25CaWplY3RpdmVLZXlSZW5hbWVcIiwgXCJTb21lIGtleXMgYXJlIHRoZSBzYW1lIGFmdGVyIHJlbmFtaW5nXCIpO1xuICAgIH1cbiAgICBvdXRLZXlzLmFkZChyZW5hbWVkKTtcbiAgfVxuICByZXR1cm4gcmVzdWx0O1xufVxuIl0sInNvdXJjZVJvb3QiOiIuLi8uLiJ9
