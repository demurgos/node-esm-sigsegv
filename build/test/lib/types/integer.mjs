import { Incident } from "incident";
import { lazyProperties } from "../_helpers/lazy-properties";
import { createInvalidIntegerError } from "../errors/invalid-integer";
import { createInvalidTypeError } from "../errors/invalid-type";
import { createLazyOptionsError } from "../errors/lazy-options";
import { readVisitor } from "../readers/read-visitor";
export const name = "integer";
/**
 * Default value for the `min` option.
 * It corresponds to `-(2**53)`.
 */
export const DEFAULT_MIN = Number.MIN_SAFE_INTEGER - 1;
/**
 * Default value for the `max` option.
 * It corresponds to `2**53 - 1`.
 */
export const DEFAULT_MAX = Number.MAX_SAFE_INTEGER;
export class IntegerType {
    constructor(options) {
        this.name = name;
        if (options === undefined) {
            this._options = {};
            this._applyOptions();
            return;
        }
        this._options = options;
        if (typeof options !== "function") {
            this._applyOptions();
        }
        else {
            lazyProperties(this, this._applyOptions, ["min", "max"]);
        }
    }
    static fromJSON(options) {
        return new IntegerType(options);
    }
    toJSON() {
        return { name, min: this.min, max: this.max };
    }
    read(reader, raw) {
        return reader.readFloat64(raw, readVisitor({
            fromFloat64: (input) => {
                const error = reader.trustInput ? undefined : this.testError(input);
                if (error !== undefined) {
                    throw error;
                }
                return input;
            },
        }));
    }
    // TODO: Dynamically add with prototype?
    write(writer, value) {
        return writer.writeFloat64(value);
    }
    testError(val) {
        if (typeof val !== "number") {
            return createInvalidTypeError("number", val);
        }
        if (Math.round(val) !== val) {
            return createInvalidIntegerError(val);
        }
        if (val < this.min || val > this.max) {
            return new Incident("Range", { value: val, min: this.min, max: this.max }, "Integer not in range");
        }
        return undefined;
    }
    test(val) {
        return typeof val === "number" && val >= this.min && val <= this.max && Math.round(val) === val;
    }
    equals(left, right) {
        return left === right;
    }
    lte(left, right) {
        return left <= right;
    }
    clone(val) {
        return val;
    }
    diff(oldVal, newVal) {
        return newVal === oldVal ? undefined : newVal - oldVal;
    }
    patch(oldVal, diff) {
        return diff === undefined ? oldVal : oldVal + diff;
    }
    reverseDiff(diff) {
        /* tslint:disable-next-line:strict-boolean-expressions */
        return diff && -diff;
    }
    squash(diff1, diff2) {
        if (diff1 === undefined) {
            return diff2;
        }
        else if (diff2 === undefined) {
            return diff1;
        }
        return diff2 === -diff1 ? undefined : diff1 + diff2;
    }
    _applyOptions() {
        if (this._options === undefined) {
            throw createLazyOptionsError(this);
        }
        const options = typeof this._options === "function" ? this._options() : this._options;
        const min = options.min !== undefined ? options.min : DEFAULT_MIN;
        const max = options.max !== undefined ? options.max : DEFAULT_MAX;
        Object.assign(this, { min, max });
    }
}

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9saWIvdHlwZXMvaW50ZWdlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsUUFBUSxFQUFFLE1BQU0sVUFBVSxDQUFDO0FBQ3BDLE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSw2QkFBNkIsQ0FBQztBQUU3RCxPQUFPLEVBQUUseUJBQXlCLEVBQUUsTUFBTSwyQkFBMkIsQ0FBQztBQUN0RSxPQUFPLEVBQUUsc0JBQXNCLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQztBQUNoRSxPQUFPLEVBQUUsc0JBQXNCLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQztBQUNoRSxPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0seUJBQXlCLENBQUM7QUFHdEQsTUFBTSxDQUFDLE1BQU0sSUFBSSxHQUFTLFNBQVMsQ0FBQztBQXlCcEM7OztHQUdHO0FBQ0gsTUFBTSxDQUFDLE1BQU0sV0FBVyxHQUFXLE1BQU0sQ0FBQyxnQkFBZ0IsR0FBRyxDQUFDLENBQUM7QUFFL0Q7OztHQUdHO0FBQ0gsTUFBTSxDQUFDLE1BQU0sV0FBVyxHQUFXLE1BQU0sQ0FBQyxnQkFBZ0IsQ0FBQztBQUUzRCxNQUFNLE9BQU8sV0FBVztJQVF0QixZQUFZLE9BQWtDO1FBTnJDLFNBQUksR0FBUyxJQUFJLENBQUM7UUFPekIsSUFBSSxPQUFPLEtBQUssU0FBUyxFQUFFO1lBQ3pCLElBQUksQ0FBQyxRQUFRLEdBQUcsRUFBRSxDQUFDO1lBQ25CLElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQztZQUNyQixPQUFPO1NBQ1I7UUFDRCxJQUFJLENBQUMsUUFBUSxHQUFHLE9BQU8sQ0FBQztRQUN4QixJQUFJLE9BQU8sT0FBTyxLQUFLLFVBQVUsRUFBRTtZQUNqQyxJQUFJLENBQUMsYUFBYSxFQUFFLENBQUM7U0FDdEI7YUFBTTtZQUNMLGNBQWMsQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFDLEtBQUssRUFBRSxLQUFLLENBQUMsQ0FBQyxDQUFDO1NBQzFE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QUM7SUFFRCxNQUFNLENBQUMsS0FBdUIsRUFBRSxLQUF1QjtRQUNyRCxJQUFJLEtBQUssS0FBSyxTQUFTLEVBQUU7WUFDdkIsT0FBTyxLQUFLLENBQUM7U0FDZDthQUFNLElBQUksS0FBSyxLQUFLLFNBQVMsRUFBRTtZQUM5QixPQUFPLEtBQUssQ0FBQztTQUNkO1FBQ0QsT0FBTyxLQUFLLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsS0FBSyxHQUFHLEtBQUssQ0FBQztJQUN0RCxDQUFDO0lBRU8sYUFBYTtRQUNuQixJQUFJLElBQUksQ0FBQyxRQUFRLEtBQUssU0FBUyxFQUFFO1lBQy9CLE1BQU0sc0JBQXNCLENBQUMsSUFBSSxDQUFDLENBQUM7U0FDcEM7UUFDRCxNQUFNLE9BQU8sR0FBdUIsT0FBTyxJQUFJLENBQUMsUUFBUSxLQUFLLFVBQVUsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLFFBQVEsRUFBRSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDO1FBRTFHLE1BQU0sR0FBRyxHQUFXLE9BQU8sQ0FBQyxHQUFHLEtBQUssU0FBUyxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxXQUFXLENBQUM7UUFDMUUsTUFBTSxHQUFHLEdBQVcsT0FBTyxDQUFDLEdBQUcsS0FBSyxTQUFTLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLFdBQVcsQ0FBQztRQUUxRSxNQUFNLENBQUMsTUFBTSxDQUFDLElBQUksRUFBRSxFQUFDLEdBQUcsRUFBRSxHQUFHLEVBQUMsQ0FBQyxDQUFDO0lBQ2xDLENBQUM7Q0FDRiIsImZpbGUiOiJsaWIvdHlwZXMvaW50ZWdlci5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluY2lkZW50IH0gZnJvbSBcImluY2lkZW50XCI7XG5pbXBvcnQgeyBsYXp5UHJvcGVydGllcyB9IGZyb20gXCIuLi9faGVscGVycy9sYXp5LXByb3BlcnRpZXNcIjtcbmltcG9ydCB7IElvVHlwZSwgTGF6eSwgT3JkLCBSZWFkZXIsIFZlcnNpb25lZFR5cGUsIFdyaXRlciB9IGZyb20gXCIuLi9jb3JlXCI7XG5pbXBvcnQgeyBjcmVhdGVJbnZhbGlkSW50ZWdlckVycm9yIH0gZnJvbSBcIi4uL2Vycm9ycy9pbnZhbGlkLWludGVnZXJcIjtcbmltcG9ydCB7IGNyZWF0ZUludmFsaWRUeXBlRXJyb3IgfSBmcm9tIFwiLi4vZXJyb3JzL2ludmFsaWQtdHlwZVwiO1xuaW1wb3J0IHsgY3JlYXRlTGF6eU9wdGlvbnNFcnJvciB9IGZyb20gXCIuLi9lcnJvcnMvbGF6eS1vcHRpb25zXCI7XG5pbXBvcnQgeyByZWFkVmlzaXRvciB9IGZyb20gXCIuLi9yZWFkZXJzL3JlYWQtdmlzaXRvclwiO1xuXG5leHBvcnQgdHlwZSBOYW1lID0gXCJpbnRlZ2VyXCI7XG5leHBvcnQgY29uc3QgbmFtZTogTmFtZSA9IFwiaW50ZWdlclwiO1xuZXhwb3J0IG5hbWVzcGFjZSBqc29uIHtcbiAgZXhwb3J0IGludGVyZmFjZSBUeXBlIHtcbiAgICBuYW1lOiBOYW1lO1xuICAgIG1pbjogbnVtYmVyO1xuICAgIG1heDogbnVtYmVyO1xuICB9XG59XG5leHBvcnQgdHlwZSBEaWZmID0gbnVtYmVyO1xuXG4vKipcbiAqIE9wdGlvbnMgZm9yIHRoZSBgaW50ZWdlcmAgdHlwZS5cbiAqL1xuZXhwb3J0IGludGVyZmFjZSBJbnRlZ2VyVHlwZU9wdGlvbnMge1xuICAvKipcbiAgICogSW5jbHVzaXZlIG1pbmltdW0gdmFsdWUuXG4gICAqL1xuICBtaW4/OiBudW1iZXI7XG5cbiAgLyoqXG4gICAqIEluY2x1c2l2ZSBtYXhpbXVtIHZhbHVlLlxuICAgKi9cbiAgbWF4PzogbnVtYmVyO1xufVxuXG4vKipcbiAqIERlZmF1bHQgdmFsdWUgZm9yIHRoZSBgbWluYCBvcHRpb24uXG4gKiBJdCBjb3JyZXNwb25kcyB0byBgLSgyKio1MylgLlxuICovXG5leHBvcnQgY29uc3QgREVGQVVMVF9NSU46IG51bWJlciA9IE51bWJlci5NSU5fU0FGRV9JTlRFR0VSIC0gMTtcblxuLyoqXG4gKiBEZWZhdWx0IHZhbHVlIGZvciB0aGUgYG1heGAgb3B0aW9uLlxuICogSXQgY29ycmVzcG9uZHMgdG8gYDIqKjUzIC0gMWAuXG4gKi9cbmV4cG9ydCBjb25zdCBERUZBVUxUX01BWDogbnVtYmVyID0gTnVtYmVyLk1BWF9TQUZFX0lOVEVHRVI7XG5cbmV4cG9ydCBjbGFzcyBJbnRlZ2VyVHlwZSBpbXBsZW1lbnRzIElvVHlwZTxudW1iZXI+LCBWZXJzaW9uZWRUeXBlPG51bWJlciwgRGlmZj4sIE9yZDxudW1iZXI+IHtcblxuICByZWFkb25seSBuYW1lOiBOYW1lID0gbmFtZTtcbiAgcmVhZG9ubHkgbWluITogbnVtYmVyO1xuICByZWFkb25seSBtYXghOiBudW1iZXI7XG5cbiAgcHJpdmF0ZSBfb3B0aW9uczogTGF6eTxJbnRlZ2VyVHlwZU9wdGlvbnM+O1xuXG4gIGNvbnN0cnVjdG9yKG9wdGlvbnM/OiBMYXp5PEludGVnZXJUeXBlT3B0aW9ucz4pIHtcbiAgICBpZiAob3B0aW9ucyA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICB0aGlzLl9vcHRpb25zID0ge307XG4gICAgICB0aGlzLl9hcHBseU9wdGlvbnMoKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgdGhpcy5fb3B0aW9ucyA9IG9wdGlvbnM7XG4gICAgaWYgKHR5cGVvZiBvcHRpb25zICE9PSBcImZ1bmN0aW9uXCIpIHtcbiAgICAgIHRoaXMuX2FwcGx5T3B0aW9ucygpO1xuICAgIH0gZWxzZSB7XG4gICAgICBsYXp5UHJvcGVydGllcyh0aGlzLCB0aGlzLl9hcHBseU9wdGlvbnMsIFtcIm1pblwiLCBcIm1heFwiXSk7XG4gICAgfVxuICB9XG5cbiAgc3RhdGljIGZyb21KU09OKG9wdGlvbnM6IGpzb24uVHlwZSk6IEludGVnZXJUeXBlIHtcbiAgICByZXR1cm4gbmV3IEludGVnZXJUeXBlKG9wdGlvbnMpO1xuICB9XG5cbiAgdG9KU09OKCk6IGpzb24uVHlwZSB7XG4gICAgcmV0dXJuIHtuYW1lLCBtaW46IHRoaXMubWluLCBtYXg6IHRoaXMubWF4fTtcbiAgfVxuXG4gIHJlYWQ8Uj4ocmVhZGVyOiBSZWFkZXI8Uj4sIHJhdzogUik6IG51bWJlciB7XG4gICAgcmV0dXJuIHJlYWRlci5yZWFkRmxvYXQ2NChyYXcsIHJlYWRWaXNpdG9yKHtcbiAgICAgIGZyb21GbG9hdDY0OiAoaW5wdXQ6IG51bWJlcik6IG51bWJlciA9PiB7XG4gICAgICAgIGNvbnN0IGVycm9yOiBFcnJvciB8IHVuZGVmaW5lZCA9IHJlYWRlci50cnVzdElucHV0ID8gdW5kZWZpbmVkIDogdGhpcy50ZXN0RXJyb3IoaW5wdXQpO1xuICAgICAgICBpZiAoZXJyb3IgIT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgIHRocm93IGVycm9yO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBpbnB1dDtcbiAgICAgIH0sXG4gICAgfSkpO1xuICB9XG5cbiAgLy8gVE9ETzogRHluYW1pY2FsbHkgYWRkIHdpdGggcHJvdG90eXBlP1xuICB3cml0ZTxXPih3cml0ZXI6IFdyaXRlcjxXPiwgdmFsdWU6IG51bWJlcik6IFcge1xuICAgIHJldHVybiB3cml0ZXIud3JpdGVGbG9hdDY0KHZhbHVlKTtcbiAgfVxuXG4gIHRlc3RFcnJvcih2YWw6IG51bWJlcik6IEVycm9yIHwgdW5kZWZpbmVkIHtcbiAgICBpZiAodHlwZW9mIHZhbCAhPT0gXCJudW1iZXJcIikge1xuICAgICAgcmV0dXJuIGNyZWF0ZUludmFsaWRUeXBlRXJyb3IoXCJudW1iZXJcIiwgdmFsKTtcbiAgICB9XG4gICAgaWYgKE1hdGgucm91bmQodmFsKSAhPT0gdmFsKSB7XG4gICAgICByZXR1cm4gY3JlYXRlSW52YWxpZEludGVnZXJFcnJvcih2YWwpO1xuICAgIH1cbiAgICBpZiAodmFsIDwgdGhpcy5taW4gfHwgdmFsID4gdGhpcy5tYXgpIHtcbiAgICAgIHJldHVybiBuZXcgSW5jaWRlbnQoXCJSYW5nZVwiLCB7dmFsdWU6IHZhbCwgbWluOiB0aGlzLm1pbiwgbWF4OiB0aGlzLm1heH0sIFwiSW50ZWdlciBub3QgaW4gcmFuZ2VcIik7XG4gICAgfVxuICAgIHJldHVybiB1bmRlZmluZWQ7XG4gIH1cblxuICB0ZXN0KHZhbDogbnVtYmVyKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIHR5cGVvZiB2YWwgPT09IFwibnVtYmVyXCIgJiYgdmFsID49IHRoaXMubWluICYmIHZhbCA8PSB0aGlzLm1heCAmJiBNYXRoLnJvdW5kKHZhbCkgPT09IHZhbDtcbiAgfVxuXG4gIGVxdWFscyhsZWZ0OiBudW1iZXIsIHJpZ2h0OiBudW1iZXIpOiBib29sZWFuIHtcbiAgICByZXR1cm4gbGVmdCA9PT0gcmlnaHQ7XG4gIH1cblxuICBsdGUobGVmdDogbnVtYmVyLCByaWdodDogbnVtYmVyKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIGxlZnQgPD0gcmlnaHQ7XG4gIH1cblxuICBjbG9uZSh2YWw6IG51bWJlcik6IG51bWJlciB7XG4gICAgcmV0dXJuIHZhbDtcbiAgfVxuXG4gIGRpZmYob2xkVmFsOiBudW1iZXIsIG5ld1ZhbDogbnVtYmVyKTogRGlmZiB8IHVuZGVmaW5lZCB7XG4gICAgcmV0dXJuIG5ld1ZhbCA9PT0gb2xkVmFsID8gdW5kZWZpbmVkIDogbmV3VmFsIC0gb2xkVmFsO1xuICB9XG5cbiAgcGF0Y2gob2xkVmFsOiBudW1iZXIsIGRpZmY6IERpZmYgfCB1bmRlZmluZWQpOiBudW1iZXIge1xuICAgIHJldHVybiBkaWZmID09PSB1bmRlZmluZWQgPyBvbGRWYWwgOiBvbGRWYWwgKyBkaWZmIGFzIG51bWJlcjtcbiAgfVxuXG4gIHJldmVyc2VEaWZmKGRpZmY6IERpZmYgfCB1bmRlZmluZWQpOiBEaWZmIHwgdW5kZWZpbmVkIHtcbiAgICAvKiB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6c3RyaWN0LWJvb2xlYW4tZXhwcmVzc2lvbnMgKi9cbiAgICByZXR1cm4gZGlmZiAmJiAtZGlmZjtcbiAgfVxuXG4gIHNxdWFzaChkaWZmMTogRGlmZiB8IHVuZGVmaW5lZCwgZGlmZjI6IERpZmYgfCB1bmRlZmluZWQpOiBEaWZmIHwgdW5kZWZpbmVkIHtcbiAgICBpZiAoZGlmZjEgPT09IHVuZGVmaW5lZCkge1xuICAgICAgcmV0dXJuIGRpZmYyO1xuICAgIH0gZWxzZSBpZiAoZGlmZjIgPT09IHVuZGVmaW5lZCkge1xuICAgICAgcmV0dXJuIGRpZmYxO1xuICAgIH1cbiAgICByZXR1cm4gZGlmZjIgPT09IC1kaWZmMSA/IHVuZGVmaW5lZCA6IGRpZmYxICsgZGlmZjI7XG4gIH1cblxuICBwcml2YXRlIF9hcHBseU9wdGlvbnMoKTogdm9pZCB7XG4gICAgaWYgKHRoaXMuX29wdGlvbnMgPT09IHVuZGVmaW5lZCkge1xuICAgICAgdGhyb3cgY3JlYXRlTGF6eU9wdGlvbnNFcnJvcih0aGlzKTtcbiAgICB9XG4gICAgY29uc3Qgb3B0aW9uczogSW50ZWdlclR5cGVPcHRpb25zID0gdHlwZW9mIHRoaXMuX29wdGlvbnMgPT09IFwiZnVuY3Rpb25cIiA/IHRoaXMuX29wdGlvbnMoKSA6IHRoaXMuX29wdGlvbnM7XG5cbiAgICBjb25zdCBtaW46IG51bWJlciA9IG9wdGlvbnMubWluICE9PSB1bmRlZmluZWQgPyBvcHRpb25zLm1pbiA6IERFRkFVTFRfTUlOO1xuICAgIGNvbnN0IG1heDogbnVtYmVyID0gb3B0aW9ucy5tYXggIT09IHVuZGVmaW5lZCA/IG9wdGlvbnMubWF4IDogREVGQVVMVF9NQVg7XG5cbiAgICBPYmplY3QuYXNzaWduKHRoaXMsIHttaW4sIG1heH0pO1xuICB9XG59XG4iXSwic291cmNlUm9vdCI6Ii4uLy4uIn0=
