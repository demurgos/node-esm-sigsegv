import { Incident } from "incident";
import { checkedUcs2Decode } from "../_helpers/checked-ucs2-decode";
import { lazyProperties } from "../_helpers/lazy-properties";
import { createInvalidTypeError } from "../errors/invalid-type";
import { createLazyOptionsError } from "../errors/lazy-options";
import { createLowerCaseError } from "../errors/lower-case";
import { createMaxCodepointsError } from "../errors/max-codepoints";
import { createMinCodepointsError } from "../errors/min-codepoints";
import { createMissingDependencyError } from "../errors/missing-dependency";
import { createNotTrimmedError } from "../errors/not-trimmed";
import { createPatternNotMatchedError } from "../errors/pattern-not-matched";
import { readVisitor } from "../readers/read-visitor";
export var Normalization;
(function (Normalization) {
    Normalization[Normalization["None"] = 0] = "None";
    Normalization[Normalization["Nfc"] = 1] = "Nfc";
})(Normalization || (Normalization = {}));
export const name = "codepoint-string";
export class CodepointStringType {
    constructor(options) {
        this.name = name;
        this._options = options;
        if (typeof options !== "function") {
            this._applyOptions();
        }
        else {
            lazyProperties(this, this._applyOptions, [
                "normalization",
                "enforceUnicodeRegExp",
                "pattern",
                "lowerCase",
                "trimmed",
                "minCodepoints",
                "maxCodepoints",
                "unorm",
            ]);
        }
    }
    static fromJSON(options) {
        const resolvedOptions = {
            normalization: options.normalization === "none" ? Normalization.None : Normalization.Nfc,
            enforceUnicodeRegExp: options.enforceUnicodeRegExp,
            lowerCase: options.lowerCase,
            trimmed: options.trimmed,
            maxCodepoints: options.maxCodepoints,
        };
        if (options.pattern !== undefined) {
            resolvedOptions.pattern = new RegExp(options.pattern[0], options.pattern[1]);
        }
        if (options.minCodepoints !== undefined) {
            resolvedOptions.minCodepoints = options.minCodepoints;
        }
        return new CodepointStringType(resolvedOptions);
    }
    toJSON() {
        const jsonType = {
            name,
            normalization: this.normalization === Normalization.None ? "none" : "nfc",
            enforceUnicodeRegExp: this.enforceUnicodeRegExp,
            lowerCase: this.lowerCase,
            trimmed: this.trimmed,
            maxCodepoints: this.maxCodepoints,
        };
        if (this.pattern !== undefined) {
            jsonType.pattern = [this.pattern.source, this.pattern.flags];
        }
        if (this.minCodepoints !== undefined) {
            jsonType.minCodepoints = this.minCodepoints;
        }
        return jsonType;
    }
    // TODO: Dynamically add with prototype?
    read(reader, raw) {
        return reader.readString(raw, readVisitor({
            fromString: (input) => {
                const error = this.testError(input);
                if (error !== undefined) {
                    throw error;
                }
                return input;
            },
        }));
    }
    // TODO: Dynamically add with prototype?
    write(writer, value) {
        return writer.writeString(value);
    }
    testError(val) {
        if (!(typeof val === "string")) {
            return createInvalidTypeError("string", val);
        }
        switch (this.normalization) {
            case Normalization.Nfc:
                if (this.unorm === undefined) {
                    throw createMissingDependencyError("unorm", "Required to normalize unicode strings to NFC.");
                }
                if (val !== this.unorm.nfc(val)) {
                    return Incident("UnicodeNormalization", "Not NFC-Normalized");
                }
                break;
            case Normalization.None:
                break;
            default:
                throw new Incident(`IncompleteSwitch: Received unexpected variant for this.normalization: ${this.normalization}`);
        }
        if (this.lowerCase && val !== val.toLowerCase()) {
            return createLowerCaseError(val);
        }
        if (this.trimmed && val !== val.trim()) {
            return createNotTrimmedError(val);
        }
        let codepointCount;
        try {
            codepointCount = checkedUcs2Decode(val).length;
        }
        catch (err) {
            return err;
        }
        const minCodepoints = this.minCodepoints;
        if (typeof minCodepoints === "number" && codepointCount < minCodepoints) {
            return createMinCodepointsError(val, codepointCount, minCodepoints);
        }
        if (codepointCount > this.maxCodepoints) {
            return createMaxCodepointsError(val, codepointCount, this.maxCodepoints);
        }
        if (this.pattern instanceof RegExp) {
            if (!this.pattern.unicode && this.enforceUnicodeRegExp) {
                throw new Incident("NonUnicodeRegExp", "Enforced unicode RegExp, use `enforceUnicodeRegExp = false` or `Ucs2StringType`");
            }
            if (!this.pattern.test(val)) {
                return createPatternNotMatchedError(this.pattern, val);
            }
        }
        return undefined;
    }
    test(val) {
        return this.testError(val) === undefined;
    }
    equals(val1, val2) {
        return val1 === val2;
    }
    clone(val) {
        return val;
    }
    diff(oldVal, newVal) {
        return oldVal === newVal ? undefined : [oldVal, newVal];
    }
    patch(oldVal, diff) {
        return diff === undefined ? oldVal : diff[1];
    }
    reverseDiff(diff) {
        return diff === undefined ? undefined : [diff[1], diff[0]];
    }
    squash(diff1, diff2) {
        if (diff1 === undefined) {
            return diff2 === undefined ? undefined : [diff2[0], diff2[1]];
        }
        else if (diff2 === undefined) {
            return [diff1[0], diff1[1]];
        }
        return diff1[0] === diff2[1] ? undefined : [diff1[0], diff2[1]];
    }
    _applyOptions() {
        if (this._options === undefined) {
            throw createLazyOptionsError(this);
        }
        const options = typeof this._options === "function" ? this._options() : this._options;
        const normalization = options.normalization !== undefined ?
            options.normalization :
            Normalization.Nfc;
        const enforceUnicodeRegExp = options.enforceUnicodeRegExp !== undefined ?
            options.enforceUnicodeRegExp :
            true;
        const pattern = options.pattern;
        const lowerCase = options.lowerCase !== undefined ? options.lowerCase : false;
        const trimmed = options.trimmed !== undefined ? options.trimmed : false;
        const minCodepoints = options.minCodepoints;
        const maxCodepoints = options.maxCodepoints;
        const unorm = options.unorm;
        Object.assign(this, { normalization, enforceUnicodeRegExp, pattern, lowerCase, trimmed, minCodepoints, maxCodepoints, unorm });
    }
}

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9saWIvdHlwZXMvY29kZXBvaW50LXN0cmluZy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsUUFBUSxFQUFFLE1BQU0sVUFBVSxDQUFDO0FBQ3BDLE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLGlDQUFpQyxDQUFDO0FBQ3BFLE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSw2QkFBNkIsQ0FBQztBQUU3RCxPQUFPLEVBQUUsc0JBQXNCLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQztBQUNoRSxPQUFPLEVBQUUsc0JBQXNCLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQztBQUNoRSxPQUFPLEVBQUUsb0JBQW9CLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQztBQUM1RCxPQUFPLEVBQUUsd0JBQXdCLEVBQUUsTUFBTSwwQkFBMEIsQ0FBQztBQUNwRSxPQUFPLEVBQUUsd0JBQXdCLEVBQUUsTUFBTSwwQkFBMEIsQ0FBQztBQUNwRSxPQUFPLEVBQUUsNEJBQTRCLEVBQUUsTUFBTSw4QkFBOEIsQ0FBQztBQUM1RSxPQUFPLEVBQUUscUJBQXFCLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQztBQUM5RCxPQUFPLEVBQUUsNEJBQTRCLEVBQUUsTUFBTSwrQkFBK0IsQ0FBQztBQUM3RSxPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0seUJBQXlCLENBQUM7QUFRdEQsTUFBTSxDQUFOLElBQVksYUFHWDtBQUhELFdBQVksYUFBYTtJQUN2QixpREFBSSxDQUFBO0lBQ0osK0NBQUcsQ0FBQTtBQUNMLENBQUMsRUFIVyxhQUFhLEtBQWIsYUFBYSxRQUd4QjtBQUdELE1BQU0sQ0FBQyxNQUFNLElBQUksR0FBUyxrQkFBa0IsQ0FBQztBQTZEN0MsTUFBTSxPQUFPLG1CQUFtQjtJQWM5QixZQUFZLE9BQXFDO1FBWnhDLFNBQUksR0FBUyxJQUFJLENBQUM7UUFhekIsSUFBSSxDQUFDLFFBQVEsR0FBRyxPQUFPLENBQUM7UUFDeEIsSUFBSSxPQUFPLE9BQU8sS0FB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LENBQUMsUUFBUSxFQUFFLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUM7UUFFOUcsTUFBTSxhQUFhLEdBQWtCLE9BQU8sQ0FBQyxhQUFhLEtBQUssU0FBUyxDQUFDLENBQUM7WUFDeEUsT0FBTyxDQUFDLGFBQWEsQ0FBQyxDQUFDO1lBQ3ZCLGFBQWEsQ0FBQyxHQUFHLENBQUM7UUFDcEIsTUFBTSxvQkFBb0IsR0FBWSxPQUFPLENBQUMsb0JBQW9CLEtBQUssU0FBUyxDQUFDLENBQUM7WUFDaEYsT0FBTyxDQUFDLG9CQUFvQixDQUFDLENBQUM7WUFDOUIsSUFBSSxDQUFDO1FBQ1AsTUFBTSxPQUFPLEdBQXVCLE9BQU8sQ0FBQyxPQUFPLENBQUM7UUFDcEQsTUFBTSxTQUFTLEdBQVksT0FBTyxDQUFDLFNBQVMsS0FBSyxTQUFTLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQztRQUN2RixNQUFNLE9BQU8sR0FBWSxPQUFPLENBQUMsT0FBTyxLQUFLLFNBQVMsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDO1FBQ2pGLE1BQU0sYUFBYSxHQUF1QixPQUFPLENBQUMsYUFBYSxDQUFDO1FBQ2hFLE1BQU0sYUFBYSxHQUFXLE9BQU8sQ0FBQyxhQUFhLENBQUM7UUFDcEQsTUFBTSxLQUFLLEdBQTBCLE9BQU8sQ0FBQyxLQUFLLENBQUM7UUFFbkQsTUFBTSxDQUFDLE1BQU0sQ0FDWCxJQUFJLEVBQ0osRUFBQyxhQUFhLEVBQUUsb0JBQW9CLEVBQUUsT0FBTyxFQUFFLFNBQVMsRUFBRSxPQUFPLEVBQUUsYUFBYSxFQUFFLGFBQWEsRUFBRSxLQUFLLEVBQUMsQ0FDeEcsQ0FBQztJQUNKLENBQUM7Q0FDRiIsImZpbGUiOiJsaWIvdHlwZXMvY29kZXBvaW50LXN0cmluZy5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluY2lkZW50IH0gZnJvbSBcImluY2lkZW50XCI7XG5pbXBvcnQgeyBjaGVja2VkVWNzMkRlY29kZSB9IGZyb20gXCIuLi9faGVscGVycy9jaGVja2VkLXVjczItZGVjb2RlXCI7XG5pbXBvcnQgeyBsYXp5UHJvcGVydGllcyB9IGZyb20gXCIuLi9faGVscGVycy9sYXp5LXByb3BlcnRpZXNcIjtcbmltcG9ydCB7IElvVHlwZSwgTGF6eSwgUmVhZGVyLCBWZXJzaW9uZWRUeXBlLCBXcml0ZXIgfSBmcm9tIFwiLi4vY29yZVwiO1xuaW1wb3J0IHsgY3JlYXRlSW52YWxpZFR5cGVFcnJvciB9IGZyb20gXCIuLi9lcnJvcnMvaW52YWxpZC10eXBlXCI7XG5pbXBvcnQgeyBjcmVhdGVMYXp5T3B0aW9uc0Vycm9yIH0gZnJvbSBcIi4uL2Vycm9ycy9sYXp5LW9wdGlvbnNcIjtcbmltcG9ydCB7IGNyZWF0ZUxvd2VyQ2FzZUVycm9yIH0gZnJvbSBcIi4uL2Vycm9ycy9sb3dlci1jYXNlXCI7XG5pbXBvcnQgeyBjcmVhdGVNYXhDb2RlcG9pbnRzRXJyb3IgfSBmcm9tIFwiLi4vZXJyb3JzL21heC1jb2RlcG9pbnRzXCI7XG5pbXBvcnQgeyBjcmVhdGVNaW5Db2RlcG9pbnRzRXJyb3IgfSBmcm9tIFwiLi4vZXJyb3JzL21pbi1jb2RlcG9pbnRzXCI7XG5pbXBvcnQgeyBjcmVhdGVNaXNzaW5nRGVwZW5kZW5jeUVycm9yIH0gZnJvbSBcIi4uL2Vycm9ycy9taXNzaW5nLWRlcGVuZGVuY3lcIjtcbmltcG9ydCB7IGNyZWF0ZU5vdFRyaW1tZWRFcnJvciB9IGZyb20gXCIuLi9lcnJvcnMvbm90LXRyaW1tZWRcIjtcbmltcG9ydCB7IGNyZWF0ZVBhdHRlcm5Ob3RNYXRjaGVkRXJyb3IgfSBmcm9tIFwiLi4vZXJyb3JzL3BhdHRlcm4tbm90LW1hdGNoZWRcIjtcbmltcG9ydCB7IHJlYWRWaXNpdG9yIH0gZnJvbSBcIi4uL3JlYWRlcnMvcmVhZC12aXNpdG9yXCI7XG5cbmV4cG9ydCB0eXBlIFVub3JtTmZjID0gKHN0cjogc3RyaW5nKSA9PiBzdHJpbmc7XG5cbmV4cG9ydCBpbnRlcmZhY2UgVW5vcm1MaWtlIHtcbiAgbmZjOiBVbm9ybU5mYztcbn1cblxuZXhwb3J0IGVudW0gTm9ybWFsaXphdGlvbiB7XG4gIE5vbmUsXG4gIE5mYyxcbn1cblxuZXhwb3J0IHR5cGUgTmFtZSA9IFwiY29kZXBvaW50LXN0cmluZ1wiO1xuZXhwb3J0IGNvbnN0IG5hbWU6IE5hbWUgPSBcImNvZGVwb2ludC1zdHJpbmdcIjtcbmV4cG9ydCBuYW1lc3BhY2UganNvbiB7XG4gIGV4cG9ydCBpbnRlcmZhY2UgVHlwZSB7XG4gICAgbmFtZTogTmFtZTtcbiAgICBub3JtYWxpemF0aW9uOiBcIm5vbmVcIiB8IFwibmZjXCI7XG4gICAgZW5mb3JjZVVuaWNvZGVSZWdFeHA6IGJvb2xlYW47XG4gICAgcGF0dGVybj86IFtzdHJpbmcsIHN0cmluZ107XG4gICAgbG93ZXJDYXNlOiBib29sZWFuO1xuICAgIC8qKlxuICAgICAqIEBzZWUgW1tVY3MyU3RyaW5nT3B0aW9ucy50cmltbWVkXV1cbiAgICAgKi9cbiAgICB0cmltbWVkOiBib29sZWFuO1xuICAgIG1pbkNvZGVwb2ludHM/OiBudW1iZXI7XG4gICAgbWF4Q29kZXBvaW50czogbnVtYmVyO1xuICB9XG59XG5leHBvcnQgdHlwZSBEaWZmID0gW3N0cmluZywgc3RyaW5nXTtcblxuZXhwb3J0IGludGVyZmFjZSBDb2RlcG9pbnRTdHJpbmdPcHRpb25zIHtcbiAgLyoqXG4gICAqIEVuc3VyZSBORkMgbm9ybWFsaXphdGlvbiB3aGVuIHJlYWRpbmcgc3RyaW5ncy5cbiAgICpcbiAgICogUmVmZXJlbmNlczpcbiAgICogLSBodHRwOi8vdW5pY29kZS5vcmcvZmFxL25vcm1hbGl6YXRpb24uaHRtbFxuICAgKiAtIGh0dHA6Ly91bmljb2RlLm9yZy9yZXBvcnRzL3RyMTUvXG4gICAqL1xuICBub3JtYWxpemF0aW9uPzogTm9ybWFsaXphdGlvbjtcblxuICBlbmZvcmNlVW5pY29kZVJlZ0V4cD86IGJvb2xlYW47XG4gIHBhdHRlcm4/OiBSZWdFeHA7XG4gIGxvd2VyQ2FzZT86IGJvb2xlYW47XG5cbiAgLyoqXG4gICAqIFRoZSBzdHJpbmcgY2Fubm90IHN0YXJ0IG9yIGVuZCB3aXRoIGFueSBvZiB0aGUgZm9sbG93aW5nIHdoaXRlc3BhY2UgYW5kIGxpbmUgdGVybWluYXRvclxuICAgKiBjaGFyYWN0ZXJzOlxuICAgKlxuICAgKiAtIFVuaWNvZGUgQ2hhcmFjdGVyICdDSEFSQUNURVIgVEFCVUxBVElPTicgKFUrMDAwOSlcbiAgICogLSBVbmljb2RlIENoYXJhY3RlciAnTElORSBGRUVEIChMRiknIChVKzAwMEEpXG4gICAqIC0gVW5pY29kZSBDaGFyYWN0ZXIgJ0xJTkUgVEFCVUxBVElPTicgKFUrMDAwQilcbiAgICogLSBVbmljb2RlIENoYXJhY3RlciAnRk9STSBGRUVEIChGRiknIChVKzAwMEMpXG4gICAqIC0gVW5pY29kZSBDaGFyYWN0ZXIgJ0NBUlJJQUdFIFJFVFVSTiAoQ1IpJyAoVSswMDBEKVxuICAgKiAtIFVuaWNvZGUgQ2hhcmFjdGVyICdTUEFDRScgKFUrMDAyMClcbiAgICogLSBVbmljb2RlIENoYXJhY3RlciAnTk8tQlJFQUsgU1BBQ0UnIChVKzAwQTApXG4gICAqIC0gVW5pY29kZSBDaGFyYWN0ZXIgJ0xJTkUgU0VQQVJBVE9SJyAoVSsyMDI4KVxuICAgKiAtIFVuaWNvZGUgQ2hhcmFjdGVyICdQQVJBR1JBUEggU0VQQVJBVE9SJyAoVSsyMDI5KVxuICAgKiAtIFVuaWNvZGUgQ2hhcmFjdGVyICdaRVJPIFdJRFRIIE5PLUJSRUFLIFNQQUNFJyAoVStGRUZGKVxuICAgKiAtIEFueSBvdGhlciBVbmljb2RlIGNoYXJhY3RlciBvZiB0aGUgXCJTZXBhcmF0b3IsIHNwYWNlXCIgKFpzKSBnZW5lcmFsIGNhdGVnb3J5XG4gICAqXG4gICAqIEBzZWUgPGh0dHBzOi8vZGV2ZWxvcGVyLm1vemlsbGEub3JnL2VuLVVTL2RvY3MvV2ViL0phdmFTY3JpcHQvUmVmZXJlbmNlL0dsb2JhbF9PYmplY3RzL1N0cmluZy9UcmltPlxuICAgKiBAc2VlIDxodHRwOi8vd3d3LmZpbGVmb3JtYXQuaW5mby9pbmZvL3VuaWNvZGUvY2F0ZWdvcnkvWnMvbGlzdC5odG0+XG4gICAqL1xuICB0cmltbWVkPzogYm9vbGVhbjtcbiAgbWluQ29kZXBvaW50cz86IG51bWJlcjtcbiAgbWF4Q29kZXBvaW50czogbnVtYmVyO1xuXG4gIC8qKlxuICAgKiBVbmljb2RlIG5vcm1hbGl6YXRpb24gbGlicmFyeSB0byB1c2UuXG4gICAqL1xuICB1bm9ybT86IFVub3JtTGlrZTtcbn1cblxuZXhwb3J0IGNsYXNzIENvZGVwb2ludFN0cmluZ1R5cGUgaW1wbGVtZW50cyBJb1R5cGU8c3RyaW5nPiwgVmVyc2lvbmVkVHlwZTxzdHJpbmcsIERpZmY+IHtcblxuICByZWFkb25seSBuYW1lOiBOYW1lID0gbmFtZTtcbiAgcmVhZG9ubHkgbm9ybWFsaXphdGlvbiE6IE5vcm1hbGl6YXRpb247XG4gIHJlYWRvbmx5IGVuZm9yY2VVbmljb2RlUmVnRXhwITogYm9vbGVhbjtcbiAgcmVhZG9ubHkgcGF0dGVybj86IFJlZ0V4cDtcbiAgcmVhZG9ubHkgbG93ZXJDYXNlITogYm9vbGVhbjtcbiAgcmVhZG9ubHkgdHJpbW1lZCE6IGJvb2xlYW47XG4gIHJlYWRvbmx5IG1pbkNvZGVwb2ludHM/OiBudW1iZXI7XG4gIHJlYWRvbmx5IG1heENvZGVwb2ludHMhOiBudW1iZXI7XG4gIHJlYWRvbmx5IHVub3JtPzogVW5vcm1MaWtlO1xuXG4gIHByaXZhdGUgX29wdGlvbnM6IExhenk8Q29kZXBvaW50U3RyaW5nT3B0aW9ucz47XG5cbiAgY29uc3RydWN0b3Iob3B0aW9uczogTGF6eTxDb2RlcG9pbnRTdHJpbmdPcHRpb25zPikge1xuICAgIHRoaXMuX29wdGlvbnMgPSBvcHRpb25zO1xuICAgIGlmICh0eXBlb2Ygb3B0aW9ucyAhPT0gXCJmdW5jdGlvblwiKSB7XG4gICAgICB0aGlzLl9hcHBseU9wdGlvbnMoKTtcbiAgICB9IGVsc2Uge1xuICAgICAgbGF6eVByb3BlcnRpZXMoXG4gICAgICAgIHRoaXMsXG4gICAgICAgIHRoaXMuX2FwcGx5T3B0aW9ucyxcbiAgICAgICAgW1xuICAgICAgICAgIFwibm9ybWFsaXphdGlvblwiLFxuICAgICAgICAgIFwiZW5mb3JjZVVuaWNvZGVSZWdFeHBcIixcbiAgICAgICAgICBcInBhdHRlcm5cIixcbiAgICAgICAgICBcImxvd2VyQ2FzZVwiLFxuICAgICAgICAgIFwidHJpbW1lZFwiLFxuICAgICAgICAgIFwibWluQ29kZXBvaW50c1wiLFxuICAgICAgICAgIFwibWF4Q29kZXBvaW50c1wiLFxuICAgICAgICAgIFwidW5vcm1cIixcbiAgICAgICAgXSxcbiAgICAgICk7XG4gICAgfVxuICB9XG5cbiAgc3RhdGljIGZyb21KU09OKG9wdGlvbnM6IGpzb24uVHlwZSk6IENvZGVwb2ludFN0cmluZ1R5cGUge1xuICAgIGNvbnN0IHJlc29sdmVkT3B0aW9uczogQ29kZXBvaW50U3RyaW5nT3B0aW9ucyA9IHtcbiAgICAgIG5vcm1hbGl6YXRpb246IG9wdGlvbnMubm9ybWFsaXphdGlvbiA9PT0gXCJub25lXCIgPyBOb3JtYWxpemF0aW9uLk5vbmUgOiBOb3JtYWxpemF0aW9uLk5mYyxcbiAgICAgIGVuZm9yY2VVbmljb2RlUmVnRXhwOiBvcHRpb25zLmVuZm9yY2VVbmljb2RlUmVnRXhwLFxuICAgICAgbG93ZXJDYXNlOiBvcHRpb25zLmxvd2VyQ2FzZSxcbiAgICAgIHRyaW1tZWQ6IG9wdGlvbnMudHJpbW1lZCxcbiAgICAgIG1heENvZGVwb2ludHM6IG9wdGlvbnMubWF4Q29kZXBvaW50cyxcbiAgICB9O1xuICAgIGlmIChvcHRpb25zLnBhdHRlcm4gIT09IHVuZGVmaW5lZCkge1xuICAgICAgcmVzb2x2ZWRPcHRpb25zLnBhdHRlcm4gPSBuZXcgUmVnRXhwKG9wdGlvbnMucGF0dGVyblswXSwgb3B0aW9ucy5wYXR0ZXJuWzFdKTtcbiAgICB9XG4gICAgaWYgKG9wdGlvbnMubWluQ29kZXBvaW50cyAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICByZXNvbHZlZE9wdGlvbnMubWluQ29kZXBvaW50cyA9IG9wdGlvbnMubWluQ29kZXBvaW50cztcbiAgICB9XG4gICAgcmV0dXJuIG5ldyBDb2RlcG9pbnRTdHJpbmdUeXBlKHJlc29sdmVkT3B0aW9ucyk7XG4gIH1cblxuICB0b0pTT04oKToganNvbi5UeXBlIHtcbiAgICBjb25zdCBqc29uVHlwZToganNvbi5UeXBlID0ge1xuICAgICAgbmFtZSxcbiAgICAgIG5vcm1hbGl6YXRpb246IHRoaXMubm9ybWFsaXphdGlvbiA9PT0gTm9ybWFsaXphdGlvbi5Ob25lID8gXCJub25lXCIgOiBcIm5mY1wiLFxuICAgICAgZW5mb3JjZVVuaWNvZGVSZWdFeHA6IHRoaXMuZW5mb3JjZVVuaWNvZGVSZWdFeHAsXG4gICAgICBsb3dlckNhc2U6IHRoaXMubG93ZXJDYXNlLFxuICAgICAgdHJpbW1lZDogdGhpcy50cmltbWVkLFxuICAgICAgbWF4Q29kZXBvaW50czogdGhpcy5tYXhDb2RlcG9pbnRzLFxuICAgIH07XG4gICAgaWYgKHRoaXMucGF0dGVybiAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICBqc29uVHlwZS5wYXR0ZXJuID0gW3RoaXMucGF0dGVybi5zb3VyY2UsIHRoaXMucGF0dGVybi5mbGFnc107XG4gICAgfVxuICAgIGlmICh0aGlzLm1pbkNvZGVwb2ludHMgIT09IHVuZGVmaW5lZCkge1xuICAgICAganNvblR5cGUubWluQ29kZXBvaW50cyA9IHRoaXMubWluQ29kZXBvaW50cztcbiAgICB9XG4gICAgcmV0dXJuIGpzb25UeXBlO1xuICB9XG5cbiAgLy8gVE9ETzogRHluYW1pY2FsbHkgYWRkIHdpdGggcHJvdG90eXBlP1xuICByZWFkPFI+KHJlYWRlcjogUmVhZGVyPFI+LCByYXc6IFIpOiBzdHJpbmcge1xuICAgIHJldHVybiByZWFkZXIucmVhZFN0cmluZyhyYXcsIHJlYWRWaXNpdG9yKHtcbiAgICAgIGZyb21TdHJpbmc6IChpbnB1dDogc3RyaW5nKTogc3RyaW5nID0+IHtcbiAgICAgICAgY29uc3QgZXJyb3I6IEVycm9yIHwgdW5kZWZpbmVkID0gdGhpcy50ZXN0RXJyb3IoaW5wdXQpO1xuICAgICAgICBpZiAoZXJyb3IgIT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgIHRocm93IGVycm9yO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBpbnB1dDtcbiAgICAgIH0sXG4gICAgfSkpO1xuICB9XG5cbiAgLy8gVE9ETzogRHluYW1pY2FsbHkgYWRkIHdpdGggcHJvdG90eXBlP1xuICB3cml0ZTxXPih3cml0ZXI6IFdyaXRlcjxXPiwgdmFsdWU6IHN0cmluZyk6IFcge1xuICAgIHJldHVybiB3cml0ZXIud3JpdGVTdHJpbmcodmFsdWUpO1xuICB9XG5cbiAgdGVzdEVycm9yKHZhbDogc3RyaW5nKTogRXJyb3IgfCB1bmRlZmluZWQge1xuICAgIGlmICghKHR5cGVvZiB2YWwgPT09IFwic3RyaW5nXCIpKSB7XG4gICAgICByZXR1cm4gY3JlYXRlSW52YWxpZFR5cGVFcnJvcihcInN0cmluZ1wiLCB2YWwpO1xuICAgIH1cblxuICAgIHN3aXRjaCAodGhpcy5ub3JtYWxpemF0aW9uKSB7XG4gICAgICBjYXNlIE5vcm1hbGl6YXRpb24uTmZjOlxuICAgICAgICBpZiAodGhpcy51bm9ybSA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgdGhyb3cgY3JlYXRlTWlzc2luZ0RlcGVuZGVuY3lFcnJvcihcInVub3JtXCIsIFwiUmVxdWlyZWQgdG8gbm9ybWFsaXplIHVuaWNvZGUgc3RyaW5ncyB0byBORkMuXCIpO1xuICAgICAgICB9XG4gICAgICAgIGlmICh2YWwgIT09IHRoaXMudW5vcm0ubmZjKHZhbCkpIHtcbiAgICAgICAgICByZXR1cm4gSW5jaWRlbnQoXCJVbmljb2RlTm9ybWFsaXphdGlvblwiLCBcIk5vdCBORkMtTm9ybWFsaXplZFwiKTtcbiAgICAgICAgfVxuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgTm9ybWFsaXphdGlvbi5Ob25lOlxuICAgICAgICBicmVhaztcbiAgICAgIGRlZmF1bHQ6XG4gICAgICAgIHRocm93IG5ldyBJbmNpZGVudChcbiAgICAgICAgICBgSW5jb21wbGV0ZVN3aXRjaDogUmVjZWl2ZWQgdW5leHBlY3RlZCB2YXJpYW50IGZvciB0aGlzLm5vcm1hbGl6YXRpb246ICR7dGhpcy5ub3JtYWxpemF0aW9ufWAsXG4gICAgICAgICk7XG4gICAgfVxuXG4gICAgaWYgKHRoaXMubG93ZXJDYXNlICYmIHZhbCAhPT0gdmFsLnRvTG93ZXJDYXNlKCkpIHtcbiAgICAgIHJldHVybiBjcmVhdGVMb3dlckNhc2VFcnJvcih2YWwpO1xuICAgIH1cblxuICAgIGlmICh0aGlzLnRyaW1tZWQgJiYgdmFsICE9PSB2YWwudHJpbSgpKSB7XG4gICAgICByZXR1cm4gY3JlYXRlTm90VHJpbW1lZEVycm9yKHZhbCk7XG4gICAgfVxuXG4gICAgbGV0IGNvZGVwb2ludENvdW50OiBudW1iZXI7XG4gICAgdHJ5IHtcbiAgICAgIGNvZGVwb2ludENvdW50ID0gY2hlY2tlZFVjczJEZWNvZGUodmFsKS5sZW5ndGg7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICByZXR1cm4gZXJyO1xuICAgIH1cblxuICAgIGNvbnN0IG1pbkNvZGVwb2ludHM6IG51bWJlciB8IHVuZGVmaW5lZCA9IHRoaXMubWluQ29kZXBvaW50cztcbiAgICBpZiAodHlwZW9mIG1pbkNvZGVwb2ludHMgPT09IFwibnVtYmVyXCIgJiYgY29kZXBvaW50Q291bnQgPCBtaW5Db2RlcG9pbnRzKSB7XG4gICAgICByZXR1cm4gY3JlYXRlTWluQ29kZXBvaW50c0Vycm9yKHZhbCwgY29kZXBvaW50Q291bnQsIG1pbkNvZGVwb2ludHMpO1xuICAgIH1cblxuICAgIGlmIChjb2RlcG9pbnRDb3VudCA+IHRoaXMubWF4Q29kZXBvaW50cykge1xuICAgICAgcmV0dXJuIGNyZWF0ZU1heENvZGVwb2ludHNFcnJvcih2YWwsIGNvZGVwb2ludENvdW50LCB0aGlzLm1heENvZGVwb2ludHMpO1xuICAgIH1cblxuICAgIGlmICh0aGlzLnBhdHRlcm4gaW5zdGFuY2VvZiBSZWdFeHApIHtcbiAgICAgIGlmICghdGhpcy5wYXR0ZXJuLnVuaWNvZGUgJiYgdGhpcy5lbmZvcmNlVW5pY29kZVJlZ0V4cCkge1xuICAgICAgICB0aHJvdyBuZXcgSW5jaWRlbnQoXG4gICAgICAgICAgXCJOb25Vbmljb2RlUmVnRXhwXCIsXG4gICAgICAgICAgXCJFbmZvcmNlZCB1bmljb2RlIFJlZ0V4cCwgdXNlIGBlbmZvcmNlVW5pY29kZVJlZ0V4cCA9IGZhbHNlYCBvciBgVWNzMlN0cmluZ1R5cGVgXCIsXG4gICAgICAgICk7XG4gICAgICB9XG5cbiAgICAgIGlmICghdGhpcy5wYXR0ZXJuLnRlc3QodmFsKSkge1xuICAgICAgICByZXR1cm4gY3JlYXRlUGF0dGVybk5vdE1hdGNoZWRFcnJvcih0aGlzLnBhdHRlcm4sIHZhbCk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgfVxuXG4gIHRlc3QodmFsOiBzdHJpbmcpOiBib29sZWFuIHtcbiAgICByZXR1cm4gdGhpcy50ZXN0RXJyb3IodmFsKSA9PT0gdW5kZWZpbmVkO1xuICB9XG5cbiAgZXF1YWxzKHZhbDE6IHN0cmluZywgdmFsMjogc3RyaW5nKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIHZhbDEgPT09IHZhbDI7XG4gIH1cblxuICBjbG9uZSh2YWw6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgcmV0dXJuIHZhbDtcbiAgfVxuXG4gIGRpZmYob2xkVmFsOiBzdHJpbmcsIG5ld1ZhbDogc3RyaW5nKTogRGlmZiB8IHVuZGVmaW5lZCB7XG4gICAgcmV0dXJuIG9sZFZhbCA9PT0gbmV3VmFsID8gdW5kZWZpbmVkIDogW29sZFZhbCwgbmV3VmFsXTtcbiAgfVxuXG4gIHBhdGNoKG9sZFZhbDogc3RyaW5nLCBkaWZmOiBEaWZmIHwgdW5kZWZpbmVkKTogc3RyaW5nIHtcbiAgICByZXR1cm4gZGlmZiA9PT0gdW5kZWZpbmVkID8gb2xkVmFsIDogZGlmZlsxXTtcbiAgfVxuXG4gIHJldmVyc2VEaWZmKGRpZmY6IERpZmYgfCB1bmRlZmluZWQpOiBEaWZmIHwgdW5kZWZpbmVkIHtcbiAgICByZXR1cm4gZGlmZiA9PT0gdW5kZWZpbmVkID8gdW5kZWZpbmVkIDogW2RpZmZbMV0sIGRpZmZbMF1dO1xuICB9XG5cbiAgc3F1YXNoKGRpZmYxOiBEaWZmIHwgdW5kZWZpbmVkLCBkaWZmMjogRGlmZiB8IHVuZGVmaW5lZCk6IERpZmYgfCB1bmRlZmluZWQge1xuICAgIGlmIChkaWZmMSA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICByZXR1cm4gZGlmZjIgPT09IHVuZGVmaW5lZCA/IHVuZGVmaW5lZCA6IFtkaWZmMlswXSwgZGlmZjJbMV1dO1xuICAgIH0gZWxzZSBpZiAoZGlmZjIgPT09IHVuZGVmaW5lZCkge1xuICAgICAgcmV0dXJuIFtkaWZmMVswXSwgZGlmZjFbMV1dO1xuICAgIH1cbiAgICByZXR1cm4gZGlmZjFbMF0gPT09IGRpZmYyWzFdID8gdW5kZWZpbmVkIDogW2RpZmYxWzBdLCBkaWZmMlsxXV07XG4gIH1cblxuICBwcml2YXRlIF9hcHBseU9wdGlvbnMoKTogdm9pZCB7XG4gICAgaWYgKHRoaXMuX29wdGlvbnMgPT09IHVuZGVmaW5lZCkge1xuICAgICAgdGhyb3cgY3JlYXRlTGF6eU9wdGlvbnNFcnJvcih0aGlzKTtcbiAgICB9XG4gICAgY29uc3Qgb3B0aW9uczogQ29kZXBvaW50U3RyaW5nT3B0aW9ucyA9IHR5cGVvZiB0aGlzLl9vcHRpb25zID09PSBcImZ1bmN0aW9uXCIgPyB0aGlzLl9vcHRpb25zKCkgOiB0aGlzLl9vcHRpb25zO1xuXG4gICAgY29uc3Qgbm9ybWFsaXphdGlvbjogTm9ybWFsaXphdGlvbiA9IG9wdGlvbnMubm9ybWFsaXphdGlvbiAhPT0gdW5kZWZpbmVkID9cbiAgICAgIG9wdGlvbnMubm9ybWFsaXphdGlvbiA6XG4gICAgICBOb3JtYWxpemF0aW9uLk5mYztcbiAgICBjb25zdCBlbmZvcmNlVW5pY29kZVJlZ0V4cDogYm9vbGVhbiA9IG9wdGlvbnMuZW5mb3JjZVVuaWNvZGVSZWdFeHAgIT09IHVuZGVmaW5lZCA/XG4gICAgICBvcHRpb25zLmVuZm9yY2VVbmljb2RlUmVnRXhwIDpcbiAgICAgIHRydWU7XG4gICAgY29uc3QgcGF0dGVybjogUmVnRXhwIHwgdW5kZWZpbmVkID0gb3B0aW9ucy5wYXR0ZXJuO1xuICAgIGNvbnN0IGxvd2VyQ2FzZTogYm9vbGVhbiA9IG9wdGlvbnMubG93ZXJDYXNlICE9PSB1bmRlZmluZWQgPyBvcHRpb25zLmxvd2VyQ2FzZSA6IGZhbHNlO1xuICAgIGNvbnN0IHRyaW1tZWQ6IGJvb2xlYW4gPSBvcHRpb25zLnRyaW1tZWQgIT09IHVuZGVmaW5lZCA/IG9wdGlvbnMudHJpbW1lZCA6IGZhbHNlO1xuICAgIGNvbnN0IG1pbkNvZGVwb2ludHM6IG51bWJlciB8IHVuZGVmaW5lZCA9IG9wdGlvbnMubWluQ29kZXBvaW50cztcbiAgICBjb25zdCBtYXhDb2RlcG9pbnRzOiBudW1iZXIgPSBvcHRpb25zLm1heENvZGVwb2ludHM7XG4gICAgY29uc3QgdW5vcm06IFVub3JtTGlrZSB8IHVuZGVmaW5lZCA9IG9wdGlvbnMudW5vcm07XG5cbiAgICBPYmplY3QuYXNzaWduKFxuICAgICAgdGhpcyxcbiAgICAgIHtub3JtYWxpemF0aW9uLCBlbmZvcmNlVW5pY29kZVJlZ0V4cCwgcGF0dGVybiwgbG93ZXJDYXNlLCB0cmltbWVkLCBtaW5Db2RlcG9pbnRzLCBtYXhDb2RlcG9pbnRzLCB1bm9ybX0sXG4gICAgKTtcbiAgfVxufVxuIl0sInNvdXJjZVJvb3QiOiIuLi8uLiJ9
